<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>ã€ŠC++ Concurrency in Actionã€‹ç¬¬ä¸‰ç«  | Cialloï½(âˆ ãƒ»Ï‰&lt; )âŒ’â˜†               ccã®blog</title><meta name="author" content="cmz"><meta name="copyright" content="cmz"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="è¿™æœ¬ä¹¦ä¸»è¦è®²çš„æ˜¯c++å¤šçº¿ç¨‹ç¼–ç¨‹ç›¸å…³çš„å†…å®¹ï¼Œç¬¬ä¸‰ç« æ˜¯é”çš„ç››å®´ åœ¨å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹ï¼Œå…±äº«æ•°æ®çš„è¯»å†™æ˜¯ä¸ªå¤§é—®é¢˜ï¼Œå¾ˆå®¹æ˜“å‡ºç°aåœ¨è¯»æ—¶båœ¨å†™ï¼Œå¯¼è‡´é”™è¯¯ï¼Œå³æ¡ä»¶ç«äº‰ è€Œæœ€å¸¸è§çš„è§£å†³åŠæ³•å°±æ˜¯äº’æ–¥é‡ï¼ˆmutex) 123456std::mutexåªæ˜¯äº’æ–¥é‡ï¼Œæˆ‘ä»¬éœ€è¦åˆ©ç”¨è¿™ä¸ªäº’æ–¥é‡è§£å†³æ¡ä»¶ç«äº‰ï¼Œå°±éœ€è¦ç”¨é”mutexæœ¬èº«è‡ªå¸¦lockå’Œunlockä¸¤ä¸ªæˆå‘˜å‡½æ•°ï¼Œå¯ä»¥è¿›è¡Œä¸Šé”ä½†æ˜¯æ˜¾ç„¶è¿™å¾ˆéº»çƒ¦ï¼Œc++ç‰¹æ€§äº†å±äºæ˜¯ï¼Œå¾ˆå¯èƒ½å¿˜">
<meta property="og:type" content="article">
<meta property="og:title" content="ã€ŠC++ Concurrency in Actionã€‹ç¬¬ä¸‰ç« ">
<meta property="og:url" content="https://cmzcc.github.io/2025/10/29/%E3%80%8AC++-Concurrency-in-Action%E3%80%8B%E7%AC%AC%E4%B8%89%E7%AB%A0/index.html">
<meta property="og:site_name" content="Cialloï½(âˆ ãƒ»Ï‰&lt; )âŒ’â˜†               ccã®blog">
<meta property="og:description" content="è¿™æœ¬ä¹¦ä¸»è¦è®²çš„æ˜¯c++å¤šçº¿ç¨‹ç¼–ç¨‹ç›¸å…³çš„å†…å®¹ï¼Œç¬¬ä¸‰ç« æ˜¯é”çš„ç››å®´ åœ¨å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹ï¼Œå…±äº«æ•°æ®çš„è¯»å†™æ˜¯ä¸ªå¤§é—®é¢˜ï¼Œå¾ˆå®¹æ˜“å‡ºç°aåœ¨è¯»æ—¶båœ¨å†™ï¼Œå¯¼è‡´é”™è¯¯ï¼Œå³æ¡ä»¶ç«äº‰ è€Œæœ€å¸¸è§çš„è§£å†³åŠæ³•å°±æ˜¯äº’æ–¥é‡ï¼ˆmutex) 123456std::mutexåªæ˜¯äº’æ–¥é‡ï¼Œæˆ‘ä»¬éœ€è¦åˆ©ç”¨è¿™ä¸ªäº’æ–¥é‡è§£å†³æ¡ä»¶ç«äº‰ï¼Œå°±éœ€è¦ç”¨é”mutexæœ¬èº«è‡ªå¸¦lockå’Œunlockä¸¤ä¸ªæˆå‘˜å‡½æ•°ï¼Œå¯ä»¥è¿›è¡Œä¸Šé”ä½†æ˜¯æ˜¾ç„¶è¿™å¾ˆéº»çƒ¦ï¼Œc++ç‰¹æ€§äº†å±äºæ˜¯ï¼Œå¾ˆå¯èƒ½å¿˜">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cmzcc.github.io/img/text-cover3.jpg">
<meta property="article:published_time" content="2025-10-29T13:27:33.000Z">
<meta property="article:modified_time" content="2025-11-08T16:25:37.323Z">
<meta property="article:author" content="cmz">
<meta property="article:tag" content="c++">
<meta property="article:tag" content="å¤šçº¿ç¨‹">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cmzcc.github.io/img/text-cover3.jpg"><link rel="shortcut icon" href="/img/logo.png"><link rel="canonical" href="https://cmzcc.github.io/2025/10/29/%E3%80%8AC++-Concurrency-in-Action%E3%80%8B%E7%AC%AC%E4%B8%89%E7%AB%A0/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        if (name && globalFn[key][name]) return
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"No results found for: ${query}","hits_stats":"${hits} articles found"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'ã€ŠC++ Concurrency in Actionã€‹ç¬¬ä¸‰ç« ',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-11-09 00:25:37'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">Loading...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load', preloader.endLoading)

  if (false) {
    btf.addGlobalFn('pjaxSend', preloader.initLoading, 'preloader_init')
    btf.addGlobalFn('pjaxComplete', preloader.endLoading, 'preloader_end')
  }
})()</script><div id="web_bg" style="background-image: url(/img/background.jpg);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/personal-icon.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">109</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">112</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">8</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/text-cover3.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="/img/logo.png" alt="Logo"><span class="site-name">Cialloï½(âˆ ãƒ»Ï‰&lt; )âŒ’â˜†               ccã®blog</span></a><a class="nav-page-title" href="/"><span class="site-name">ã€ŠC++ Concurrency in Actionã€‹ç¬¬ä¸‰ç« </span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">ã€ŠC++ Concurrency in Actionã€‹ç¬¬ä¸‰ç« </h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2025-10-29T13:27:33.000Z" title="Created 2025-10-29 21:27:33">2025-10-29</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2025-11-08T16:25:37.323Z" title="Updated 2025-11-09 00:25:37">2025-11-09</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">è¯»ä¹¦ç¬”è®°</a></span></div><div class="meta-secondline"></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>è¿™æœ¬ä¹¦ä¸»è¦è®²çš„æ˜¯c++å¤šçº¿ç¨‹ç¼–ç¨‹ç›¸å…³çš„å†…å®¹ï¼Œç¬¬ä¸‰ç« æ˜¯é”çš„ç››å®´</p>
<p>åœ¨å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹ï¼Œå…±äº«æ•°æ®çš„è¯»å†™æ˜¯ä¸ªå¤§é—®é¢˜ï¼Œå¾ˆå®¹æ˜“å‡ºç°aåœ¨è¯»æ—¶båœ¨å†™ï¼Œå¯¼è‡´é”™è¯¯ï¼Œå³æ¡ä»¶ç«äº‰</p>
<p>è€Œæœ€å¸¸è§çš„è§£å†³åŠæ³•å°±æ˜¯äº’æ–¥é‡ï¼ˆmutex)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">std::mutexåªæ˜¯äº’æ–¥é‡ï¼Œæˆ‘ä»¬éœ€è¦åˆ©ç”¨è¿™ä¸ªäº’æ–¥é‡è§£å†³æ¡ä»¶ç«äº‰ï¼Œå°±éœ€è¦ç”¨é”</span><br><span class="line">mutexæœ¬èº«è‡ªå¸¦lockå’Œunlockä¸¤ä¸ªæˆå‘˜å‡½æ•°ï¼Œå¯ä»¥è¿›è¡Œä¸Šé”</span><br><span class="line">ä½†æ˜¯æ˜¾ç„¶è¿™å¾ˆéº»çƒ¦ï¼Œc++ç‰¹æ€§äº†å±äºæ˜¯ï¼Œå¾ˆå¯èƒ½å¿˜è®°è§£é”</span><br><span class="line">é‚£ä¹ˆRAIIå°±ç™»åœºäº†ï¼Œstd::lock_guard&lt;std::mutex&gt;guard(mutex)æ˜¯æœ€å¸¸è§çš„äº’æ–¥é”ä½¿ç”¨æ–¹æ³•</span><br><span class="line">ä½†æ˜¯åœ¨c++17ä¸­ï¼Œå¼•å…¥äº†æ¨¡æ¿ç±»å‚æ•°æ¨å¯¼çš„ç‰¹æ€§ï¼Œå…è®¸åœ¨å®šä¹‰std::mutexä¹‹å</span><br><span class="line">ç›´æ¥ä½¿ç”¨std::lock_guard guard(mutex)å³å¯ä¸Šé”ï¼Œè¶Šå‡ºä½œç”¨åŸŸä¹‹åè‡ªåŠ¨é‡Šæ”¾ã€‚</span><br></pre></td></tr></table></figure>

<p>åœ¨æœ‰ä¸æ­¢ä¸€ä¸ªé”çš„æ—¶å€™ï¼Œæ­£å¸¸æˆ‘ä»¬æ˜¯å…ˆåŠ aé”ï¼Œç„¶ååŠ bé”ï¼Œä½†æ˜¯å› ä¸ºæœ‰å…ˆåé¡ºåºï¼Œé‚£ä¹ˆåœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹ï¼Œaé”åŠ ä¸Šåï¼Œå¦‚æœbé”è¢«å¦ä¸€ä¸ªç¨‹åºæŠ¢èµ°ï¼Œä¸”å¦ä¸€ä¸ªç¨‹åºè¯•å›¾åŠ bé”ï¼Œå°±ä¼šå‡ºç°æœ€ç»å…¸çš„æ­»é”æƒ…å†µ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">std::unique_lock lock(mutex,std::defer_lock);</span><br><span class="line">å»¶è¿Ÿé”æœ¬è´¨ä¸Šå¹¶æ²¡æœ‰çœŸæ­£çš„ä¸Šé”ï¼Œåªæ˜¯è·å–äº†ä¸€ä¸ªæŒ‡å‘é”çš„æŒ‡é’ˆ</span><br><span class="line">template &lt;class Mutex&gt;</span><br><span class="line">unique_lock&lt;Mutex&gt;::unique_lock(Mutex&amp; mtx, std::defer_lock_t) noexcept</span><br><span class="line">    : _M_device(&amp;mtx), _M_owns(false)</span><br><span class="line">&#123;</span><br><span class="line">    // æ³¨æ„ï¼Œè¿™é‡Œæ²¡æœ‰è°ƒç”¨ mtx.lock()</span><br><span class="line">    // åªæ˜¯è®°å½•ä¸‹æŒ‡é’ˆï¼Œå¹¶æ ‡è®°ä¸ºâ€œæœªåŠ é”â€</span><br><span class="line">&#125;</span><br><span class="line">æ‰€ä»¥å½“æˆ‘ä»¬å¯¹é”åˆå§‹åŒ–å®Œæ¯•å</span><br><span class="line">std::lock(m1,m2);//å°±å¯ä»¥ä¸€æ¬¡æ€§å¯¹ä¸¤ä¸ªé”è¿›è¡ŒåŠ é”ï¼Œæ²¡æœ‰å…ˆåé¡ºåº</span><br><span class="line"></span><br><span class="line">é™¤äº†å»¶è¿Ÿé”ï¼Œc++17ä¸­ä¹Ÿå¼•å…¥äº†ä¸€ä¸ªä¸“é—¨ç”¨äºä¸€æ¬¡æ€§åŠ å¤šä¸ªé”çš„std::scoped_lock guard()</span><br><span class="line">std::mutex m1, m2;</span><br><span class="line">std::scoped_lock lock(m1, m2); // è‡ªåŠ¨é¿å…æ­»é”</span><br></pre></td></tr></table></figure>

<p>é™¤äº†æˆ‘ä»¬å¸¸è§çš„æ•°æ®çš„æ¡ä»¶ç«äº‰ï¼Œè¿˜æœ‰ä¸€ç§æƒ…å†µå°±æ˜¯æ¥å£çš„ç«äº‰</p>
<p>ä¹¦ä¸­ä¸¾äº†stackçš„ä¾‹å­ï¼Œæ¯”å¦‚æˆ‘ä»¬ä½¿ç”¨empty()æ¥ç¡®è®¤stackæ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœéç©ºï¼Œæˆ‘ä»¬è°ƒç”¨popï¼ˆï¼‰,ä½†åœ¨è¿™ä¸¤æ­¥ä¹‹é—´ï¼Œå› ä¸ºä¸æ˜¯åŸå­æ“ä½œï¼Œæ‰€ä»¥æœ‰å¯èƒ½å¤–éƒ¨ä¼šæœ‰çº¿ç¨‹ä¿®æ”¹æ ˆï¼Œå¯¼è‡´åœ¨æ ˆç©ºçš„æƒ…å†µä¸‹popï¼Œå‘ç”Ÿæœªå®šä¹‰è¡Œä¸ºã€‚</p>
<p>è¿™æ˜¯ä¸€ä¸ªç»å…¸çš„æ¡ä»¶ç«äº‰ï¼Œä½¿ç”¨äº’æ–¥é‡å¯¹stackå†…éƒ¨çš„æ•°æ®è¿›è¡Œä¿æŠ¤ï¼Œä¾ç„¶ä¸èƒ½é˜»æ­¢æ¡ä»¶ç«äº‰çš„å‘ç”Ÿï¼Œè¿™æ˜¯æ¥å£å›ºæœ‰çš„é—®é¢˜ã€‚</p>
<p>å¦‚ä½•è§£å†³ï¼Ÿä¿®æ”¹æ¥å£ã€‚æ¯”å¦‚åœ¨topæˆ–è€…popæ—¶ï¼Œå¦‚æœæ ˆæ˜¯ç©ºï¼Œå°±çˆ†å‡ºå¼‚å¸¸ï¼Œä½†è¿™æ ·çš„è¯ï¼Œempty()å°±æˆäº†æ— ç”¨çš„æ¥å£</p>
<p>æ‰€ä»¥å®é™…æ˜¯æ€æ ·è§£å†³çš„å‘¢ï¼Ÿc++æ ‡å‡†åº“çš„è®¾è®¡å¸ˆé€‰æ‹©çš„æ˜¯ï¼š<strong>æ‘†çƒ‚</strong></p>
<p>æ˜¯çš„ï¼Œæ‘†çƒ‚ï¼Œc++çš„è®¾è®¡å“²å­¦æ˜¯ï¼šä¸ä¸ºæˆ‘ç”¨ä¸åˆ°çš„ä¸œè¥¿ä»˜è´¹</p>
<p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åº”è¯¥å¯¹æ ˆå†ä½¿ç”¨ä¸€ä¸ªäº’æ–¥é”ï¼Œä½†æ˜¯æˆ‘ä»¬è¦è€ƒè™‘åˆ°ï¼Œç›¸å½“ä¸€éƒ¨åˆ†çš„ä½¿ç”¨åœºæ™¯æ˜¯å•çº¿ç¨‹ï¼Œè€Œå•çº¿ç¨‹ï¼Œæ ¹æœ¬ä¸ä¼šæœ‰è¿™æ ·çš„é—®é¢˜ï¼Œè€Œå†…éƒ¨åŠ é”æ¯«æ— ç–‘é—®ä¼šé€ æˆæ²¡æœ‰æ„ä¹‰çš„æ€§èƒ½æŸè€—ã€‚é‚£ä¹ˆï¼Œç¨‹åºå‘˜å°±å¯ä»¥è‡ªç”±é€‰æ‹©ï¼šåŠ é”ä»¥ä¿è¯å®‰å…¨orä¸åŠ é”ä¸ï¼ˆéœ€ï¼‰è¦å®‰å…¨ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">template&lt;typename T&gt;</span><br><span class="line">class threadsafe_stack &#123;</span><br><span class="line">private:</span><br><span class="line">    std::stack&lt;T&gt; data;</span><br><span class="line">    mutable std::mutex m;</span><br><span class="line">    std::condition_variable cond;</span><br><span class="line">    </span><br><span class="line">public:</span><br><span class="line">    threadsafe_stack() = default;</span><br><span class="line">    </span><br><span class="line">    // ç¦æ­¢æ‹·è´ï¼ˆäº’æ–¥é‡ä¸èƒ½æ‹·è´ï¼‰</span><br><span class="line">    threadsafe_stack(const threadsafe_stack&amp;) = delete;</span><br><span class="line">    threadsafe_stack&amp; operator=(const threadsafe_stack&amp;) = delete;</span><br><span class="line">    </span><br><span class="line">    void push(T new_value) &#123;</span><br><span class="line">        std::lock_guard&lt;std::mutex&gt; lock(m);</span><br><span class="line">        data.push(std::move(new_value));</span><br><span class="line">        cond.notify_one();  // é€šçŸ¥ç­‰å¾…çš„æ¶ˆè´¹è€…</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // å°è¯•å¼¹å‡º - éé˜»å¡</span><br><span class="line">    bool try_pop(T&amp; value) &#123;</span><br><span class="line">        std::lock_guard&lt;std::mutex&gt; lock(m);</span><br><span class="line">        if(data.empty()) return false;</span><br><span class="line">        </span><br><span class="line">        value = std::move(data.top());</span><br><span class="line">        data.pop();</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    std::shared_ptr&lt;T&gt; try_pop() &#123;</span><br><span class="line">        std::lock_guard&lt;std::mutex&gt; lock(m);</span><br><span class="line">        if(data.empty()) return std::shared_ptr&lt;T&gt;();</span><br><span class="line">        </span><br><span class="line">        auto res = std::make_shared&lt;T&gt;(std::move(data.top()));</span><br><span class="line">        data.pop();</span><br><span class="line">        return res;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // ç­‰å¾…å¼¹å‡º - é˜»å¡ç›´åˆ°æœ‰å…ƒç´ </span><br><span class="line">    void wait_and_pop(T&amp; value) &#123;</span><br><span class="line">        std::unique_lock&lt;std::mutex&gt; lock(m);</span><br><span class="line">        cond.wait(lock, [this]&#123; return !data.empty(); &#125;);</span><br><span class="line">        </span><br><span class="line">        value = std::move(data.top());</span><br><span class="line">        data.pop();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    std::shared_ptr&lt;T&gt; wait_and_pop() &#123;</span><br><span class="line">        std::unique_lock&lt;std::mutex&gt; lock(m);</span><br><span class="line">        cond.wait(lock, [this]&#123; return !data.empty(); &#125;);</span><br><span class="line">        </span><br><span class="line">        auto res = std::make_shared&lt;T&gt;(std::move(data.top()));</span><br><span class="line">        data.pop();</span><br><span class="line">        return res;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    bool empty() const &#123;</span><br><span class="line">        std::lock_guard&lt;std::mutex&gt; lock(m);</span><br><span class="line">        return data.empty();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ä¼—æ‰€å‘¨çŸ¥ï¼Œstd::stackçš„è®¾è®¡æœ‰äº›å¥‡æ€ªï¼Œ<br>å› ä¸ºtop()å’Œpop()æ˜¯ä¸¤ä¸ªæ¥å£ï¼ŒæŒ‰ç…§æ­£å¸¸çš„é€»è¾‘ï¼Œæˆ‘ä»¬åº”è¯¥è®©topå’Œpopåˆå¹¶ï¼Œå³popç„¶åè¿”å›å€¼ã€‚</p>
<p>é‚£ä¸ºä»€ä¹ˆä¸è¿™æ ·åšå‘¢ï¼Ÿæ¯•ç«Ÿåˆ†å¼€æ¯«æ— ç–‘é—®ä¼šå‡ºç°åˆšæ‰çš„æ¥å£ç«äº‰é—®é¢˜ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">å‡è®¾ stack&lt;vector&lt;int&gt;&gt; ä¸­ vector å…ƒç´ å¾ˆå¤šï¼Œæ‹·è´å®ƒå¯èƒ½å› å†…å­˜ä¸è¶³æŠ›å‡º std::bad_alloc å¼‚å¸¸ã€‚</span><br><span class="line"></span><br><span class="line">å¦‚æœ pop() åŒæ—¶å®Œæˆè¿”å›å€¼å’Œç§»é™¤æ“ä½œï¼š</span><br><span class="line">æ•°æ®å·²ä»æ ˆä¸­ç§»é™¤ã€‚</span><br><span class="line">ä½†æ‹·è´è¿”å›å€¼æ—¶æŠ›å‡ºå¼‚å¸¸ â†’ æ•°æ®ä¸¢å¤±ã€‚</span><br><span class="line"></span><br><span class="line">è¿™æ˜¯å‡è®¾æ˜¯åŸå­æ“ä½œçš„æƒ…å†µï¼Œä½†å°±ä¼šå‡ºç°ä»¥ä¸Šé—®é¢˜ï¼Œå¦‚æœæˆ‘ä»¬é€€è€Œæ±‚å…¶æ¬¡ï¼Œä¸è¦åŸå­æ“ä½œäº†ï¼Œè€Œæ˜¯åœ¨å†…éƒ¨å®ç°ï¼Œæ‹·è´å¤±è´¥å°±æ”¾å¼ƒç§»é™¤ã€‚å¯è¿™æ ·çš„è¯ï¼Œéœ€è¦å†…éƒ¨åŠ é”ï¼Œè€Œå®é™…ä¸Šå’Œtopï¼Œpopåˆ†å¼€æ˜¯ä¸€æ ·çš„ï¼ˆéƒ½æ˜¯éåŸå­çš„ï¼‰ã€‚</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥æˆ‘ä»¬åªèƒ½è‡ªå·±å®ç°çº¿ç¨‹å®‰å…¨çš„æ ˆï¼ˆc++çš„é­…åŠ›æ‰€åœ¨ï¼šå¤§å®¶ä¸€èµ·é€ è½®å­ï¼ï¼‰</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">template&lt;typename T&gt;</span><br><span class="line">class threadsafe_stack &#123;</span><br><span class="line">private:</span><br><span class="line">    std::stack&lt;T&gt; data;</span><br><span class="line">    mutable std::mutex m;</span><br><span class="line">    </span><br><span class="line">public:</span><br><span class="line">    // ä¸»è¦æ¥å£ - è¿”å›æ™ºèƒ½æŒ‡é’ˆ</span><br><span class="line">    std::shared_ptr&lt;T&gt; pop() &#123;</span><br><span class="line">        std::lock_guard&lt;std::mutex&gt; lock(m);</span><br><span class="line">        if(data.empty()) throw empty_stack();</span><br><span class="line">        </span><br><span class="line">        auto res = std::make_shared&lt;T&gt;(std::move(data.top()));</span><br><span class="line">        data.pop();</span><br><span class="line">        return res;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // å¤‡é€‰æ¥å£ - é€šè¿‡å‚æ•°è¿”å›</span><br><span class="line">    void pop(T&amp; value) &#123;</span><br><span class="line">        std::lock_guard&lt;std::mutex&gt; lock(m);</span><br><span class="line">        if(data.empty()) throw empty_stack();</span><br><span class="line">        </span><br><span class="line">        value = std::move(data.top());</span><br><span class="line">        data.pop();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // ä¸æŠ›å¼‚å¸¸ç‰ˆæœ¬</span><br><span class="line">    bool try_pop(T&amp; value) noexcept &#123;</span><br><span class="line">        std::lock_guard&lt;std::mutex&gt; lock(m);</span><br><span class="line">        if(data.empty()) return false;</span><br><span class="line">        </span><br><span class="line">        value = std::move(data.top());</span><br><span class="line">        data.pop();</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    void push(T new_value) &#123;</span><br><span class="line">        auto new_data = std::make_shared&lt;T&gt;(std::move(new_value));</span><br><span class="line">        std::lock_guard&lt;std::mutex&gt; lock(m);</span><br><span class="line">        data.push(std::move(*new_data));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    bool empty() const &#123;</span><br><span class="line">        std::lock_guard&lt;std::mutex&gt; lock(m);</span><br><span class="line">        return data.empty();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>è¿™å°±æ˜¯ä»¥ä¸Šå‡ ç§è§£å†³æ–¹æ³•ï¼š</p>
<p>ä¼ å…¥ä¸€ä¸ªå¼•ç”¨ï¼Œè·å–ä¼ å‡ºå€¼ã€‚ï¼ˆå¤§å¤šæ•°æƒ…å†µä¸‹ä¸åˆ’ç®—ï¼Œè€Œä¸”æ•°æ®ä¸ä¸€å®šæ˜¯å¯èµ‹å€¼çš„æ•°æ®ç±»å‹ï¼‰</p>
<p>ä½¿ç”¨æ— å¼‚å¸¸çš„æ‹·è´æˆ–è€…ç§»åŠ¨æ„é€ å‡½æ•°ï¼ˆæ— å¼‚å¸¸å¤ªéº»çƒ¦ï¼Œç§»åŠ¨æ„é€ ä¸ä¸€å®šéƒ½æ”¯æŒï¼‰ï¼Œå®ç°çš„æ˜¯tryçš„ç‰ˆæœ¬ï¼Œc++17ä»¥ä¸Šå¯ä»¥ç”¨optionalä»£æ›¿boolè¿”å›å€¼</p>
<p>è¿”å›å¼¹å‡ºå€¼çš„æŒ‡é’ˆï¼ˆä¸€èˆ¬ç”¨shared_ptr,æœ€ç†æƒ³çš„æ–¹æ³•ä¹‹ä¸€ï¼Œåå¤„æ˜¯å¯¹å°å¯¹è±¡é€ æˆé¢å¤–çš„å†…å­˜ç®¡ç†çš„å¼€é”€ï¼Œæ‰€ä»¥c++æ ‡å‡†åº“ä¸é‡‡ç”¨ï¼Œè€Œå¯¹å¤§å¯¹è±¡å¾ˆé€‚åˆ)</p>
<p>ä¸»æ’­åœ¨è¿™é‡Œå¿½ç„¶æƒ³åˆ°äº†å•ä¾‹æ¨¡å¼ï¼Œå•ä¾‹æ¨¡å¼çš„åˆå§‹åŒ–ä¹Ÿå‡ºç°äº†ä¸Šé¢emptyå’Œtop&#x2F;popçš„é—®é¢˜ï¼Œæ‰€ä»¥ä½¿ç”¨äº†åŒé‡æ£€æŸ¥ï¼Œä½†æ¯«æ— ç–‘é—®è¿™ç§æ–¹æ³•æœ‰å·¨å¤§çš„ç¼ºé™·ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">1. æ½œåœ¨çš„æ•°æ®ç«äº‰é—®é¢˜ï¼š</span><br><span class="line">é—®é¢˜ï¼šåˆå§‹åŒ–é¡ºåºé—®é¢˜ï¼ˆMemory Reorderingï¼‰</span><br><span class="line">åœ¨ç°ä»£å¤šæ ¸å¤„ç†å™¨ä¸­ï¼Œç¼–è¯‘å™¨å’Œ CPU å¯èƒ½ä¼šå¯¹æŒ‡ä»¤è¿›è¡Œä¼˜åŒ–ï¼Œé‡æ–°æ’åºï¼ˆreorderingï¼‰æ‰§è¡Œï¼Œå¯¼è‡´çº¿ç¨‹è¯»å–åˆ°æœªå®Œå…¨åˆå§‹åŒ–çš„å¯¹è±¡ã€‚è¿™å°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„ æ•°æ®ç«äº‰ï¼Œå®ƒæ˜¯ç”±äºå†…å­˜æ¨¡å‹å¯¼è‡´çš„ã€‚</span><br><span class="line"></span><br><span class="line">å…·ä½“é—®é¢˜åœ¨äºï¼Œå½“ instance = new Singleton(); è¢«æ‰§è¡Œæ—¶ï¼Œåˆ†é…å†…å­˜å’Œåˆå§‹åŒ–æ„é€ å‡½æ•°æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„æ­¥éª¤ï¼Œè€Œ CPU æˆ–ç¼–è¯‘å™¨å¯èƒ½ä¼šé‡æ’åºå®ƒä»¬ï¼Œä½¿å¾—å…¶ä»–çº¿ç¨‹èƒ½åœ¨å®ä¾‹å®Œæˆåˆå§‹åŒ–ä¹‹å‰å°±è¯»å–åˆ°éƒ¨åˆ†åˆå§‹åŒ–çš„å¯¹è±¡ã€‚</span><br><span class="line"></span><br><span class="line">å…·ä½“è€Œè¨€ï¼Œå¯èƒ½çš„æ‰§è¡Œé¡ºåºå¦‚ä¸‹ï¼š</span><br><span class="line"></span><br><span class="line">çº¿ç¨‹ A æ‰§è¡Œåˆ° instance = new Singleton(); æ—¶ï¼Œé¦–å…ˆåˆ†é…äº†å†…å­˜ï¼Œä½†æ²¡æœ‰åˆå§‹åŒ–æ•°æ®ï¼Œå¯èƒ½ä¼šä¿®æ”¹å¯¹è±¡æŒ‡é’ˆã€‚</span><br><span class="line">çº¿ç¨‹ B è¿›å…¥ç¬¬ä¸€æ¬¡æ£€æŸ¥ï¼Œå‘ç° instance != nullptrï¼Œå› æ­¤è¿”å›è¯¥å®ä¾‹ã€‚</span><br><span class="line">çº¿ç¨‹ B ä½¿ç”¨çš„ instance æŒ‡å‘çš„å¯èƒ½æ˜¯ä¸€ä¸ªæœªå®Œå…¨åˆå§‹åŒ–çš„å¯¹è±¡ï¼Œå¯¼è‡´é”™è¯¯è¡Œä¸ºã€‚</span><br><span class="line">2. å†…å­˜æ¨¡å‹é—®é¢˜ï¼š</span><br><span class="line">C++ ä¸­çš„å†…å­˜æ¨¡å‹å…è®¸ç¼–è¯‘å™¨å’Œ CPU å¯¹ä»£ç è¿›è¡Œé‡æ’åºã€‚ç‰¹åˆ«æ˜¯ï¼Œå¯¹äºæŒ‡é’ˆç±»å‹çš„æˆå‘˜ï¼ˆå¦‚ Singleton* instanceï¼‰ï¼Œåœ¨æ²¡æœ‰é€‚å½“çš„åŒæ­¥æœºåˆ¶æ—¶ï¼Œåˆ†é…å†…å­˜å’Œåˆå§‹åŒ–å¯¹è±¡çš„æ“ä½œå¯èƒ½è¢«é‡æ’åºã€‚</span><br><span class="line"></span><br><span class="line">ä¾‹å¦‚ï¼Œåœ¨ instance = new Singleton(); è¯­å¥ä¸­ï¼Œå†…å­˜åˆ†é…å’Œå¯¹è±¡æ„é€ å¯èƒ½è¢«é‡æ’åºã€‚è¿™ä¸ªé—®é¢˜å°¤å…¶åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­åŠ å‰§ï¼Œå¯¼è‡´ä¸åŒçº¿ç¨‹çœ‹åˆ°çš„çŠ¶æ€ä¸ä¸€è‡´ã€‚</span><br></pre></td></tr></table></figure>

<p>å†…å­˜é‡æ’çš„å‰¯ä½œç”¨è¿˜æ˜¯æœ‰å¤ªå¤šäº†ï¼ˆæ‚è„¸ï¼‰</p>
<p>std::once_flagå’Œstd::call_onceå°±æ˜¯c++æ ‡å‡†å§”å‘˜ä¼šé‚£å¸®è€å¤´è§£å†³çš„æ–¹æ³•</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">std::call_once ä¸ std::once_flag æ˜¯ä»€ä¹ˆ</span><br><span class="line">#include &lt;mutex&gt;</span><br><span class="line"></span><br><span class="line">std::once_flag flag;</span><br><span class="line"></span><br><span class="line">void init() &#123;</span><br><span class="line">    // åªä¼šè¢«æ‰§è¡Œä¸€æ¬¡</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void worker() &#123;</span><br><span class="line">    std::call_once(flag, init);  // ä¿è¯ init() åªæ‰§è¡Œä¸€æ¬¡</span><br><span class="line">&#125;</span><br><span class="line">std::once_flag æ˜¯ä¸€ä¸ªçŠ¶æ€æ ‡å¿—ï¼Œè¡¨ç¤ºæŸä¸ªå‡½æ•°æ˜¯å¦å·²ç»è¢«è°ƒç”¨ã€‚</span><br><span class="line">std::call_once(flag, func) ä¼šåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ä¿è¯ï¼š</span><br><span class="line">func() åªä¼šè¢«è°ƒç”¨ä¸€æ¬¡ï¼›</span><br><span class="line">å…¶ä»–çº¿ç¨‹åœ¨æ­¤æœŸé—´ä¼šç­‰å¾…ï¼Œç›´åˆ°è¯¥è°ƒç”¨å®Œæˆï¼›</span><br><span class="line">å³ä½¿æœ‰å¼‚å¸¸æŠ›å‡ºï¼Œä¹Ÿèƒ½ç¡®ä¿ä¸€è‡´æ€§ã€‚</span><br></pre></td></tr></table></figure>

<p>once_flagæœ¬è´¨æ˜¯ä¸€ä¸ªæ ‡å¿—å’Œé”ï¼Œcall_onceæœ¬è´¨æ˜¯ç”¨atomicå’Œå†…å­˜åºå®ç°çš„åŒé‡æ£€æµ‹ï¼Œè§£å†³äº†reorderingçš„é—®é¢˜ï¼Œåªèƒ½è¯´å¤ªä¸ä¼˜é›…äº†ã€‚</p>
<p>æ‰€ä»¥å¤§ä½¬ç›¸å‡ºäº†æ–¹æ³•ï¼š<strong>Meyersâ€™ Singleton</strong></p>
<h3 id="Meyersâ€™-Singletonï¼ˆé™æ€å±€éƒ¨å˜é‡ï¼‰"><a href="#Meyersâ€™-Singletonï¼ˆé™æ€å±€éƒ¨å˜é‡ï¼‰" class="headerlink" title="Meyersâ€™ Singletonï¼ˆé™æ€å±€éƒ¨å˜é‡ï¼‰"></a><strong>Meyersâ€™ Singletonï¼ˆé™æ€å±€éƒ¨å˜é‡ï¼‰</strong></h3><p><strong>Meyersâ€™ Singleton</strong> æ˜¯ Scott Meyers æå‡ºçš„çº¿ç¨‹å®‰å…¨çš„å•ä¾‹æ¨¡å¼å®ç°æ–¹æ³•ã€‚å…¶æ ¸å¿ƒæ€æƒ³æ˜¯åˆ©ç”¨ C++ ä¸­çš„ <strong>é™æ€å±€éƒ¨å˜é‡åˆå§‹åŒ–</strong>ï¼ˆå³é™æ€åˆå§‹åŒ–åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶æ‰§è¡Œï¼‰ï¼Œé…åˆ <strong>C++11 æ ‡å‡†çš„çº¿ç¨‹å®‰å…¨æœºåˆ¶</strong>ï¼Œæ¥ç¡®ä¿å•ä¾‹å¯¹è±¡åªä¼šè¢«åˆ›å»ºä¸€æ¬¡ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Singleton</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">static</span> Singleton&amp; <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="type">static</span> Singleton instance;  <span class="comment">// é™æ€å±€éƒ¨å˜é‡</span></span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">Singleton</span>() &#123;&#125;  <span class="comment">// æ„é€ å‡½æ•°ç§æœ‰åŒ–</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>Meyersâ€™ Singletonï¼š</strong></p>
<ul>
<li>è¿™ç§å®ç°æ–¹å¼åˆ©ç”¨é™æ€å±€éƒ¨å˜é‡ï¼ŒC++11 ä¿è¯é™æ€å±€éƒ¨å˜é‡çš„åˆå§‹åŒ–æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚è€Œä¸”ï¼Œ<strong>é™æ€å±€éƒ¨å˜é‡</strong>åœ¨æ„é€ æ—¶ï¼Œåªæœ‰ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶æ‰ä¼šåˆ›å»ºå¯¹è±¡ï¼Œå› æ­¤å®ƒä¹Ÿèƒ½å¤„ç†å¼‚å¸¸å®‰å…¨é—®é¢˜ï¼šå¦‚æœç¬¬ä¸€æ¬¡åˆ›å»ºæ—¶æŠ›å‡ºå¼‚å¸¸ï¼Œä¸‹æ¬¡è°ƒç”¨ä¼šé‡æ–°æ‰§è¡Œåˆå§‹åŒ–ï¼ˆä¸è¿‡é€šå¸¸æƒ…å†µä¸‹ï¼Œé™æ€å±€éƒ¨å˜é‡ä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼‰ã€‚</li>
</ul>
<p>è¿™ç§å¼€é”€è¿˜å°ï¼Œæ€§èƒ½é«˜ï¼Œå¤§å®¶ä»¥åé€‰æ‹©è¿™ç§ã€‚</p>
<p>å¦å¤–ï¼Œå¯¹äºémutexçš„é”ï¼Œå¦‚lock_guardè¿™ç§ï¼Œæ˜¯åªèƒ½åŠ é”è§£é”ä¸€æ¬¡çš„ï¼Œä½†æ˜¯unique_lockï¼Œä½œä¸ºå”¯ä¸€å¯ä»¥ç”¨moveè½¬ç§»æ‰€æœ‰æƒçš„é”ï¼Œåœ¨è½¬ç§»çš„è¿‡ç¨‹ä¸­ï¼Œæœ¬è´¨å°±æ˜¯è§£äº†é”åˆé‡æ–°åŠ </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">std::mutex mtx;</span><br><span class="line">std::unique_lock&lt;std::mutex&gt; lock_a(mtx);   // çº¿ç¨‹ A è·å–é”</span><br><span class="line">std::unique_lock&lt;std::mutex&gt; lock_b = std::move(lock_a);  // è½¬ç§»é”çš„æ‰€æœ‰æƒ</span><br></pre></td></tr></table></figure>



<p>ä¸‹é¢ä»‹ç»å‡ ç§å…¶ä»–çš„é”ï¼ˆaiå†™çš„ï¼Œæ‡’å¾—æ‰“äº†ï¼‰</p>
<p>â€œè¯»å†™é”â€ï¼ˆ<strong>Readâ€“Write Lock</strong> æˆ– <strong>shared_mutex</strong>ï¼‰æ˜¯å¤šçº¿ç¨‹åŒæ­¥ä¸­ä¸€ä¸ªéå¸¸æ ¸å¿ƒçš„æ¦‚å¿µï¼Œ<br>å®ƒç›¸æ¯”æ™®é€šçš„äº’æ–¥é”ï¼ˆ<code>std::mutex</code>ï¼‰æ›´é«˜æ•ˆï¼Œå°¤å…¶åœ¨ <strong>â€œè¯»å¤šå†™å°‘â€</strong> çš„åœºæ™¯ä¸‹ã€‚  </p>
<p>ä¸‹é¢æˆ‘ä¼šä»åº•å±‚åŸç†åˆ°å®ç°ç»†èŠ‚ï¼Œç³»ç»Ÿåœ°è®²æ¸…æ¥šå®ƒçš„å·¥ä½œæœºåˆ¶ã€‚</p>
<hr>
<h2 id="ğŸ§©-ä¸€ã€ä¸ºä»€ä¹ˆéœ€è¦è¯»å†™é”ï¼Ÿ"><a href="#ğŸ§©-ä¸€ã€ä¸ºä»€ä¹ˆéœ€è¦è¯»å†™é”ï¼Ÿ" class="headerlink" title="ğŸ§© ä¸€ã€ä¸ºä»€ä¹ˆéœ€è¦è¯»å†™é”ï¼Ÿ"></a>ğŸ§© ä¸€ã€ä¸ºä»€ä¹ˆéœ€è¦è¯»å†™é”ï¼Ÿ</h2><p>æ™®é€šçš„äº’æ–¥é”ï¼ˆ<code>std::mutex</code>ï¼‰åªå…è®¸ï¼š</p>
<ul>
<li><strong>ä¸€ä¸ªçº¿ç¨‹è®¿é—®å…±äº«èµ„æº</strong>ã€‚</li>
</ul>
<p>å³ä½¿æ˜¯å¤šä¸ªçº¿ç¨‹â€œåªè¯»â€èµ„æºï¼Œä¹Ÿè¦æ’é˜Ÿï¼Œé€ æˆæ€§èƒ½æµªè´¹ã€‚</p>
<p>è€Œâ€œè¯»å†™é”â€è§£å†³çš„å°±æ˜¯è¿™ä¸ªé—®é¢˜ï¼š</p>
<table>
<thead>
<tr>
<th>æ“ä½œç±»å‹</th>
<th>æ˜¯å¦å¯å¹¶è¡Œ</th>
<th>æ˜¯å¦é˜»å¡å†™æ“ä½œ</th>
</tr>
</thead>
<tbody><tr>
<td>å¤šä¸ªçº¿ç¨‹â€œè¯»â€</td>
<td>âœ… å¯å¹¶è¡Œ</td>
<td>âœ… é˜»å¡å†™</td>
</tr>
<tr>
<td>å†™çº¿ç¨‹</td>
<td>âŒ ä¸å¯å¹¶è¡Œ</td>
<td>âœ… é˜»å¡è¯»å†™</td>
</tr>
</tbody></table>
<blockquote>
<p><strong>æ ¸å¿ƒæ€æƒ³ï¼š</strong></p>
<ul>
<li>å¤šä¸ªè¯»è€…ï¼ˆReadersï¼‰ä¹‹é—´å¯ä»¥å¹¶è¡Œï¼›</li>
<li>å†™è€…ï¼ˆWriterï¼‰å¿…é¡»ç‹¬å ã€‚</li>
</ul>
</blockquote>
<hr>
<h2 id="âš™ï¸-äºŒã€è¯»å†™é”çš„ä¸‰ç§çŠ¶æ€"><a href="#âš™ï¸-äºŒã€è¯»å†™é”çš„ä¸‰ç§çŠ¶æ€" class="headerlink" title="âš™ï¸ äºŒã€è¯»å†™é”çš„ä¸‰ç§çŠ¶æ€"></a>âš™ï¸ äºŒã€è¯»å†™é”çš„ä¸‰ç§çŠ¶æ€</h2><p>ä¸€ä¸ªå…¸å‹çš„è¯»å†™é”å†…éƒ¨å¯ä»¥ç”¨ä¸‰ä¸ªçŠ¶æ€å˜é‡æè¿°ï¼š</p>
<table>
<thead>
<tr>
<th>çŠ¶æ€å˜é‡</th>
<th>å«ä¹‰</th>
</tr>
</thead>
<tbody><tr>
<td><code>reader_count</code></td>
<td>å½“å‰æ­£åœ¨è¯»çš„çº¿ç¨‹æ•°</td>
</tr>
<tr>
<td><code>writer</code></td>
<td>æ˜¯å¦æœ‰å†™çº¿ç¨‹å ç”¨ï¼ˆå¸ƒå°”å€¼ï¼‰</td>
</tr>
<tr>
<td><code>writer_waiting_count</code></td>
<td>ç­‰å¾…å†™çš„çº¿ç¨‹æ•°ï¼ˆå¯é€‰ï¼‰</td>
</tr>
</tbody></table>
<hr>
<h2 id="ğŸ§ -ä¸‰ã€åŸºæœ¬åŸç†ï¼ˆçŠ¶æ€æœºï¼‰"><a href="#ğŸ§ -ä¸‰ã€åŸºæœ¬åŸç†ï¼ˆçŠ¶æ€æœºï¼‰" class="headerlink" title="ğŸ§  ä¸‰ã€åŸºæœ¬åŸç†ï¼ˆçŠ¶æ€æœºï¼‰"></a>ğŸ§  ä¸‰ã€åŸºæœ¬åŸç†ï¼ˆçŠ¶æ€æœºï¼‰</h2><h3 id="âœ…-è¯»é”åŠ é”æµç¨‹ï¼ˆlock-shared-ï¼‰ï¼š"><a href="#âœ…-è¯»é”åŠ é”æµç¨‹ï¼ˆlock-shared-ï¼‰ï¼š" class="headerlink" title="âœ… è¯»é”åŠ é”æµç¨‹ï¼ˆlock_shared()ï¼‰ï¼š"></a>âœ… è¯»é”åŠ é”æµç¨‹ï¼ˆ<code>lock_shared()</code>ï¼‰ï¼š</h3><ol>
<li>è·å–å†…éƒ¨é”ï¼ˆå¦‚è‡ªæ—‹é”æˆ–äº’æ–¥é‡ï¼‰ï¼Œä¿æŠ¤è®¡æ•°å˜é‡ã€‚</li>
<li>æ£€æŸ¥ï¼š<ul>
<li>å¦‚æœå½“å‰æœ‰å†™çº¿ç¨‹æ­£åœ¨æ‰§è¡Œï¼ˆ<code>writer == true</code>ï¼‰ï¼Œåˆ™é˜»å¡ç­‰å¾…ã€‚</li>
<li>å¦åˆ™å¢åŠ  <code>reader_count</code>ã€‚</li>
</ul>
</li>
<li>é‡Šæ”¾å†…éƒ¨é”ï¼Œå…è®¸å…¶ä»–è¯»è€…åŒæ—¶è¿›å…¥ã€‚</li>
</ol>
<h3 id="ğŸ”“-è¯»é”è§£é”æµç¨‹ï¼ˆunlock-shared-ï¼‰ï¼š"><a href="#ğŸ”“-è¯»é”è§£é”æµç¨‹ï¼ˆunlock-shared-ï¼‰ï¼š" class="headerlink" title="ğŸ”“ è¯»é”è§£é”æµç¨‹ï¼ˆunlock_shared()ï¼‰ï¼š"></a>ğŸ”“ è¯»é”è§£é”æµç¨‹ï¼ˆ<code>unlock_shared()</code>ï¼‰ï¼š</h3><ol>
<li>è·å–å†…éƒ¨é”ã€‚</li>
<li><code>reader_count -= 1</code></li>
<li>å¦‚æœ <code>reader_count == 0</code> ä¸”æœ‰å†™çº¿ç¨‹åœ¨ç­‰å¾…ï¼Œåˆ™å”¤é†’å†™çº¿ç¨‹ã€‚</li>
<li>é‡Šæ”¾å†…éƒ¨é”ã€‚</li>
</ol>
<hr>
<h3 id="âœï¸-å†™é”åŠ é”æµç¨‹ï¼ˆlock-ï¼‰ï¼š"><a href="#âœï¸-å†™é”åŠ é”æµç¨‹ï¼ˆlock-ï¼‰ï¼š" class="headerlink" title="âœï¸ å†™é”åŠ é”æµç¨‹ï¼ˆlock()ï¼‰ï¼š"></a>âœï¸ å†™é”åŠ é”æµç¨‹ï¼ˆ<code>lock()</code>ï¼‰ï¼š</h3><ol>
<li>è·å–å†…éƒ¨é”ã€‚</li>
<li>æ£€æŸ¥ï¼š<ul>
<li>å¦‚æœæœ‰è¯»çº¿ç¨‹ï¼ˆ<code>reader_count &gt; 0</code>ï¼‰æˆ–å†™çº¿ç¨‹ï¼ˆ<code>writer == true</code>ï¼‰ï¼Œåˆ™ç­‰å¾…ã€‚</li>
</ul>
</li>
<li>è®¾ç½® <code>writer = true</code>ã€‚</li>
<li>é‡Šæ”¾å†…éƒ¨é”ã€‚</li>
</ol>
<h3 id="ğŸ”“-å†™é”è§£é”æµç¨‹ï¼ˆunlock-ï¼‰ï¼š"><a href="#ğŸ”“-å†™é”è§£é”æµç¨‹ï¼ˆunlock-ï¼‰ï¼š" class="headerlink" title="ğŸ”“ å†™é”è§£é”æµç¨‹ï¼ˆunlock()ï¼‰ï¼š"></a>ğŸ”“ å†™é”è§£é”æµç¨‹ï¼ˆ<code>unlock()</code>ï¼‰ï¼š</h3><ol>
<li>è·å–å†…éƒ¨é”ã€‚</li>
<li>è®¾ç½® <code>writer = false</code>ã€‚</li>
<li>å”¤é†’ç­‰å¾…çš„çº¿ç¨‹ï¼š<ul>
<li>å¦‚æœæœ‰å†™çº¿ç¨‹åœ¨ç­‰å¾… â†’ ä¼˜å…ˆå”¤é†’å†™çº¿ç¨‹ï¼ˆé˜²æ­¢å†™é¥¥é¥¿ï¼‰ã€‚</li>
<li>å¦åˆ™å”¤é†’æ‰€æœ‰è¯»çº¿ç¨‹ã€‚</li>
</ul>
</li>
<li>é‡Šæ”¾å†…éƒ¨é”ã€‚</li>
</ol>
<hr>
<h2 id="ğŸ§©-å››ã€çŠ¶æ€è½¬æ¢å›¾"><a href="#ğŸ§©-å››ã€çŠ¶æ€è½¬æ¢å›¾" class="headerlink" title="ğŸ§© å››ã€çŠ¶æ€è½¬æ¢å›¾"></a>ğŸ§© å››ã€çŠ¶æ€è½¬æ¢å›¾</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ åˆå§‹çŠ¶æ€                              â”‚</span><br><span class="line">â”‚ reader_count = 0, writer = false       â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">          â”‚</span><br><span class="line">          â”‚ lock_shared()</span><br><span class="line">          â–¼</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ è¯»æ¨¡å¼ï¼ˆå¯å¹¶å‘ï¼‰                      â”‚</span><br><span class="line">â”‚ reader_count = N, writer = false       â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">          â”‚ unlock_shared() â†“</span><br><span class="line">          â”‚ lock() â†‘ ï¼ˆç­‰å¾… reader_count==0ï¼‰</span><br><span class="line">          â–¼</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ å†™æ¨¡å¼ï¼ˆç‹¬å ï¼‰                         â”‚</span><br><span class="line">â”‚ reader_count = 0, writer = true        â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="ğŸ§®-äº”ã€ç®€å•ä¼ªå®ç°ï¼ˆC-æ€è·¯ï¼‰"><a href="#ğŸ§®-äº”ã€ç®€å•ä¼ªå®ç°ï¼ˆC-æ€è·¯ï¼‰" class="headerlink" title="ğŸ§® äº”ã€ç®€å•ä¼ªå®ç°ï¼ˆC++æ€è·¯ï¼‰"></a>ğŸ§® äº”ã€ç®€å•ä¼ªå®ç°ï¼ˆC++æ€è·¯ï¼‰</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;condition_variable&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RWLock</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">lock_shared</span><span class="params">()</span> </span>&#123; <span class="comment">// è¯»é”</span></span><br><span class="line">        <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lk</span><span class="params">(mtx)</span></span>;</span><br><span class="line">        read_cv.<span class="built_in">wait</span>(lk, [<span class="keyword">this</span>]() &#123; <span class="keyword">return</span> !writer; &#125;);</span><br><span class="line">        ++reader_count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">unlock_shared</span><span class="params">()</span> </span>&#123; <span class="comment">// è¯»é”é‡Šæ”¾</span></span><br><span class="line">        <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lk</span><span class="params">(mtx)</span></span>;</span><br><span class="line">        <span class="keyword">if</span> (--reader_count == <span class="number">0</span>)</span><br><span class="line">            write_cv.<span class="built_in">notify_one</span>(); <span class="comment">// å¦‚æœæœ€åä¸€ä¸ªè¯»è€…é‡Šæ”¾ï¼Œåˆ™å”¤é†’å†™è€…</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123; <span class="comment">// å†™é”</span></span><br><span class="line">        <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lk</span><span class="params">(mtx)</span></span>;</span><br><span class="line">        write_cv.<span class="built_in">wait</span>(lk, [<span class="keyword">this</span>]() &#123; <span class="keyword">return</span> !writer &amp;&amp; reader_count == <span class="number">0</span>; &#125;);</span><br><span class="line">        writer = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">unlock</span><span class="params">()</span> </span>&#123; <span class="comment">// å†™é”é‡Šæ”¾</span></span><br><span class="line">        <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lk</span><span class="params">(mtx)</span></span>;</span><br><span class="line">        writer = <span class="literal">false</span>;</span><br><span class="line">        read_cv.<span class="built_in">notify_all</span>(); <span class="comment">// å”¤é†’æ‰€æœ‰è¯»è€…</span></span><br><span class="line">        write_cv.<span class="built_in">notify_one</span>(); <span class="comment">// å”¤é†’ä¸‹ä¸€ä¸ªå†™è€…</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::mutex mtx;</span><br><span class="line">    std::condition_variable read_cv, write_cv;</span><br><span class="line">    <span class="type">int</span> reader_count = <span class="number">0</span>;</span><br><span class="line">    <span class="type">bool</span> writer = <span class="literal">false</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="âš–ï¸-å…­ã€å¸¸è§çš„å…¬å¹³æ€§ç­–ç•¥"><a href="#âš–ï¸-å…­ã€å¸¸è§çš„å…¬å¹³æ€§ç­–ç•¥" class="headerlink" title="âš–ï¸ å…­ã€å¸¸è§çš„å…¬å¹³æ€§ç­–ç•¥"></a>âš–ï¸ å…­ã€å¸¸è§çš„å…¬å¹³æ€§ç­–ç•¥</h2><p>å®é™…å®ç°ä¸­ï¼Œè¯»å†™é”æœ‰ä¸‰ç§è°ƒåº¦ç­–ç•¥ï¼š</p>
<table>
<thead>
<tr>
<th>ç­–ç•¥ç±»å‹</th>
<th>è¯´æ˜</th>
<th>é€‚ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody><tr>
<td><strong>è¯»ä¼˜å…ˆï¼ˆRead-biasedï¼‰</strong></td>
<td>åªè¦æœ‰è¯»çº¿ç¨‹ï¼Œå°±å…è®¸è¿›å…¥ï¼Œä¸ç®¡æ˜¯å¦æœ‰å†™çº¿ç¨‹åœ¨ç­‰</td>
<td>è¯»å¤šå†™å°‘çš„åœºæ™¯ï¼ˆé«˜æ€§èƒ½ï¼‰</td>
</tr>
<tr>
<td><strong>å†™ä¼˜å…ˆï¼ˆWrite-biasedï¼‰</strong></td>
<td>æœ‰å†™çº¿ç¨‹ç­‰å¾…æ—¶ï¼Œç¦æ­¢æ–°è¯»çº¿ç¨‹è¿›å…¥</td>
<td>å†™å¤šè¯»å°‘ï¼Œé¿å…å†™é¥¥é¥¿</td>
</tr>
<tr>
<td><strong>å…¬å¹³é”ï¼ˆFair RWLockï¼‰</strong></td>
<td>ä¸¥æ ¼æŒ‰ç…§åˆ°è¾¾é¡ºåºè°ƒåº¦</td>
<td>å¼ºå®æ—¶æ€§è¦æ±‚</td>
</tr>
</tbody></table>
<p>ä¾‹å¦‚ï¼š<br><code>pthread_rwlock</code> é»˜è®¤æ˜¯ <strong>å†™ä¼˜å…ˆ</strong>ï¼Œ<br>è€Œ C++17 çš„ <code>std::shared_mutex</code> æ˜¯ <strong>ä¸ä¿è¯å…¬å¹³æ€§</strong> çš„å®ç°ï¼ˆå¯èƒ½è½»å¾®å€¾å‘è¯»è€…ï¼‰ã€‚</p>
<hr>
<h2 id="ğŸš€-ä¸ƒã€C-ä¸­çš„æ ‡å‡†è¯»å†™é”å®ç°"><a href="#ğŸš€-ä¸ƒã€C-ä¸­çš„æ ‡å‡†è¯»å†™é”å®ç°" class="headerlink" title="ğŸš€ ä¸ƒã€C++ä¸­çš„æ ‡å‡†è¯»å†™é”å®ç°"></a>ğŸš€ ä¸ƒã€C++ä¸­çš„æ ‡å‡†è¯»å†™é”å®ç°</h2><h3 id="C-14ï¼šstd-shared-timed-mutex"><a href="#C-14ï¼šstd-shared-timed-mutex" class="headerlink" title="C++14ï¼šstd::shared_timed_mutex"></a>C++14ï¼š<code>std::shared_timed_mutex</code></h3><h3 id="C-17ï¼šstd-shared-mutexï¼ˆæ€§èƒ½æ›´é«˜ï¼‰"><a href="#C-17ï¼šstd-shared-mutexï¼ˆæ€§èƒ½æ›´é«˜ï¼‰" class="headerlink" title="C++17ï¼šstd::shared_mutexï¼ˆæ€§èƒ½æ›´é«˜ï¼‰"></a>C++17ï¼š<code>std::shared_mutex</code>ï¼ˆæ€§èƒ½æ›´é«˜ï¼‰</h3><p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;shared_mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line">std::shared_mutex rwlock;</span><br><span class="line"><span class="type">int</span> shared_data = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">reader</span><span class="params">(<span class="type">int</span> id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; ++i) &#123;</span><br><span class="line">        <span class="function">std::shared_lock <span class="title">lock</span><span class="params">(rwlock)</span></span>;  <span class="comment">// è¯»é”</span></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Reader &quot;</span> &lt;&lt; id &lt;&lt; <span class="string">&quot; sees &quot;</span> &lt;&lt; shared_data &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">writer</span><span class="params">(<span class="type">int</span> id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; ++i) &#123;</span><br><span class="line">        <span class="function">std::unique_lock <span class="title">lock</span><span class="params">(rwlock)</span></span>;  <span class="comment">// å†™é”</span></span><br><span class="line">        ++shared_data;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Writer &quot;</span> &lt;&lt; id &lt;&lt; <span class="string">&quot; increments data to &quot;</span> &lt;&lt; shared_data &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">std::thread <span class="title">r1</span><span class="params">(reader, <span class="number">1</span>)</span>, <span class="title">r2</span><span class="params">(reader, <span class="number">2</span>)</span>, <span class="title">w</span><span class="params">(writer, <span class="number">1</span>)</span></span>;</span><br><span class="line">    r<span class="number">1.</span><span class="built_in">join</span>(); r<span class="number">2.</span><span class="built_in">join</span>(); w.<span class="built_in">join</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="ğŸ§ -å…«ã€å¸¸è§é—®é¢˜ä¸é™·é˜±"><a href="#ğŸ§ -å…«ã€å¸¸è§é—®é¢˜ä¸é™·é˜±" class="headerlink" title="ğŸ§  å…«ã€å¸¸è§é—®é¢˜ä¸é™·é˜±"></a>ğŸ§  å…«ã€å¸¸è§é—®é¢˜ä¸é™·é˜±</h2><h3 id="1ï¸âƒ£-å†™è€…é¥¥é¥¿ï¼ˆWriter-Starvationï¼‰"><a href="#1ï¸âƒ£-å†™è€…é¥¥é¥¿ï¼ˆWriter-Starvationï¼‰" class="headerlink" title="1ï¸âƒ£ å†™è€…é¥¥é¥¿ï¼ˆWriter Starvationï¼‰"></a>1ï¸âƒ£ å†™è€…é¥¥é¥¿ï¼ˆWriter Starvationï¼‰</h3><ul>
<li>å¦‚æœè¯»çº¿ç¨‹æºæºä¸æ–­è¿›å…¥ï¼Œå†™çº¿ç¨‹å¯èƒ½é•¿æœŸç­‰å¾…ã€‚</li>
<li>è§£å†³ï¼šé‡‡ç”¨å†™ä¼˜å…ˆç­–ç•¥ï¼ˆç¦æ­¢æ–°è¯»è€…åœ¨æœ‰å†™ç­‰å¾…æ—¶è¿›å…¥ï¼‰ã€‚</li>
</ul>
<h3 id="2ï¸âƒ£-é€’å½’æ­»é”"><a href="#2ï¸âƒ£-é€’å½’æ­»é”" class="headerlink" title="2ï¸âƒ£ é€’å½’æ­»é”"></a>2ï¸âƒ£ é€’å½’æ­»é”</h3><ul>
<li>ä¸€ä¸ªçº¿ç¨‹æŒæœ‰è¯»é”åï¼Œå†è¯•å›¾è·å–å†™é”ä¼šæ­»é”ï¼ˆåä¹‹äº¦ç„¶ï¼‰ã€‚</li>
</ul>
<h3 id="3ï¸âƒ£-ä¸é€‚åˆâ€œè¯»å°‘å†™å¤šâ€"><a href="#3ï¸âƒ£-ä¸é€‚åˆâ€œè¯»å°‘å†™å¤šâ€" class="headerlink" title="3ï¸âƒ£ ä¸é€‚åˆâ€œè¯»å°‘å†™å¤šâ€"></a>3ï¸âƒ£ ä¸é€‚åˆâ€œè¯»å°‘å†™å¤šâ€</h3><ul>
<li>åœ¨å†™æ“ä½œé¢‘ç¹çš„æƒ…å†µä¸‹ï¼Œé”é¢‘ç¹åˆ‡æ¢æ¨¡å¼ï¼Œæ€§èƒ½å¯èƒ½æ¯”æ™®é€š <code>mutex</code> æ›´å·®ã€‚</li>
</ul>
<hr>
<h2 id="âœ…-ä¹ã€æ€»ç»“è¡¨æ ¼"><a href="#âœ…-ä¹ã€æ€»ç»“è¡¨æ ¼" class="headerlink" title="âœ… ä¹ã€æ€»ç»“è¡¨æ ¼"></a>âœ… ä¹ã€æ€»ç»“è¡¨æ ¼</h2><table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>äº’æ–¥é” (<code>std::mutex</code>)</th>
<th>è¯»å†™é” (<code>std::shared_mutex</code>)</th>
</tr>
</thead>
<tbody><tr>
<td>å¹¶å‘è¯»</td>
<td>âŒ ä¸å…è®¸</td>
<td>âœ… å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»</td>
</tr>
<tr>
<td>å†™ç‹¬å </td>
<td>âœ…</td>
<td>âœ…</td>
</tr>
<tr>
<td>å…¸å‹åœºæ™¯</td>
<td>è¯»å†™å‡è¡¡</td>
<td>è¯»å¤šå†™å°‘</td>
</tr>
<tr>
<td>æ€§èƒ½</td>
<td>è¯»æ—¶ä½æ•ˆ</td>
<td>è¯»æ—¶é«˜æ•ˆ</td>
</tr>
<tr>
<td>å…¬å¹³æ€§</td>
<td>ç®€å•</td>
<td>å¯é…ç½®ï¼ˆè¯»ä¼˜å…ˆ&#x2F;å†™ä¼˜å…ˆï¼‰</td>
</tr>
<tr>
<td>C++ æ ‡å‡†æ”¯æŒ</td>
<td>C++11</td>
<td>C++17 èµ·æ”¯æŒ</td>
</tr>
</tbody></table>
<hr>
<h2 id="ğŸ-åã€ä¸€å¥è¯æ€»ç»“"><a href="#ğŸ-åã€ä¸€å¥è¯æ€»ç»“" class="headerlink" title="ğŸ åã€ä¸€å¥è¯æ€»ç»“"></a>ğŸ åã€ä¸€å¥è¯æ€»ç»“</h2><blockquote>
<p><strong>è¯»å†™é”çš„æ ¸å¿ƒæ€æƒ³</strong>ï¼š<br>â€œå¤šä¸ªè¯»å¯ä»¥å¹¶è¡Œï¼Œä¸€ä¸ªå†™å¿…é¡»ç‹¬å ã€‚â€  </p>
<p>é€šè¿‡è®¡æ•°å™¨ + æ¡ä»¶å˜é‡&#x2F;åŸå­ + å†…å­˜å±éšœæ¥åè°ƒè¿™ä¸‰ç§çŠ¶æ€ï¼Œ<br>åœ¨â€œè¯»å¤šå†™å°‘â€çš„åœºæ™¯ä¸‹æ¯”æ™®é€šäº’æ–¥é”æ•ˆç‡æ›´é«˜ã€‚</p>
</blockquote>
<p>é€’å½’é”</p>
<p> <code>std::recursive_mutex</code> æ˜¯ C++11 æ ‡å‡†åº“ä¸­çš„ä¸€ç§äº’æ–¥é”ï¼Œå®ƒçš„ä¸»è¦ç‰¹ç‚¹æ˜¯<strong>æ”¯æŒé€’å½’åŠ é”</strong>ã€‚åœ¨è®¨è®ºå®ƒçš„ä½¿ç”¨ä»·å€¼ä¹‹å‰ï¼Œé¦–å…ˆæˆ‘ä»¬æ¥ç†è§£ä¸€ä¸‹é€’å½’åŠ é”çš„å«ä¹‰å’Œä½œç”¨ã€‚</p>
<h3 id="1-é€’å½’åŠ é”çš„å«ä¹‰"><a href="#1-é€’å½’åŠ é”çš„å«ä¹‰" class="headerlink" title="1. é€’å½’åŠ é”çš„å«ä¹‰"></a>1. <strong>é€’å½’åŠ é”çš„å«ä¹‰</strong></h3><p>åœ¨æ™®é€šçš„äº’æ–¥é”ï¼ˆ<code>std::mutex</code>ï¼‰ä¸­ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹å·²ç»è·å¾—äº†é”ï¼Œå®ƒå†å°è¯•è·å–è¯¥é”æ—¶å°†ä¼š<strong>æ­»é”</strong>ï¼Œå› ä¸ºå®ƒå·²ç»æŒæœ‰é”ï¼Œè€Œé”è¦æ±‚åŒä¸€çº¿ç¨‹æ— æ³•å†é‡å¤è·å¾—ã€‚</p>
<p>ä½†åœ¨é€’å½’äº’æ–¥é”ï¼ˆ<code>std::recursive_mutex</code>ï¼‰ä¸­ï¼Œçº¿ç¨‹å¯ä»¥é‡å¤è·å–é”ï¼Œæ¯æ¬¡åŠ é”æ—¶é”çš„å†…éƒ¨è®¡æ•°å™¨ä¼šé€’å¢ï¼Œç›´åˆ°çº¿ç¨‹è°ƒç”¨ <code>unlock()</code> å‡å°‘è®¡æ•°å™¨ï¼Œè®¡æ•°å™¨å½’é›¶æ—¶é”æ‰ä¼šè¢«å®Œå…¨é‡Šæ”¾ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line">std::recursive_mutex rmutex;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">recursive_function</span><span class="params">(<span class="type">int</span> count)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (count &lt;= <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    rmutex.<span class="built_in">lock</span>();  <span class="comment">// è·å–é”</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Lock acquired, count = &quot;</span> &lt;&lt; count &lt;&lt; std::endl;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å†æ¬¡åŠ é”</span></span><br><span class="line">    <span class="built_in">recursive_function</span>(count - <span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    rmutex.<span class="built_in">unlock</span>();  <span class="comment">// è§£é”</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Lock released, count = &quot;</span> &lt;&lt; count &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">recursive_function</span>(<span class="number">3</span>);  <span class="comment">// ä»3å¼€å§‹é€’å½’è°ƒç”¨</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ä¸Šé¢çš„ä»£ç å±•ç¤ºäº†é€’å½’åŠ é”</strong>ï¼Œçº¿ç¨‹å¯ä»¥é€šè¿‡é€’å½’è°ƒç”¨è·å–åŒä¸€ä¸ª <code>recursive_mutex</code> é”ï¼Œè€Œä¸ä¼šæ­»é”ã€‚</p>
<h3 id="2-std-recursive-mutex-çš„ä½¿ç”¨ä»·å€¼"><a href="#2-std-recursive-mutex-çš„ä½¿ç”¨ä»·å€¼" class="headerlink" title="2. std::recursive_mutex çš„ä½¿ç”¨ä»·å€¼"></a>2. <strong><code>std::recursive_mutex</code> çš„ä½¿ç”¨ä»·å€¼</strong></h3><p><code>std::recursive_mutex</code> çš„ä½¿ç”¨ä»·å€¼ä¸»è¦ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š</p>
<h4 id="1ï¸âƒ£-é€’å½’å‡½æ•°ä¸­å¯¹åŒä¸€ä¸ªèµ„æºçš„åŠ é”"><a href="#1ï¸âƒ£-é€’å½’å‡½æ•°ä¸­å¯¹åŒä¸€ä¸ªèµ„æºçš„åŠ é”" class="headerlink" title="1ï¸âƒ£ é€’å½’å‡½æ•°ä¸­å¯¹åŒä¸€ä¸ªèµ„æºçš„åŠ é”"></a>1ï¸âƒ£ <strong>é€’å½’å‡½æ•°ä¸­å¯¹åŒä¸€ä¸ªèµ„æºçš„åŠ é”</strong></h4><p>å½“ä½ ç¼–å†™é€’å½’å‡½æ•°æ—¶ï¼Œå¯èƒ½éœ€è¦åœ¨æ¯ä¸€å±‚é€’å½’ä¸­éƒ½åŠ é”ï¼Œä½†åˆä¸å¸Œæœ›å› ä¸ºé€’å½’çš„ç‰¹æ€§è€Œå¯¼è‡´æ­»é”ã€‚<code>std::recursive_mutex</code> å°±æ˜¯ä¸ºäº†è§£å†³è¿™ç§æƒ…å†µçš„ã€‚ä¾‹å¦‚ï¼Œå¤„ç†æ ‘å½¢ç»“æ„æˆ–è€…å›¾éå†çš„é€’å½’ç®—æ³•æ—¶ï¼Œå¸¸å¸¸ä¼šå‡ºç°è¿™ç§éœ€è¦å¤šæ¬¡åŠ é”çš„åœºæ™¯ã€‚</p>
<p><strong>ä¾‹å­ï¼š</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">processTreeNode</span><span class="params">(TreeNode* node)</span> </span>&#123;</span><br><span class="line">    rmutex.<span class="built_in">lock</span>();  <span class="comment">// é”å®š</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (node == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        rmutex.<span class="built_in">unlock</span>();  <span class="comment">// è§£é”</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é€’å½’éå†å­èŠ‚ç‚¹</span></span><br><span class="line">    <span class="built_in">processTreeNode</span>(node-&gt;left);</span><br><span class="line">    <span class="built_in">processTreeNode</span>(node-&gt;right);</span><br><span class="line">    </span><br><span class="line">    rmutex.<span class="built_in">unlock</span>();  <span class="comment">// è§£é”</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ¯æ¬¡é€’å½’è°ƒç”¨éƒ½ä¼šåŠ é”ï¼Œ<code>recursive_mutex</code> å¯ä»¥ç¡®ä¿åŒä¸€ä¸ªçº¿ç¨‹åœ¨é€’å½’è°ƒç”¨æ—¶ä¸ä¼šæ­»é”ã€‚</p>
<h4 id="2ï¸âƒ£-é¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­çš„æˆå‘˜å‡½æ•°é€’å½’è°ƒç”¨"><a href="#2ï¸âƒ£-é¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­çš„æˆå‘˜å‡½æ•°é€’å½’è°ƒç”¨" class="headerlink" title="2ï¸âƒ£ é¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­çš„æˆå‘˜å‡½æ•°é€’å½’è°ƒç”¨"></a>2ï¸âƒ£ <strong>é¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­çš„æˆå‘˜å‡½æ•°é€’å½’è°ƒç”¨</strong></h4><p>åœ¨é¢å‘å¯¹è±¡ç¼–ç¨‹ï¼ˆOOPï¼‰ä¸­ï¼Œæœ‰æ—¶ä¼šé‡åˆ°éœ€è¦åœ¨æˆå‘˜å‡½æ•°ä¸­é€’å½’åœ°è°ƒç”¨è‡ªå·±æ—¶ï¼Œå¯èƒ½ä¼šå†æ¬¡å°è¯•åŠ é”ã€‚æ¯”å¦‚ï¼Œå¦‚æœä½ æœ‰ä¸€ä¸ªç±»ï¼Œå®ƒçš„æˆå‘˜å‡½æ•°éœ€è¦åœ¨ä¸åŒå±‚çº§ä¸­å¤šæ¬¡è®¿é—®åŒä¸€å…±äº«èµ„æºï¼Œè€Œè¿™äº›æˆå‘˜å‡½æ•°åˆå¯èƒ½ä¼šé€’å½’è°ƒç”¨è‡ªå·±ã€‚æ­¤æ—¶ï¼Œä½¿ç”¨ <code>std::recursive_mutex</code> å¯ä»¥é¿å…æ­»é”ã€‚</p>
<p><strong>ä¾‹å­ï¼š</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Logger</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::recursive_mutex mtx;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">logMessage</span><span class="params">(<span class="type">const</span> std::string&amp; msg, <span class="type">int</span> level)</span> </span>&#123;</span><br><span class="line">        mtx.<span class="built_in">lock</span>();  <span class="comment">// åŠ é”</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (level &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// é€’å½’è°ƒç”¨</span></span><br><span class="line">            <span class="built_in">logMessage</span>(msg, level - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Logging message: &quot;</span> &lt;&lt; msg &lt;&lt; std::endl;</span><br><span class="line">        mtx.<span class="built_in">unlock</span>();  <span class="comment">// è§£é”</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œå¦‚æœ <code>logMessage</code> æ–¹æ³•åœ¨é€’å½’è°ƒç”¨æ—¶æ²¡æœ‰ä½¿ç”¨ <code>std::recursive_mutex</code>ï¼Œå°†ä¼šå¯¼è‡´æ­»é”ï¼Œå› ä¸ºå®ƒä¼šé‡å¤å°è¯•è·å–åŒä¸€ä¸ªé”ã€‚</p>
<h4 id="3ï¸âƒ£-é¿å…ä¸å¿…è¦çš„é”å‡çº§"><a href="#3ï¸âƒ£-é¿å…ä¸å¿…è¦çš„é”å‡çº§" class="headerlink" title="3ï¸âƒ£ é¿å…ä¸å¿…è¦çš„é”å‡çº§"></a>3ï¸âƒ£ <strong>é¿å…ä¸å¿…è¦çš„é”å‡çº§</strong></h4><p>æœ‰æ—¶ï¼Œå½“ä½ è®¾è®¡çš„ç¨‹åºä¸­éœ€è¦ä¸€ä¸ªå‡½æ•°åœ¨æŸäº›æƒ…å†µä¸‹é€’å½’è°ƒç”¨è‡ªå·±çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šä¸å°å¿ƒå¢åŠ è¿‡å¤šçš„é”ã€‚æ¯”å¦‚åœ¨æŸäº›ç®—æ³•ä¸­ï¼Œé€’å½’å‡½æ•°è°ƒç”¨å¯èƒ½ä¼šè¿›å…¥æ·±å±‚ï¼Œè€Œåœ¨æ¯ä¸€å±‚åŠ é”å¯èƒ½ä¼šè®©æˆ‘ä»¬é‡æ–°è€ƒè™‘åŠ é”çš„ä»£ä»·ã€‚<code>std::recursive_mutex</code> ä½¿å¾—åœ¨é€’å½’è°ƒç”¨ä¸­é¿å…é‡å¤åŠ é”å’Œè§£é”æ“ä½œã€‚é€šè¿‡é€’å½’åŠ é”ï¼Œé¿å…åœ¨æ¯ä¸ªé€’å½’è°ƒç”¨ä¸Šéƒ½å¢åŠ é¢å¤–çš„å¤æ‚æ€§ã€‚</p>
<h4 id="4ï¸âƒ£-å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­çš„ä¿æŠ¤æœºåˆ¶"><a href="#4ï¸âƒ£-å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­çš„ä¿æŠ¤æœºåˆ¶" class="headerlink" title="4ï¸âƒ£ å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­çš„ä¿æŠ¤æœºåˆ¶"></a>4ï¸âƒ£ <strong>å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­çš„ä¿æŠ¤æœºåˆ¶</strong></h4><p>å½“ä½ è®¾è®¡å¤šçº¿ç¨‹ç³»ç»Ÿæ—¶ï¼Œå°¤å…¶æ˜¯å½“å¤šä¸ªçº¿ç¨‹çš„å·¥ä½œé€»è¾‘éœ€è¦é€’å½’åœ°è¿›è¡Œæ—¶ï¼Œ<code>std::recursive_mutex</code> æä¾›äº†ä¸€ç§ä¾¿åˆ©çš„æœºåˆ¶æ¥é¿å…æ­»é”å’Œçº¿ç¨‹é—´çš„ä¸ä¸€è‡´æ€§ã€‚åœ¨æŸäº›å¤æ‚çš„å¤šçº¿ç¨‹åº”ç”¨ä¸­ï¼Œ<code>recursive_mutex</code> æ˜¯å¿…é¡»çš„å·¥å…·ï¼Œé¿å…çº¿ç¨‹åœ¨é€’å½’è°ƒç”¨è¿‡ç¨‹ä¸­é™·å…¥æ­»é”ã€‚</p>
<hr>
<h3 id="3-ä¸-std-mutex-çš„æ¯”è¾ƒ"><a href="#3-ä¸-std-mutex-çš„æ¯”è¾ƒ" class="headerlink" title="3. ä¸ std::mutex çš„æ¯”è¾ƒ"></a>3. <strong>ä¸ <code>std::mutex</code> çš„æ¯”è¾ƒ</strong></h3><table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th><code>std::mutex</code></th>
<th><code>std::recursive_mutex</code></th>
</tr>
</thead>
<tbody><tr>
<td><strong>æ˜¯å¦æ”¯æŒé€’å½’åŠ é”</strong></td>
<td>âŒ ä¸æ”¯æŒé€’å½’åŠ é”</td>
<td>âœ… æ”¯æŒé€’å½’åŠ é”</td>
</tr>
<tr>
<td><strong>åŠ é”åæ˜¯å¦å¯é‡å¤åŠ é”</strong></td>
<td>âŒ å¦‚æœçº¿ç¨‹å·²ç»æŒæœ‰é”ï¼Œé‡å¤åŠ é”ä¼šæ­»é”</td>
<td>âœ… çº¿ç¨‹å¯ä»¥å¤šæ¬¡åŠ é”ï¼Œç›´åˆ°è§£é”æ¬¡æ•°åŒ¹é…</td>
</tr>
<tr>
<td><strong>æ€§èƒ½</strong></td>
<td>æ€§èƒ½è¾ƒå¥½ï¼Œç®€å•çš„åŠ é”æœºåˆ¶</td>
<td>æ€§èƒ½è¾ƒå·®ï¼Œé€’å½’åŠ é”ä¼šå¢åŠ ä¸€å®šå¼€é”€</td>
</tr>
<tr>
<td><strong>é€‚ç”¨åœºæ™¯</strong></td>
<td>ç”¨äºæ™®é€šçš„äº’æ–¥é”ï¼Œé€‚åˆä¸€èˆ¬çš„èµ„æºåŒæ­¥</td>
<td>ç”¨äºé€’å½’è°ƒç”¨æ—¶é¿å…æ­»é”ï¼ˆä¾‹å¦‚æ ‘&#x2F;å›¾éå†ï¼‰</td>
</tr>
</tbody></table>
<h3 id="4-ä½•æ—¶åº”è¯¥ä½¿ç”¨-std-recursive-mutex"><a href="#4-ä½•æ—¶åº”è¯¥ä½¿ç”¨-std-recursive-mutex" class="headerlink" title="4. ä½•æ—¶åº”è¯¥ä½¿ç”¨ std::recursive_mutex"></a>4. <strong>ä½•æ—¶åº”è¯¥ä½¿ç”¨ <code>std::recursive_mutex</code></strong></h3><ul>
<li><strong>é€’å½’ç®—æ³•ä¸­éœ€è¦åŠ é”çš„åœºæ™¯</strong>ï¼šå¦‚æ ‘å½¢æ•°æ®ç»“æ„çš„éå†ã€å›¾çš„æ·±åº¦ä¼˜å…ˆéå†ç­‰ï¼Œå…¶ä¸­éœ€è¦é€’å½’åœ°å¯¹åŒä¸€ä¸ªå…±äº«èµ„æºè¿›è¡ŒåŠ é”ã€‚</li>
<li><strong>é¢å‘å¯¹è±¡çš„æˆå‘˜å‡½æ•°é€’å½’è°ƒç”¨</strong>ï¼šå½“ç±»çš„æˆå‘˜å‡½æ•°é€’å½’åœ°è°ƒç”¨è‡ªå·±ï¼Œå¹¶ä¸”éœ€è¦åœ¨æ¯ä¸€å±‚é€’å½’æ—¶æŒæœ‰é”æ—¶ï¼Œä½¿ç”¨ <code>std::recursive_mutex</code> å¯ä»¥é¿å…æ­»é”ã€‚</li>
<li><strong>é¿å…æ­»é”</strong>ï¼šå½“ä½ å¿…é¡»åœ¨é€’å½’è°ƒç”¨ä¸­å¤šæ¬¡åŠ é”ï¼Œè€Œä¸å¸Œæœ›å› ä¸ºå·²ç»æŒæœ‰é”çš„çº¿ç¨‹å†å»åŠ é”å¯¼è‡´æ­»é”æ—¶ã€‚</li>
</ul>
<h3 id="5-ä½•æ—¶ä¸åº”è¯¥ä½¿ç”¨-std-recursive-mutex"><a href="#5-ä½•æ—¶ä¸åº”è¯¥ä½¿ç”¨-std-recursive-mutex" class="headerlink" title="5. ä½•æ—¶ä¸åº”è¯¥ä½¿ç”¨ std::recursive_mutex"></a>5. <strong>ä½•æ—¶ä¸åº”è¯¥ä½¿ç”¨ <code>std::recursive_mutex</code></strong></h3><ul>
<li><strong>é¿å…ä¸å¿…è¦çš„å¤æ‚æ€§</strong>ï¼šå¦‚æœä½ ä¸éœ€è¦é€’å½’åŠ é”ï¼Œåªæ˜¯ç®€å•çš„äº’æ–¥æ“ä½œï¼Œ<code>std::mutex</code> ä¼šæ›´åŠ é«˜æ•ˆã€‚</li>
<li><strong>æ€§èƒ½è¦æ±‚è¾ƒé«˜çš„åœºæ™¯</strong>ï¼š<code>std::recursive_mutex</code> ç”±äºéœ€è¦ç»´æŠ¤é”çš„é€’å½’è®¡æ•°ï¼Œç›¸æ¯” <code>std::mutex</code> ä¼šæœ‰é¢å¤–çš„å¼€é”€ã€‚å› æ­¤ï¼Œå¯¹äºä¸éœ€è¦é€’å½’åŠ é”çš„åœºæ™¯ï¼Œä½¿ç”¨æ™®é€šçš„ <code>std::mutex</code> æ€§èƒ½ä¼šæ›´å¥½ã€‚</li>
</ul>
<h3 id="6-ç»“è®º"><a href="#6-ç»“è®º" class="headerlink" title="6. ç»“è®º"></a>6. <strong>ç»“è®º</strong></h3><ul>
<li><code>std::recursive_mutex</code> çš„ä»·å€¼åœ¨äºï¼Œå®ƒèƒ½å¤Ÿæ”¯æŒé€’å½’åŠ é”ï¼Œé¿å…æ­»é”ã€‚å®ƒé€‚ç”¨äºé‚£äº›éœ€è¦åœ¨é€’å½’å‡½æ•°æˆ–é¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­å¤šæ¬¡åŠ é”çš„åœºæ™¯ã€‚</li>
<li>ä½†æ˜¯ï¼Œå› ä¸ºå…¶ç»´æŠ¤é€’å½’è®¡æ•°å™¨ï¼Œæ€§èƒ½ä¸Šä¼šæ¯” <code>std::mutex</code> ç•¥å·®ï¼Œæ‰€ä»¥åº”è°¨æ…ä½¿ç”¨ã€‚åªæœ‰åœ¨<strong>çœŸæ­£éœ€è¦é€’å½’åŠ é”çš„æƒ…å†µä¸‹</strong>ï¼Œæ‰ä½¿ç”¨å®ƒã€‚</li>
</ul>
<p>å¦‚æœä½ çš„ä»£ç ä¸­æ²¡æœ‰é€’å½’è°ƒç”¨é”ï¼Œé‚£ä¹ˆä½¿ç”¨æ™®é€šçš„ <code>std::mutex</code> ä¼šæ›´åŠ ç®€å•ã€é«˜æ•ˆã€‚</p>
<hr>
<p>å±‚æ¬¡é”  </p>
<p><strong>â€œå±‚æ¬¡é”ï¼ˆhierarchical mutexï¼‰â€</strong> æ˜¯ä¸€ä¸ªåœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ç”¨äº<strong>é˜²æ­¢æ­»é”ï¼ˆdeadlockï¼‰</strong> çš„è®¾è®¡æ€æƒ³ã€‚<br>å®ƒå¹¶ä¸æ˜¯ C++ æ ‡å‡†åº“è‡ªå¸¦çš„æœºåˆ¶ï¼Œè€Œæ˜¯ä¸€ç§ <strong>ç¼–ç¨‹çº¦å®š + åŒ…è£…å®ç°</strong>ï¼Œç”¨æ¥åœ¨ç¨‹åºå±‚é¢ä¸Šå¼ºåˆ¶çº¿ç¨‹<strong>æŒ‰ç…§ä¸€å®šçš„é”å±‚æ¬¡é¡ºåºè·å–äº’æ–¥é”</strong>ã€‚</p>
<hr>
<h2 id="ğŸŒ³-ä¸€ã€ä¸ºä»€ä¹ˆéœ€è¦å±‚æ¬¡é”ï¼ˆèƒŒæ™¯ï¼‰"><a href="#ğŸŒ³-ä¸€ã€ä¸ºä»€ä¹ˆéœ€è¦å±‚æ¬¡é”ï¼ˆèƒŒæ™¯ï¼‰" class="headerlink" title="ğŸŒ³ ä¸€ã€ä¸ºä»€ä¹ˆéœ€è¦å±‚æ¬¡é”ï¼ˆèƒŒæ™¯ï¼‰"></a>ğŸŒ³ ä¸€ã€ä¸ºä»€ä¹ˆéœ€è¦å±‚æ¬¡é”ï¼ˆèƒŒæ™¯ï¼‰</h2><p>åœ¨å¤šçº¿ç¨‹ç¨‹åºä¸­ï¼Œæ­»é”å¸¸å¸¸ç”±<strong>é”çš„è·å–é¡ºåºä¸ä¸€è‡´</strong>é€ æˆï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// çº¿ç¨‹ 1</span></span><br><span class="line"><span class="built_in">lock</span>(A);</span><br><span class="line"><span class="built_in">lock</span>(B);</span><br><span class="line"></span><br><span class="line"><span class="comment">// çº¿ç¨‹ 2</span></span><br><span class="line"><span class="built_in">lock</span>(B);</span><br><span class="line"><span class="built_in">lock</span>(A);</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸¤ä¸ªçº¿ç¨‹å„è‡ªæ‹¿åˆ°ä¸€ä¸ªé”ï¼Œç„¶åç­‰å¾…å¯¹æ–¹é‡Šæ”¾å¦ä¸€ä¸ªé” â†’ æ°¸è¿œå¡ä½ã€‚</p>
<p>â¡ï¸ å¦‚æœèƒ½å¼ºåˆ¶æ‰€æœ‰çº¿ç¨‹æŒ‰ç…§ç›¸åŒçš„é¡ºåºåŠ é”ï¼ˆä¾‹å¦‚ â€œå…ˆé” A å†é” Bâ€ï¼‰ï¼Œå°±èƒ½<strong>å½»åº•é¿å…æ­»é”</strong>ã€‚</p>
<p>è¿™å°±æ˜¯å±‚æ¬¡é”ï¼ˆHierarchical Lockï¼‰çš„åŸºæœ¬æ€æƒ³ã€‚</p>
<hr>
<h2 id="ğŸ§©-äºŒã€å±‚æ¬¡é”çš„åŸç†ï¼ˆæ ¸å¿ƒæ€æƒ³ï¼‰"><a href="#ğŸ§©-äºŒã€å±‚æ¬¡é”çš„åŸç†ï¼ˆæ ¸å¿ƒæ€æƒ³ï¼‰" class="headerlink" title="ğŸ§© äºŒã€å±‚æ¬¡é”çš„åŸç†ï¼ˆæ ¸å¿ƒæ€æƒ³ï¼‰"></a>ğŸ§© äºŒã€å±‚æ¬¡é”çš„åŸç†ï¼ˆæ ¸å¿ƒæ€æƒ³ï¼‰</h2><p>æ¯ä¸€ä¸ªé”éƒ½è¢«èµ‹äºˆä¸€ä¸ª<strong>å±‚çº§ç¼–å·ï¼ˆhierarchy valueï¼‰</strong>ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªæ•´æ•°ã€‚</p>
<p>è§„åˆ™å¦‚ä¸‹ï¼š</p>
<ul>
<li>å±‚çº§ç¼–å· <strong>è¶Šé«˜ï¼Œä¼˜å…ˆçº§è¶Šä½</strong>ã€‚</li>
<li>çº¿ç¨‹åœ¨æŒæœ‰ä¸€ä¸ªå±‚çº§ä¸º <em>X</em> çš„é”æ—¶ï¼Œ<strong>åªèƒ½å†å»è·å–å±‚çº§æ¯” X æ›´ä½çš„é”</strong>ã€‚</li>
<li>å¦‚æœçº¿ç¨‹è¯•å›¾è¿åå±‚æ¬¡è§„åˆ™ï¼ˆä¾‹å¦‚å…ˆæ‹¿ä½å±‚æ¬¡é”å†æ‹¿é«˜å±‚æ¬¡é”ï¼‰ï¼Œç¨‹åºä¼šæŠ›å‡ºå¼‚å¸¸æˆ–ç»ˆæ­¢ï¼Œä»¥é˜²æ­¢æ½œåœ¨æ­»é”ã€‚</li>
</ul>
<p>è¿™ç§æœºåˆ¶å¯ä»¥é€šè¿‡å°è£… <code>std::mutex</code> å®ç°ã€‚</p>
<hr>
<h2 id="ğŸ’»-ä¸‰ã€ä¸€ä¸ªç®€å•çš„-C-å®ç°ç¤ºä¾‹"><a href="#ğŸ’»-ä¸‰ã€ä¸€ä¸ªç®€å•çš„-C-å®ç°ç¤ºä¾‹" class="headerlink" title="ğŸ’» ä¸‰ã€ä¸€ä¸ªç®€å•çš„ C++ å®ç°ç¤ºä¾‹"></a>ğŸ’» ä¸‰ã€ä¸€ä¸ªç®€å•çš„ C++ å®ç°ç¤ºä¾‹</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdexcept&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">hierarchical_mutex</span> &#123;</span><br><span class="line">    std::mutex internal_mutex;</span><br><span class="line">    <span class="type">const</span> <span class="type">unsigned</span> <span class="type">long</span> hierarchy_value;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> previous_hierarchy_value;</span><br><span class="line">    <span class="type">static</span> <span class="keyword">thread_local</span> <span class="type">unsigned</span> <span class="type">long</span> this_thread_hierarchy_value;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">check_for_violation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (this_thread_hierarchy_value &lt;= hierarchy_value) &#123;</span><br><span class="line">            <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;Mutex hierarchy violated&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">update_hierarchy_value</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        previous_hierarchy_value = this_thread_hierarchy_value;</span><br><span class="line">        this_thread_hierarchy_value = hierarchy_value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">hierarchical_mutex</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> value)</span></span></span><br><span class="line"><span class="function">        : hierarchy_value(value), previous_hierarchy_value(<span class="number">0</span>) &#123;</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="built_in">check_for_violation</span>();</span><br><span class="line">        internal_mutex.<span class="built_in">lock</span>();</span><br><span class="line">        <span class="built_in">update_hierarchy_value</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">unlock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        this_thread_hierarchy_value = previous_hierarchy_value;</span><br><span class="line">        internal_mutex.<span class="built_in">unlock</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">try_lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="built_in">check_for_violation</span>();</span><br><span class="line">        <span class="keyword">if</span> (!internal_mutex.<span class="built_in">try_lock</span>())</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="built_in">update_hierarchy_value</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">thread_local</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="title">hierarchical_mutex::this_thread_hierarchy_value</span><span class="params">(ULONG_MAX)</span></span>;</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨ç¤ºä¾‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">hierarchical_mutex <span class="title">high_level_lock</span><span class="params">(<span class="number">10000</span>)</span></span>;</span><br><span class="line"><span class="function">hierarchical_mutex <span class="title">mid_level_lock</span><span class="params">(<span class="number">5000</span>)</span></span>;</span><br><span class="line"><span class="function">hierarchical_mutex <span class="title">low_level_lock</span><span class="params">(<span class="number">100</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">low_level_func</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">std::lock_guard&lt;hierarchical_mutex&gt; <span class="title">lk</span><span class="params">(low_level_lock)</span></span>;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Low-level function\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">mid_level_func</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">std::lock_guard&lt;hierarchical_mutex&gt; <span class="title">lk</span><span class="params">(mid_level_lock)</span></span>;</span><br><span class="line">    <span class="built_in">low_level_func</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">high_level_func</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">std::lock_guard&lt;hierarchical_mutex&gt; <span class="title">lk</span><span class="params">(high_level_lock)</span></span>;</span><br><span class="line">    <span class="built_in">mid_level_func</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">std::thread <span class="title">t1</span><span class="params">(high_level_func)</span></span>;</span><br><span class="line">    t<span class="number">1.</span><span class="built_in">join</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// é”™è¯¯ä½¿ç”¨ï¼šå…ˆé”ä½å±‚ï¼Œå†é”é«˜å±‚</span></span><br><span class="line">        <span class="function">std::lock_guard&lt;hierarchical_mutex&gt; <span class="title">lk1</span><span class="params">(low_level_lock)</span></span>;</span><br><span class="line">        <span class="function">std::lock_guard&lt;hierarchical_mutex&gt; <span class="title">lk2</span><span class="params">(high_level_lock)</span></span>;</span><br><span class="line">    &#125; <span class="built_in">catch</span> (<span class="type">const</span> std::logic_error&amp; e) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;Caught exception: &quot;</span> &lt;&lt; e.<span class="built_in">what</span>() &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºç»“æœï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Low-level function</span><br><span class="line">Caught exception: Mutex hierarchy violated</span><br></pre></td></tr></table></figure>

<p>âœ… æ­£ç¡®åŠ é”é¡ºåºï¼ˆé«˜â†’ä½ï¼‰å¯ä»¥æ‰§è¡Œ<br>âŒ é”™è¯¯åŠ é”é¡ºåºï¼ˆä½â†’é«˜ï¼‰ç›´æ¥æŠ¥é”™ï¼Œé¿å…æ½œåœ¨æ­»é”ã€‚</p>
<hr>
<h2 id="ğŸ§ -å››ã€å±‚æ¬¡é”çš„æ ¸å¿ƒä»·å€¼"><a href="#ğŸ§ -å››ã€å±‚æ¬¡é”çš„æ ¸å¿ƒä»·å€¼" class="headerlink" title="ğŸ§  å››ã€å±‚æ¬¡é”çš„æ ¸å¿ƒä»·å€¼"></a>ğŸ§  å››ã€å±‚æ¬¡é”çš„<strong>æ ¸å¿ƒä»·å€¼</strong></h2><h3 id="âœ…-ä¼˜ç‚¹"><a href="#âœ…-ä¼˜ç‚¹" class="headerlink" title="âœ… ä¼˜ç‚¹"></a>âœ… ä¼˜ç‚¹</h3><ol>
<li><strong>é˜²æ­¢æ­»é”</strong><ul>
<li>å¼ºåˆ¶åŠ é”é¡ºåºï¼Œé¿å…å¾ªç¯ç­‰å¾…æ¡ä»¶ã€‚</li>
</ul>
</li>
<li><strong>é€»è¾‘æ¸…æ™°</strong><ul>
<li>è®©ç³»ç»Ÿä¸­é”çš„â€œå±‚çº§ç»“æ„â€æ›´åŠ æ˜ç¡®ã€‚</li>
</ul>
</li>
<li><strong>è°ƒè¯•å‹å¥½</strong><ul>
<li>è¿åå±‚æ¬¡çš„é”è·å–åœ¨è¿è¡Œæ—¶ç«‹åˆ»æŠ¥é”™ï¼Œè€Œä¸æ˜¯æ­»é”åéš¾ä»¥æ’æŸ¥ã€‚</li>
</ul>
</li>
</ol>
<h3 id="âŒ-ç¼ºç‚¹"><a href="#âŒ-ç¼ºç‚¹" class="headerlink" title="âŒ ç¼ºç‚¹"></a>âŒ ç¼ºç‚¹</h3><ol>
<li><strong>çµæ´»æ€§ä¸‹é™</strong><ul>
<li>å¿…é¡»äº‹å…ˆå®šä¹‰é”çš„å±‚çº§ï¼Œä¸èƒ½éšæ„ç»„åˆã€‚</li>
</ul>
</li>
<li><strong>æ‰©å±•å›°éš¾</strong><ul>
<li>æ–°å¢æ¨¡å—éœ€è¦å°å¿ƒé€‰æ‹©å±‚çº§ç¼–å·ï¼Œå¦åˆ™å¯èƒ½ç ´åç°æœ‰è§„åˆ™ã€‚</li>
</ul>
</li>
<li><strong>æ€§èƒ½æŸè€—</strong><ul>
<li>è™½ç„¶å¾ˆå°ï¼Œä½†æ¯æ¬¡åŠ é”è§£é”éƒ½è¦åšå±‚æ¬¡æ£€æŸ¥ã€‚</li>
</ul>
</li>
<li><strong>ä»…é™â€œäººå·¥å®šä¹‰çš„å±‚çº§â€</strong><ul>
<li>æ— æ³•è‡ªåŠ¨æ¨æ–­å“ªä¸ªé”â€œæ›´é«˜â€ï¼Œéœ€è¦äººä¸ºæŒ‡å®šã€‚</li>
</ul>
</li>
</ol>
<hr>
<h2 id="âš™ï¸-äº”ã€å®é™…ä½¿ç”¨ä»·å€¼"><a href="#âš™ï¸-äº”ã€å®é™…ä½¿ç”¨ä»·å€¼" class="headerlink" title="âš™ï¸ äº”ã€å®é™…ä½¿ç”¨ä»·å€¼"></a>âš™ï¸ äº”ã€å®é™…ä½¿ç”¨ä»·å€¼</h2><h3 id="ğŸ’¡-åœ¨å®é™…å·¥ä¸šé¡¹ç›®ä¸­ï¼š"><a href="#ğŸ’¡-åœ¨å®é™…å·¥ä¸šé¡¹ç›®ä¸­ï¼š" class="headerlink" title="ğŸ’¡ åœ¨å®é™…å·¥ä¸šé¡¹ç›®ä¸­ï¼š"></a>ğŸ’¡ åœ¨å®é™…å·¥ä¸šé¡¹ç›®ä¸­ï¼š</h3><p>å±‚æ¬¡é”æœºåˆ¶ <strong>å¹¶ä¸å¸¸è§äºæ™®é€šä¸šåŠ¡é€»è¾‘</strong>ï¼Œä½†åœ¨ä»¥ä¸‹æƒ…å†µä¸­éå¸¸æœ‰ç”¨ï¼š</p>
<table>
<thead>
<tr>
<th>åœºæ™¯</th>
<th>ä¸ºä»€ä¹ˆæœ‰ç”¨</th>
</tr>
</thead>
<tbody><tr>
<td>âœ… <strong>æ“ä½œç³»ç»Ÿå†…æ ¸&#x2F;é©±åŠ¨ç¨‹åº</strong></td>
<td>é€šå¸¸æœ‰å›ºå®šçš„èµ„æºå±‚æ¬¡ï¼ˆæ¯”å¦‚ç¡¬ä»¶ â†’ é©±åŠ¨ â†’ å­æ¨¡å—ï¼‰ï¼Œå±‚æ¬¡é”å¯ä»¥é¿å…æ­»é”ã€‚</td>
</tr>
<tr>
<td>âœ… <strong>é«˜å¯é æ€§ç³»ç»Ÿï¼ˆé‡‘èã€é€šä¿¡ï¼‰</strong></td>
<td>æ­»é”çš„ä»£ä»·æé«˜æ—¶ï¼Œå¯ä»¥ç‰ºç‰²ä¸€ç‚¹çµæ´»æ€§æ¥æ¢å–å®‰å…¨æ€§ã€‚</td>
</tr>
<tr>
<td>âš ï¸ <strong>å¤§å‹å¹¶å‘æ¡†æ¶&#x2F;æ•°æ®åº“å†…æ ¸</strong></td>
<td>åœ¨å¤æ‚çš„é”ä¾èµ–ä¸­ï¼ˆå¦‚é”è¡¨ã€é¡µé”ã€è¡Œé”ï¼‰ï¼Œå¯å€ŸåŠ©å±‚æ¬¡é”æ£€æµ‹é€»è¾‘é”™è¯¯ã€‚</td>
</tr>
<tr>
<td>âŒ <strong>ä¸€èˆ¬åº”ç”¨ç¨‹åºï¼ˆå¦‚ Webã€GUIï¼‰</strong></td>
<td>å¤ªé‡ï¼Œç»´æŠ¤æˆæœ¬é«˜ï¼Œå¼€å‘è€…é€šå¸¸ç”¨ RAIIã€<code>std::lock</code> æˆ– <code>std::scoped_lock</code> æ¥é¿å…æ­»é”ã€‚</td>
</tr>
</tbody></table>
<hr>
<h2 id="âœ…-æ€»ç»“"><a href="#âœ…-æ€»ç»“" class="headerlink" title="âœ… æ€»ç»“"></a>âœ… æ€»ç»“</h2><table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td><strong>ç›®çš„</strong></td>
<td>é˜²æ­¢æ­»é”</td>
</tr>
<tr>
<td><strong>åŸç†</strong></td>
<td>æ¯ä¸ªé”æœ‰ä¸€ä¸ªå±‚çº§ç¼–å·ï¼Œçº¿ç¨‹åªèƒ½æŒ‰ä»é«˜åˆ°ä½çš„é¡ºåºè·å–é”</td>
</tr>
<tr>
<td><strong>æ£€æµ‹æ–¹å¼</strong></td>
<td>è¿è¡Œæ—¶æ£€æŸ¥ï¼ˆè¿åè§„åˆ™æ—¶æŠ¥é”™ï¼‰</td>
</tr>
<tr>
<td><strong>ä¼˜ç‚¹</strong></td>
<td>å¯å½»åº•é¿å…æ­»é”ï¼›è°ƒè¯•å‹å¥½</td>
</tr>
<tr>
<td><strong>ç¼ºç‚¹</strong></td>
<td>ç»´æŠ¤å¤æ‚ã€é™åˆ¶çµæ´»æ€§</td>
</tr>
<tr>
<td><strong>åº”ç”¨åœºæ™¯</strong></td>
<td>é«˜å¯é æ€§ç³»ç»Ÿã€å†…æ ¸ã€åº•å±‚æ¡†æ¶</td>
</tr>
<tr>
<td><strong>æ™®é€šé¡¹ç›®å»ºè®®</strong></td>
<td>é€šå¸¸ä½¿ç”¨ <code>std::scoped_lock</code> æˆ–å›ºå®šåŠ é”é¡ºåºå³å¯</td>
</tr>
</tbody></table>
<hr>
<p>ğŸ” <strong>ä¸€å¥è¯æ€»ç»“ï¼š</strong></p>
<blockquote>
<p>å±‚æ¬¡é”æ˜¯â€œç”¨è§„åˆ™æ¢å®‰å…¨â€çš„æ–¹æ¡ˆï¼š<br>å®ƒç”¨ä¸¥æ ¼çš„åŠ é”é¡ºåºä¿è¯ä¸ä¼šæ­»é”ï¼Œä»£ä»·æ˜¯çµæ´»æ€§å’Œå¯æ‰©å±•æ€§ã€‚<br>åœ¨æ™®é€šåº”ç”¨ä¸­ä¸å¸¸ç”¨ï¼Œä½†åœ¨é«˜å¯é æ€§æˆ–åº•å±‚ç³»ç»Ÿä¸­éå¸¸æœ‰ä»·å€¼ã€‚</p>
</blockquote>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="cmz">cmz</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://cmzcc.github.io/2025/10/29/%E3%80%8AC++-Concurrency-in-Action%E3%80%8B%E7%AC%AC%E4%B8%89%E7%AB%A0/">https://cmzcc.github.io/2025/10/29/%E3%80%8AC++-Concurrency-in-Action%E3%80%8B%E7%AC%AC%E4%B8%89%E7%AB%A0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/c/">c++</a><a class="post-meta__tags" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/">å¤šçº¿ç¨‹</a></div><div class="post-share"><div class="social-share" data-image="/img/text-cover3.jpg" data-sites="wechat,qq,weibo,qzone,facebook"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="prev-post pull-left" href="/2025/10/29/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%B8%AD%E7%9A%84%E6%84%8F%E5%A4%96%E5%8F%91%E7%8E%B0/" title="çº¿ç¨‹æ± ä¸­çš„æ„å¤–å‘ç°"><img class="cover" src="/img/text-cover1.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous</div><div class="prev_info">çº¿ç¨‹æ± ä¸­çš„æ„å¤–å‘ç°</div></div></a><a class="next-post pull-right" href="/2025/10/29/%E3%80%8AC++-Concurrency-in-Action%E3%80%8B%E7%AC%AC%E4%BA%8C%E7%AB%A0/" title="ã€ŠC++ Concurrency in Actionã€‹ç¬¬äºŒç« "><img class="cover" src="/img/text-cover2.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next</div><div class="next_info">ã€ŠC++ Concurrency in Actionã€‹ç¬¬äºŒç« </div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a href="/2025/02/27/c++%E4%B8%AD%E7%9A%84%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%86%99%E6%97%B6%E5%A4%8D%E5%88%B6/" title="c++ä¸­çš„å¤šçº¿ç¨‹å†™æ—¶å¤åˆ¶"><img class="cover" src="/img/text-cover2.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-02-27</div><div class="title">c++ä¸­çš„å¤šçº¿ç¨‹å†™æ—¶å¤åˆ¶</div></div></a><a href="/2025/10/29/%E3%80%8AC++-Concurrency-in-Action%E3%80%8B%E7%AC%AC%E4%BA%8C%E7%AB%A0/" title="ã€ŠC++ Concurrency in Actionã€‹ç¬¬äºŒç« "><img class="cover" src="/img/text-cover2.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-10-29</div><div class="title">ã€ŠC++ Concurrency in Actionã€‹ç¬¬äºŒç« </div></div></a><a href="/2025/11/08/%E3%80%8AC++-Concurrency-in-Action%E3%80%8B%E7%AC%AC%E5%9B%9B%E7%AB%A0/" title="ã€ŠC++-Concurrency-in-Actionã€‹ç¬¬å››ç« "><img class="cover" src="/img/text-cover3.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-11-08</div><div class="title">ã€ŠC++-Concurrency-in-Actionã€‹ç¬¬å››ç« </div></div></a><a href="/2025/01/12/Lambda%E8%A1%A8%E8%BE%BE%E5%BC%8F/" title="Lambdaè¡¨è¾¾å¼"><img class="cover" src="/img/text-cover1.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-01-12</div><div class="title">Lambdaè¡¨è¾¾å¼</div></div></a><a href="/2025/06/30/atomic/" title="atomic"><img class="cover" src="/img/text-cover2.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-06-30</div><div class="title">atomic</div></div></a><a href="/2025/01/27/bind%E5%92%8C%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0%E7%9A%84%E5%85%B3%E7%B3%BB/" title="bindå’Œå›è°ƒå‡½æ•°çš„å…³ç³»"><img class="cover" src="/img/text-cover2.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-01-27</div><div class="title">bindå’Œå›è°ƒå‡½æ•°çš„å…³ç³»</div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comments</span></div></div><div class="comment-wrap"><div><div id="waline-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info is-center"><div class="avatar-img"><img src="/img/personal-icon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">cmz</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">109</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">112</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">8</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/cmzcc"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/cmzcc" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:2721530241@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">åŠªåŠ›æˆä¸ºc++é«˜æ‰‹ingï¼Œä¸“ç²¾å¤šçº¿ç¨‹ç¼–ç¨‹å’Œæ€§èƒ½ä¼˜åŒ–æ–¹å‘ï¼Œå›½å†…ç§å‹Ÿé‡åŒ–å¼€å‘å®ä¹ ç”Ÿï¼ˆQD)ç‰›é©¬</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Meyers%E2%80%99-Singleton%EF%BC%88%E9%9D%99%E6%80%81%E5%B1%80%E9%83%A8%E5%8F%98%E9%87%8F%EF%BC%89"><span class="toc-number">1.</span> <span class="toc-text">Meyersâ€™ Singletonï¼ˆé™æ€å±€éƒ¨å˜é‡ï¼‰</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%A7%A9-%E4%B8%80%E3%80%81%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E8%AF%BB%E5%86%99%E9%94%81%EF%BC%9F"><span class="toc-number"></span> <span class="toc-text">ğŸ§© ä¸€ã€ä¸ºä»€ä¹ˆéœ€è¦è¯»å†™é”ï¼Ÿ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%9A%99%EF%B8%8F-%E4%BA%8C%E3%80%81%E8%AF%BB%E5%86%99%E9%94%81%E7%9A%84%E4%B8%89%E7%A7%8D%E7%8A%B6%E6%80%81"><span class="toc-number"></span> <span class="toc-text">âš™ï¸ äºŒã€è¯»å†™é”çš„ä¸‰ç§çŠ¶æ€</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%A7%A0-%E4%B8%89%E3%80%81%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86%EF%BC%88%E7%8A%B6%E6%80%81%E6%9C%BA%EF%BC%89"><span class="toc-number"></span> <span class="toc-text">ğŸ§  ä¸‰ã€åŸºæœ¬åŸç†ï¼ˆçŠ¶æ€æœºï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%9C%85-%E8%AF%BB%E9%94%81%E5%8A%A0%E9%94%81%E6%B5%81%E7%A8%8B%EF%BC%88lock-shared-%EF%BC%89%EF%BC%9A"><span class="toc-number">1.</span> <span class="toc-text">âœ… è¯»é”åŠ é”æµç¨‹ï¼ˆlock_shared()ï¼‰ï¼š</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%94%93-%E8%AF%BB%E9%94%81%E8%A7%A3%E9%94%81%E6%B5%81%E7%A8%8B%EF%BC%88unlock-shared-%EF%BC%89%EF%BC%9A"><span class="toc-number">2.</span> <span class="toc-text">ğŸ”“ è¯»é”è§£é”æµç¨‹ï¼ˆunlock_shared()ï¼‰ï¼š</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%9C%8F%EF%B8%8F-%E5%86%99%E9%94%81%E5%8A%A0%E9%94%81%E6%B5%81%E7%A8%8B%EF%BC%88lock-%EF%BC%89%EF%BC%9A"><span class="toc-number">3.</span> <span class="toc-text">âœï¸ å†™é”åŠ é”æµç¨‹ï¼ˆlock()ï¼‰ï¼š</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%94%93-%E5%86%99%E9%94%81%E8%A7%A3%E9%94%81%E6%B5%81%E7%A8%8B%EF%BC%88unlock-%EF%BC%89%EF%BC%9A"><span class="toc-number">4.</span> <span class="toc-text">ğŸ”“ å†™é”è§£é”æµç¨‹ï¼ˆunlock()ï¼‰ï¼š</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%A7%A9-%E5%9B%9B%E3%80%81%E7%8A%B6%E6%80%81%E8%BD%AC%E6%8D%A2%E5%9B%BE"><span class="toc-number"></span> <span class="toc-text">ğŸ§© å››ã€çŠ¶æ€è½¬æ¢å›¾</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%A7%AE-%E4%BA%94%E3%80%81%E7%AE%80%E5%8D%95%E4%BC%AA%E5%AE%9E%E7%8E%B0%EF%BC%88C-%E6%80%9D%E8%B7%AF%EF%BC%89"><span class="toc-number"></span> <span class="toc-text">ğŸ§® äº”ã€ç®€å•ä¼ªå®ç°ï¼ˆC++æ€è·¯ï¼‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%9A%96%EF%B8%8F-%E5%85%AD%E3%80%81%E5%B8%B8%E8%A7%81%E7%9A%84%E5%85%AC%E5%B9%B3%E6%80%A7%E7%AD%96%E7%95%A5"><span class="toc-number"></span> <span class="toc-text">âš–ï¸ å…­ã€å¸¸è§çš„å…¬å¹³æ€§ç­–ç•¥</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%9A%80-%E4%B8%83%E3%80%81C-%E4%B8%AD%E7%9A%84%E6%A0%87%E5%87%86%E8%AF%BB%E5%86%99%E9%94%81%E5%AE%9E%E7%8E%B0"><span class="toc-number"></span> <span class="toc-text">ğŸš€ ä¸ƒã€C++ä¸­çš„æ ‡å‡†è¯»å†™é”å®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#C-14%EF%BC%9Astd-shared-timed-mutex"><span class="toc-number">1.</span> <span class="toc-text">C++14ï¼šstd::shared_timed_mutex</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#C-17%EF%BC%9Astd-shared-mutex%EF%BC%88%E6%80%A7%E8%83%BD%E6%9B%B4%E9%AB%98%EF%BC%89"><span class="toc-number">2.</span> <span class="toc-text">C++17ï¼šstd::shared_mutexï¼ˆæ€§èƒ½æ›´é«˜ï¼‰</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%A7%A0-%E5%85%AB%E3%80%81%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E4%B8%8E%E9%99%B7%E9%98%B1"><span class="toc-number"></span> <span class="toc-text">ğŸ§  å…«ã€å¸¸è§é—®é¢˜ä¸é™·é˜±</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%EF%B8%8F%E2%83%A3-%E5%86%99%E8%80%85%E9%A5%A5%E9%A5%BF%EF%BC%88Writer-Starvation%EF%BC%89"><span class="toc-number">1.</span> <span class="toc-text">1ï¸âƒ£ å†™è€…é¥¥é¥¿ï¼ˆWriter Starvationï¼‰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%EF%B8%8F%E2%83%A3-%E9%80%92%E5%BD%92%E6%AD%BB%E9%94%81"><span class="toc-number">2.</span> <span class="toc-text">2ï¸âƒ£ é€’å½’æ­»é”</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%EF%B8%8F%E2%83%A3-%E4%B8%8D%E9%80%82%E5%90%88%E2%80%9C%E8%AF%BB%E5%B0%91%E5%86%99%E5%A4%9A%E2%80%9D"><span class="toc-number">3.</span> <span class="toc-text">3ï¸âƒ£ ä¸é€‚åˆâ€œè¯»å°‘å†™å¤šâ€</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%9C%85-%E4%B9%9D%E3%80%81%E6%80%BB%E7%BB%93%E8%A1%A8%E6%A0%BC"><span class="toc-number"></span> <span class="toc-text">âœ… ä¹ã€æ€»ç»“è¡¨æ ¼</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%8F%81-%E5%8D%81%E3%80%81%E4%B8%80%E5%8F%A5%E8%AF%9D%E6%80%BB%E7%BB%93"><span class="toc-number"></span> <span class="toc-text">ğŸ åã€ä¸€å¥è¯æ€»ç»“</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E9%80%92%E5%BD%92%E5%8A%A0%E9%94%81%E7%9A%84%E5%90%AB%E4%B9%89"><span class="toc-number">1.</span> <span class="toc-text">1. é€’å½’åŠ é”çš„å«ä¹‰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-std-recursive-mutex-%E7%9A%84%E4%BD%BF%E7%94%A8%E4%BB%B7%E5%80%BC"><span class="toc-number">2.</span> <span class="toc-text">2. std::recursive_mutex çš„ä½¿ç”¨ä»·å€¼</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%EF%B8%8F%E2%83%A3-%E9%80%92%E5%BD%92%E5%87%BD%E6%95%B0%E4%B8%AD%E5%AF%B9%E5%90%8C%E4%B8%80%E4%B8%AA%E8%B5%84%E6%BA%90%E7%9A%84%E5%8A%A0%E9%94%81"><span class="toc-number">2.1.</span> <span class="toc-text">1ï¸âƒ£ é€’å½’å‡½æ•°ä¸­å¯¹åŒä¸€ä¸ªèµ„æºçš„åŠ é”</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%EF%B8%8F%E2%83%A3-%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%BC%96%E7%A8%8B%E4%B8%AD%E7%9A%84%E6%88%90%E5%91%98%E5%87%BD%E6%95%B0%E9%80%92%E5%BD%92%E8%B0%83%E7%94%A8"><span class="toc-number">2.2.</span> <span class="toc-text">2ï¸âƒ£ é¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­çš„æˆå‘˜å‡½æ•°é€’å½’è°ƒç”¨</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%EF%B8%8F%E2%83%A3-%E9%81%BF%E5%85%8D%E4%B8%8D%E5%BF%85%E8%A6%81%E7%9A%84%E9%94%81%E5%8D%87%E7%BA%A7"><span class="toc-number">2.3.</span> <span class="toc-text">3ï¸âƒ£ é¿å…ä¸å¿…è¦çš„é”å‡çº§</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%EF%B8%8F%E2%83%A3-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B%E4%B8%AD%E7%9A%84%E4%BF%9D%E6%8A%A4%E6%9C%BA%E5%88%B6"><span class="toc-number">2.4.</span> <span class="toc-text">4ï¸âƒ£ å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­çš„ä¿æŠ¤æœºåˆ¶</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E4%B8%8E-std-mutex-%E7%9A%84%E6%AF%94%E8%BE%83"><span class="toc-number">3.</span> <span class="toc-text">3. ä¸ std::mutex çš„æ¯”è¾ƒ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E4%BD%95%E6%97%B6%E5%BA%94%E8%AF%A5%E4%BD%BF%E7%94%A8-std-recursive-mutex"><span class="toc-number">4.</span> <span class="toc-text">4. ä½•æ—¶åº”è¯¥ä½¿ç”¨ std::recursive_mutex</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E4%BD%95%E6%97%B6%E4%B8%8D%E5%BA%94%E8%AF%A5%E4%BD%BF%E7%94%A8-std-recursive-mutex"><span class="toc-number">5.</span> <span class="toc-text">5. ä½•æ—¶ä¸åº”è¯¥ä½¿ç”¨ std::recursive_mutex</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E7%BB%93%E8%AE%BA"><span class="toc-number">6.</span> <span class="toc-text">6. ç»“è®º</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%8C%B3-%E4%B8%80%E3%80%81%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E5%B1%82%E6%AC%A1%E9%94%81%EF%BC%88%E8%83%8C%E6%99%AF%EF%BC%89"><span class="toc-number"></span> <span class="toc-text">ğŸŒ³ ä¸€ã€ä¸ºä»€ä¹ˆéœ€è¦å±‚æ¬¡é”ï¼ˆèƒŒæ™¯ï¼‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%A7%A9-%E4%BA%8C%E3%80%81%E5%B1%82%E6%AC%A1%E9%94%81%E7%9A%84%E5%8E%9F%E7%90%86%EF%BC%88%E6%A0%B8%E5%BF%83%E6%80%9D%E6%83%B3%EF%BC%89"><span class="toc-number"></span> <span class="toc-text">ğŸ§© äºŒã€å±‚æ¬¡é”çš„åŸç†ï¼ˆæ ¸å¿ƒæ€æƒ³ï¼‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%92%BB-%E4%B8%89%E3%80%81%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-C-%E5%AE%9E%E7%8E%B0%E7%A4%BA%E4%BE%8B"><span class="toc-number"></span> <span class="toc-text">ğŸ’» ä¸‰ã€ä¸€ä¸ªç®€å•çš„ C++ å®ç°ç¤ºä¾‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%A7%A0-%E5%9B%9B%E3%80%81%E5%B1%82%E6%AC%A1%E9%94%81%E7%9A%84%E6%A0%B8%E5%BF%83%E4%BB%B7%E5%80%BC"><span class="toc-number"></span> <span class="toc-text">ğŸ§  å››ã€å±‚æ¬¡é”çš„æ ¸å¿ƒä»·å€¼</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%9C%85-%E4%BC%98%E7%82%B9"><span class="toc-number">1.</span> <span class="toc-text">âœ… ä¼˜ç‚¹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%9D%8C-%E7%BC%BA%E7%82%B9"><span class="toc-number">2.</span> <span class="toc-text">âŒ ç¼ºç‚¹</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%9A%99%EF%B8%8F-%E4%BA%94%E3%80%81%E5%AE%9E%E9%99%85%E4%BD%BF%E7%94%A8%E4%BB%B7%E5%80%BC"><span class="toc-number"></span> <span class="toc-text">âš™ï¸ äº”ã€å®é™…ä½¿ç”¨ä»·å€¼</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%92%A1-%E5%9C%A8%E5%AE%9E%E9%99%85%E5%B7%A5%E4%B8%9A%E9%A1%B9%E7%9B%AE%E4%B8%AD%EF%BC%9A"><span class="toc-number">1.</span> <span class="toc-text">ğŸ’¡ åœ¨å®é™…å·¥ä¸šé¡¹ç›®ä¸­ï¼š</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%9C%85-%E6%80%BB%E7%BB%93"><span class="toc-number"></span> <span class="toc-text">âœ… æ€»ç»“</span></a></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/11/09/lambda%E5%86%8D%E6%8E%A2/" title="lambdaå†æ¢"><img src="/img/text-cover2.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="lambdaå†æ¢"/></a><div class="content"><a class="title" href="/2025/11/09/lambda%E5%86%8D%E6%8E%A2/" title="lambdaå†æ¢">lambdaå†æ¢</a><time datetime="2025-11-09T03:43:06.000Z" title="Created 2025-11-09 11:43:06">2025-11-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/11/08/%E3%80%8AC++-Concurrency-in-Action%E3%80%8B%E7%AC%AC%E5%9B%9B%E7%AB%A0/" title="ã€ŠC++-Concurrency-in-Actionã€‹ç¬¬å››ç« "><img src="/img/text-cover3.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ã€ŠC++-Concurrency-in-Actionã€‹ç¬¬å››ç« "/></a><div class="content"><a class="title" href="/2025/11/08/%E3%80%8AC++-Concurrency-in-Action%E3%80%8B%E7%AC%AC%E5%9B%9B%E7%AB%A0/" title="ã€ŠC++-Concurrency-in-Actionã€‹ç¬¬å››ç« ">ã€ŠC++-Concurrency-in-Actionã€‹ç¬¬å››ç« </a><time datetime="2025-11-08T14:04:05.000Z" title="Created 2025-11-08 22:04:05">2025-11-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/11/05/TSDB-TDengine/" title="TSDB-TDengine"><img src="/img/text-cover3.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="TSDB-TDengine"/></a><div class="content"><a class="title" href="/2025/11/05/TSDB-TDengine/" title="TSDB-TDengine">TSDB-TDengine</a><time datetime="2025-11-05T08:39:16.000Z" title="Created 2025-11-05 16:39:16">2025-11-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/10/29/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%B8%AD%E7%9A%84%E6%84%8F%E5%A4%96%E5%8F%91%E7%8E%B0/" title="çº¿ç¨‹æ± ä¸­çš„æ„å¤–å‘ç°"><img src="/img/text-cover1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="çº¿ç¨‹æ± ä¸­çš„æ„å¤–å‘ç°"/></a><div class="content"><a class="title" href="/2025/10/29/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%B8%AD%E7%9A%84%E6%84%8F%E5%A4%96%E5%8F%91%E7%8E%B0/" title="çº¿ç¨‹æ± ä¸­çš„æ„å¤–å‘ç°">çº¿ç¨‹æ± ä¸­çš„æ„å¤–å‘ç°</a><time datetime="2025-10-29T13:28:03.000Z" title="Created 2025-10-29 21:28:03">2025-10-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/10/29/%E3%80%8AC++-Concurrency-in-Action%E3%80%8B%E7%AC%AC%E4%B8%89%E7%AB%A0/" title="ã€ŠC++ Concurrency in Actionã€‹ç¬¬ä¸‰ç« "><img src="/img/text-cover3.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ã€ŠC++ Concurrency in Actionã€‹ç¬¬ä¸‰ç« "/></a><div class="content"><a class="title" href="/2025/10/29/%E3%80%8AC++-Concurrency-in-Action%E3%80%8B%E7%AC%AC%E4%B8%89%E7%AB%A0/" title="ã€ŠC++ Concurrency in Actionã€‹ç¬¬ä¸‰ç« ">ã€ŠC++ Concurrency in Actionã€‹ç¬¬ä¸‰ç« </a><time datetime="2025-10-29T13:27:33.000Z" title="Created 2025-10-29 21:27:33">2025-10-29</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/img/foot.jpg);"><div id="footer-wrap"><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://cmzcc.github.io/">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="Scroll to Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>(() => {
  let initFn = window.walineFn || null

  const initWaline = (Fn) => {
    const waline = Fn(Object.assign({
      el: '#waline-wrap',
      serverURL: 'https://cc-blog-blond.vercel.app/',
      pageview: false,
      dark: 'html[data-theme="dark"]',
      path: window.location.pathname,
      comment: false,
    }, null))

    const destroyWaline = () => {
      waline.destroy()
    }

    btf.addGlobalFn('pjaxSendOnce', destroyWaline, 'destroyWaline')
  }

  const loadWaline = () => {
    if (initFn) initWaline(initFn)
    else {
      btf.getCSS('https://cdn.jsdelivr.net/npm/@waline/client/dist/waline.min.css')
        .then(() => import('https://cdn.jsdelivr.net/npm/@waline/client/dist/waline.min.js'))
        .then(({ init }) => {
          initFn = init || Waline.init
          initWaline(initFn)
          window.walineFn = initFn
        })
    }
  }

  if ('Waline' === 'Waline' || !false) {
    if (false) btf.loadComment(document.getElementById('waline-wrap'),loadWaline)
    else setTimeout(loadWaline, 0)
  } else {
    window.loadOtherComment = loadWaline
  }
})()</script></div><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="false"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>