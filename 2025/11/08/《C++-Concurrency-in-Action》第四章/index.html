<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>ã€ŠC++-Concurrency-in-Actionã€‹ç¬¬å››ç«  | Cialloï½(âˆ ãƒ»Ï‰&lt; )âŒ’â˜†               ccã®blog</title><meta name="author" content="cmz"><meta name="copyright" content="cmz"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="ç¢ç¢å¿µï¼šæ¥ä¸‹æ¥çš„ä¸€ä¸¤å‘¨å°±æ˜¯è€ƒè¯•é¢è¯•è€ƒè¯•é¢è¯•äº†ï¼Œå‰æ®µæ—¶é—´å¥½ä¸å®¹æ˜“è¯´æœè‡ªå·±ä¸“å¿ƒæé‡åŒ–ï¼Œwlbæ‰æ˜¯è¯¥è¿½æ±‚çš„ä¸œè¥¿ï¼Œä½†æ˜¯äº¬ä¸œçš„ä¸€ä¸ªé¢è¯•é‚€çº¦ç›´æ¥æ‰“ä¹±äº†è®¡åˆ’ã€‚è¿˜æ˜¯æƒ³å»äº’è”ç½‘åˆ·ä¸€æ®µå®ä¹ ï¼Œå»å»é­…ï¼Œæ¯•ç«Ÿå¦‚æœç§‹æ‹›å»é‡åŒ–çš„è¯ï¼Œç¤¾æ‹›å¤§æ¦‚ç‡ä¹Ÿå»ä¸äº†äº’è”ç½‘äº†ã€‚ åŠªåŠªåŠ›å‡†å¤‡ä¸€ä¸‹å§ï¼Œç®—æ³•ï¼Œå…«è‚¡ï¼Œé¡¹ç›®ï¼Œä»Šå¤©ä¸‹åˆå†çœ‹ä¸€ä¸‹dpæ˜¯æ€ä¹ˆå›äº‹ï¼Œé‡ç‚¹åˆ·ä¸€ä¸‹ï¼Œæˆ‘è¿˜æ˜¯å¤ªæ‘†çƒ‚äº†ï¼Œè‡ªå·±å®šä¸‹çš„ç›®æ ‡å¾ˆå°‘èƒ½å®Œæˆã€‚ â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”">
<meta property="og:type" content="article">
<meta property="og:title" content="ã€ŠC++-Concurrency-in-Actionã€‹ç¬¬å››ç« ">
<meta property="og:url" content="https://cmzcc.github.io/2025/11/08/%E3%80%8AC++-Concurrency-in-Action%E3%80%8B%E7%AC%AC%E5%9B%9B%E7%AB%A0/index.html">
<meta property="og:site_name" content="Cialloï½(âˆ ãƒ»Ï‰&lt; )âŒ’â˜†               ccã®blog">
<meta property="og:description" content="ç¢ç¢å¿µï¼šæ¥ä¸‹æ¥çš„ä¸€ä¸¤å‘¨å°±æ˜¯è€ƒè¯•é¢è¯•è€ƒè¯•é¢è¯•äº†ï¼Œå‰æ®µæ—¶é—´å¥½ä¸å®¹æ˜“è¯´æœè‡ªå·±ä¸“å¿ƒæé‡åŒ–ï¼Œwlbæ‰æ˜¯è¯¥è¿½æ±‚çš„ä¸œè¥¿ï¼Œä½†æ˜¯äº¬ä¸œçš„ä¸€ä¸ªé¢è¯•é‚€çº¦ç›´æ¥æ‰“ä¹±äº†è®¡åˆ’ã€‚è¿˜æ˜¯æƒ³å»äº’è”ç½‘åˆ·ä¸€æ®µå®ä¹ ï¼Œå»å»é­…ï¼Œæ¯•ç«Ÿå¦‚æœç§‹æ‹›å»é‡åŒ–çš„è¯ï¼Œç¤¾æ‹›å¤§æ¦‚ç‡ä¹Ÿå»ä¸äº†äº’è”ç½‘äº†ã€‚ åŠªåŠªåŠ›å‡†å¤‡ä¸€ä¸‹å§ï¼Œç®—æ³•ï¼Œå…«è‚¡ï¼Œé¡¹ç›®ï¼Œä»Šå¤©ä¸‹åˆå†çœ‹ä¸€ä¸‹dpæ˜¯æ€ä¹ˆå›äº‹ï¼Œé‡ç‚¹åˆ·ä¸€ä¸‹ï¼Œæˆ‘è¿˜æ˜¯å¤ªæ‘†çƒ‚äº†ï¼Œè‡ªå·±å®šä¸‹çš„ç›®æ ‡å¾ˆå°‘èƒ½å®Œæˆã€‚ â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cmzcc.github.io/img/text-cover3.jpg">
<meta property="article:published_time" content="2025-11-08T14:04:05.000Z">
<meta property="article:modified_time" content="2025-11-09T03:36:10.418Z">
<meta property="article:author" content="cmz">
<meta property="article:tag" content="c++">
<meta property="article:tag" content="å¤šçº¿ç¨‹">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cmzcc.github.io/img/text-cover3.jpg"><link rel="shortcut icon" href="/img/logo.png"><link rel="canonical" href="https://cmzcc.github.io/2025/11/08/%E3%80%8AC++-Concurrency-in-Action%E3%80%8B%E7%AC%AC%E5%9B%9B%E7%AB%A0/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        if (name && globalFn[key][name]) return
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"No results found for: ${query}","hits_stats":"${hits} articles found"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'ã€ŠC++-Concurrency-in-Actionã€‹ç¬¬å››ç« ',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-11-09 11:36:10'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">Loading...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load', preloader.endLoading)

  if (false) {
    btf.addGlobalFn('pjaxSend', preloader.initLoading, 'preloader_init')
    btf.addGlobalFn('pjaxComplete', preloader.endLoading, 'preloader_end')
  }
})()</script><div id="web_bg" style="background-image: url(/img/background.jpg);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/personal-icon.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">109</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">112</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">8</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/text-cover3.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="/img/logo.png" alt="Logo"><span class="site-name">Cialloï½(âˆ ãƒ»Ï‰&lt; )âŒ’â˜†               ccã®blog</span></a><a class="nav-page-title" href="/"><span class="site-name">ã€ŠC++-Concurrency-in-Actionã€‹ç¬¬å››ç« </span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">ã€ŠC++-Concurrency-in-Actionã€‹ç¬¬å››ç« </h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2025-11-08T14:04:05.000Z" title="Created 2025-11-08 22:04:05">2025-11-08</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2025-11-09T03:36:10.418Z" title="Updated 2025-11-09 11:36:10">2025-11-09</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">è¯»ä¹¦ç¬”è®°</a></span></div><div class="meta-secondline"></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>ç¢ç¢å¿µï¼šæ¥ä¸‹æ¥çš„ä¸€ä¸¤å‘¨å°±æ˜¯è€ƒè¯•é¢è¯•è€ƒè¯•é¢è¯•äº†ï¼Œå‰æ®µæ—¶é—´å¥½ä¸å®¹æ˜“è¯´æœè‡ªå·±ä¸“å¿ƒæé‡åŒ–ï¼Œwlbæ‰æ˜¯è¯¥è¿½æ±‚çš„ä¸œè¥¿ï¼Œä½†æ˜¯äº¬ä¸œçš„ä¸€ä¸ªé¢è¯•é‚€çº¦ç›´æ¥æ‰“ä¹±äº†è®¡åˆ’ã€‚è¿˜æ˜¯æƒ³å»äº’è”ç½‘åˆ·ä¸€æ®µå®ä¹ ï¼Œå»å»é­…ï¼Œæ¯•ç«Ÿå¦‚æœç§‹æ‹›å»é‡åŒ–çš„è¯ï¼Œç¤¾æ‹›å¤§æ¦‚ç‡ä¹Ÿå»ä¸äº†äº’è”ç½‘äº†ã€‚</p>
<p>åŠªåŠªåŠ›å‡†å¤‡ä¸€ä¸‹å§ï¼Œç®—æ³•ï¼Œå…«è‚¡ï¼Œé¡¹ç›®ï¼Œä»Šå¤©ä¸‹åˆå†çœ‹ä¸€ä¸‹dpæ˜¯æ€ä¹ˆå›äº‹ï¼Œé‡ç‚¹åˆ·ä¸€ä¸‹ï¼Œæˆ‘è¿˜æ˜¯å¤ªæ‘†çƒ‚äº†ï¼Œè‡ªå·±å®šä¸‹çš„ç›®æ ‡å¾ˆå°‘èƒ½å®Œæˆã€‚</p>
<p>â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”</p>
<p>æœ¬ä¹¦çš„ç¬¬å››ç« æ˜¯åŒæ­¥æ¡ä»¶ï¼Œé‡ç‚¹è®²çš„æ˜¯condition_varibleæ¡ä»¶å˜é‡å’Œfutureï¼Œè¿™é‡Œé‡ç‚¹è®²ä¸€ä¸‹futureï¼Œå¹¶ä»¥çº¿ç¨‹æ± ä¸ºä¾‹å­ï¼Œç¬¬å››ç« ååŠéƒ¨åˆ†çš„ä¸œè¥¿è¿‡äºå°ä¼—ï¼Œæˆ‘ä»¬å°±ç•¥è¿‡ä¸è®²ã€‚</p>
<p>cvè¿™ä¸ªæˆ‘ä»¬å¸¸ç”¨çš„æ¡ä»¶å˜é‡ï¼Œä¼šå­˜åœ¨ä¸€ä¸ªä¼ªå”¤é†’çš„æƒ…å†µï¼Œå³cv.wait()çš„æ¡ä»¶æ˜æ˜æ²¡æœ‰çœŸæ­£å‡†å¤‡å¥½ï¼Œä½†å°±è¢«å”¤é†’äº†ï¼ˆè¿™è®©æˆ‘æƒ³åˆ°äº†cas_weak)</p>
<p><strong>ä¼ªå”¤é†’</strong> æŒ‡çš„æ˜¯ï¼šä¸€ä¸ªæ­£åœ¨æ¡ä»¶å˜é‡ä¸Šç­‰å¾…çš„çº¿ç¨‹ï¼Œ<strong>åœ¨æ²¡æœ‰å…¶ä»–çº¿ç¨‹æ˜¾å¼åœ°é€šçŸ¥ï¼ˆsignal æˆ– broadcastï¼‰å®ƒçš„æƒ…å†µä¸‹ï¼Œè‡ªå·±ä»ç­‰å¾…çŠ¶æ€ï¼ˆå¦‚ <code>pthread_cond_wait</code> æˆ– <code>std::condition_variable::wait</code>ï¼‰ä¸­æ¢å¤æ‰§è¡Œäº†ã€‚</strong></p>
<p>æ¢å¥è¯è¯´ï¼Œçº¿ç¨‹è¢«â€œè«åå…¶å¦™â€åœ°å”¤é†’äº†ï¼Œä½†çº¿ç¨‹ç­‰å¾…çš„é‚£ä¸ªâ€œæ¡ä»¶â€å®é™…ä¸Šå¹¶æœªå˜ä¸ºçœŸã€‚</p>
<h3 id="ä¸ºä»€ä¹ˆä¼šå‡ºç°ä¼ªå”¤é†’ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆä¼šå‡ºç°ä¼ªå”¤é†’ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆä¼šå‡ºç°ä¼ªå”¤é†’ï¼Ÿ"></a>ä¸ºä»€ä¹ˆä¼šå‡ºç°ä¼ªå”¤é†’ï¼Ÿ</h3><p>ä¼ªå”¤é†’å¬èµ·æ¥åƒæ˜¯ä¸€ä¸ª Bugï¼Œä½†å®é™…ä¸Šï¼Œåœ¨æŸäº›æ“ä½œç³»ç»Ÿå’Œçº¿ç¨‹åº“çš„å®ç°ä¸­ï¼Œè¿™æ˜¯è¢«å…è®¸ç”šè‡³æ˜¯æœ‰æ„ä¸ºä¹‹çš„è¡Œä¸ºã€‚ä¸»è¦åŸå› æœ‰ï¼š</p>
<ol>
<li><strong>æ€§èƒ½å’Œå®ç°çš„ç®€åŒ–</strong>ï¼šåœ¨æ”¯æŒå¤šå¤„ç†å™¨ï¼ˆSMPï¼‰çš„ç³»ç»Ÿä¸Šï¼Œåœ¨æ¡ä»¶å˜é‡çš„å®ç°ä¸­ï¼Œè¦å®Œå…¨é¿å…ç«äº‰æ¡ä»¶å’Œä¿è¯ç»å¯¹çš„â€œä¸å”¤é†’â€ï¼Œå¯èƒ½éœ€è¦éå¸¸å¤æ‚çš„ã€ä½æ•ˆçš„ä»£ç ã€‚ä¸ºäº†æ€§èƒ½å’Œä»£ç ç®€æ´æ€§ï¼Œæ ‡å‡†å…è®¸åœ¨æŸäº›è¾¹ç¼˜æƒ…å†µä¸‹å‘ç”Ÿä¼ªå”¤é†’ã€‚</li>
<li><strong>ä¿¡å·ä¸­æ–­</strong>ï¼šåœ¨æŸäº›ç³»ç»Ÿä¸Šï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹åœ¨ç­‰å¾…æ—¶æ”¶åˆ°äº†ä¸€ä¸ªä¿¡å·ï¼ˆä¾‹å¦‚ UNIX ä¿¡å·ï¼‰ï¼Œç­‰å¾…å‡½æ•°å¯èƒ½ä¼šæå‰è¿”å›ã€‚è™½ç„¶è¿™é€šå¸¸ä¼šè¢«å½’ç±»ä¸ºé”™è¯¯è¿”å›ï¼Œä½†åœ¨æŸäº›å®ç°ä¸­ä¹Ÿå¯èƒ½è¢«è§†ä¸ºä¸€ç§å”¤é†’ã€‚</li>
</ol>
<p><strong>å…³é”®ç‚¹</strong>ï¼šPOSIX çº¿ç¨‹æ ‡å‡†å’Œ C++ æ ‡å‡†éƒ½<strong>æ˜ç¡®å…è®¸ä¼ªå”¤é†’çš„å‘ç”Ÿ</strong>ã€‚å› æ­¤ï¼Œç¼–å†™ä»£ç æ—¶ç»ä¸èƒ½å‡è®¾â€œçº¿ç¨‹è¢«å”¤é†’â€å°±ç­‰äºâ€œæ¡ä»¶å·²æ»¡è¶³â€ã€‚</p>
<h3 id="å¸¦æ¥çš„é—®é¢˜"><a href="#å¸¦æ¥çš„é—®é¢˜" class="headerlink" title="å¸¦æ¥çš„é—®é¢˜"></a>å¸¦æ¥çš„é—®é¢˜</h3><p>å¦‚æœä»£ç æ²¡æœ‰æ­£ç¡®å¤„ç†ä¼ªå”¤é†’ï¼Œä¼šå¯¼è‡´ä¸¥é‡çš„å¹¶å‘ Bugï¼š</p>
<ul>
<li><strong>æ•°æ®ç«äº‰</strong>ï¼šçº¿ç¨‹åœ¨æ¡ä»¶ä¸æ»¡è¶³çš„æƒ…å†µä¸‹è®¿é—®äº†å—ä¿æŠ¤çš„æ•°æ®ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®æŸåæˆ–è¯»å–åˆ°æ— æ•ˆçŠ¶æ€ã€‚</li>
<li><strong>é€»è¾‘é”™è¯¯</strong>ï¼šç¨‹åºåŸºäºä¸€ä¸ªé”™è¯¯çš„å‰æï¼ˆè®¤ä¸ºæ¡ä»¶å·²æ»¡è¶³ï¼‰ç»§ç»­æ‰§è¡Œï¼Œäº§ç”Ÿä¸å¯é¢„çŸ¥çš„ç»“æœã€‚</li>
<li><strong>ç¨‹åºå´©æºƒ</strong>ï¼šä¾‹å¦‚ï¼Œçº¿ç¨‹è®¤ä¸ºé˜Ÿåˆ—éç©ºï¼Œç»“æœå»å–å…ƒç´ æ—¶å‘ç°æ˜¯ç©ºçš„ï¼Œå¯¼è‡´æœªå®šä¹‰è¡Œä¸ºã€‚</li>
</ul>
<h3 id="å¦‚ä½•é¿å…ä¼ªå”¤é†’ï¼Ÿâ€”â€”-æ­£ç¡®çš„ä½¿ç”¨æ¨¡å¼"><a href="#å¦‚ä½•é¿å…ä¼ªå”¤é†’ï¼Ÿâ€”â€”-æ­£ç¡®çš„ä½¿ç”¨æ¨¡å¼" class="headerlink" title="å¦‚ä½•é¿å…ä¼ªå”¤é†’ï¼Ÿâ€”â€” æ­£ç¡®çš„ä½¿ç”¨æ¨¡å¼"></a>å¦‚ä½•é¿å…ä¼ªå”¤é†’ï¼Ÿâ€”â€” æ­£ç¡®çš„ä½¿ç”¨æ¨¡å¼</h3><p>è§£å†³æ–¹æ¡ˆéå¸¸ç®€å•å’Œå›ºå®šï¼š<strong>æ°¸è¿œä¸è¦åœ¨æ¡ä»¶å˜é‡ä¸Šä½¿ç”¨ç®€å•çš„ <code>if</code> è¯­å¥æ¥æ£€æŸ¥æ¡ä»¶ï¼Œè€Œå¿…é¡»ä½¿ç”¨ <code>while</code> å¾ªç¯ã€‚</strong></p>
<p>è¿™æ˜¯å› ä¸º <code>while</code> å¾ªç¯å¯ä»¥åœ¨çº¿ç¨‹è¢«å”¤é†’åï¼Œ<strong>å†æ¬¡æ£€æŸ¥æ¡ä»¶æ˜¯å¦çœŸæ­£æ»¡è¶³</strong>ã€‚å¦‚æœå‘ç”Ÿäº†ä¼ªå”¤é†’ï¼Œæ¡ä»¶ä¾ç„¶ä¸æˆç«‹ï¼Œçº¿ç¨‹ä¼šè‡ªåŠ¨å†æ¬¡è¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚</p>
<h4 id="é”™è¯¯ç¤ºä¾‹ï¼ˆä½¿ç”¨-ifï¼Œæ˜“å—ä¼ªå”¤é†’å½±å“ï¼‰"><a href="#é”™è¯¯ç¤ºä¾‹ï¼ˆä½¿ç”¨-ifï¼Œæ˜“å—ä¼ªå”¤é†’å½±å“ï¼‰" class="headerlink" title="é”™è¯¯ç¤ºä¾‹ï¼ˆä½¿ç”¨ ifï¼Œæ˜“å—ä¼ªå”¤é†’å½±å“ï¼‰"></a>é”™è¯¯ç¤ºä¾‹ï¼ˆä½¿ç”¨ <code>if</code>ï¼Œæ˜“å—ä¼ªå”¤é†’å½±å“ï¼‰</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// é”™è¯¯çš„å†™æ³•ï¼</span><br><span class="line">std::unique_lock&lt;std::mutex&gt; lock(mutex);</span><br><span class="line">// æ£€æŸ¥æ¡ä»¶</span><br><span class="line">if (queue.empty()) &#123; // ä½¿ç”¨ if æ˜¯å±é™©çš„</span><br><span class="line">    cond_var.wait(lock);</span><br><span class="line">&#125;</span><br><span class="line">// è¢«å”¤é†’åï¼Œç›´æ¥ä½¿ç”¨èµ„æºï¼ˆæ­¤æ—¶é˜Ÿåˆ—å¯èƒ½ä»ç„¶æ˜¯ç©ºçš„ï¼ï¼‰</span><br><span class="line">auto item = queue.front();</span><br><span class="line">queue.pop();</span><br></pre></td></tr></table></figure>

<h4 id="æ­£ç¡®ç¤ºä¾‹ï¼ˆä½¿ç”¨-whileï¼Œé˜²æ­¢ä¼ªå”¤é†’ï¼‰"><a href="#æ­£ç¡®ç¤ºä¾‹ï¼ˆä½¿ç”¨-whileï¼Œé˜²æ­¢ä¼ªå”¤é†’ï¼‰" class="headerlink" title="æ­£ç¡®ç¤ºä¾‹ï¼ˆä½¿ç”¨ whileï¼Œé˜²æ­¢ä¼ªå”¤é†’ï¼‰"></a>æ­£ç¡®ç¤ºä¾‹ï¼ˆä½¿ç”¨ <code>while</code>ï¼Œé˜²æ­¢ä¼ªå”¤é†’ï¼‰</h4><p>è¿™æ˜¯å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­çš„æ ‡å‡†èŒƒå¼ã€‚</p>
<p>cpp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">std::unique_lock&lt;std::mutex&gt; lock(mutex);</span><br><span class="line">// ä½¿ç”¨ while å¾ªç¯æ£€æŸ¥æ¡ä»¶</span><br><span class="line">while (queue.empty()) &#123; // æ­£ç¡®ï¼šä½¿ç”¨ while</span><br><span class="line">    cond_var.wait(lock); // 1. é‡Šæ”¾é”ï¼Œè¿›å…¥ç­‰å¾…</span><br><span class="line">                         // 2. è¢«å”¤é†’æ—¶ï¼Œä¼šé‡æ–°è·å–é”</span><br><span class="line">                         // 3. è·³å‡º wait åï¼Œå†æ¬¡æ£€æŸ¥ while æ¡ä»¶</span><br><span class="line">&#125;</span><br><span class="line">// èƒ½æ‰§è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜é˜Ÿåˆ—ä¸€å®šéç©º</span><br><span class="line">auto item = queue.front();</span><br><span class="line">queue.pop();</span><br></pre></td></tr></table></figure>



<p><strong>æµç¨‹è§£é‡Šï¼š</strong></p>
<ol>
<li>çº¿ç¨‹è·å–äº’æ–¥é”ï¼Œæ£€æŸ¥ <code>queue.empty()</code> æ˜¯å¦ä¸º <code>true</code>ã€‚</li>
<li>å¦‚æœæ˜¯ï¼Œåˆ™è°ƒç”¨ <code>cond_var.wait(lock)</code>ã€‚è¿™ä¸ªè°ƒç”¨ä¼š<strong>åŸå­åœ°</strong>é‡Šæ”¾äº’æ–¥é”ï¼Œå¹¶å°†çº¿ç¨‹æŒ‚èµ·ã€‚</li>
<li>å½“æœ‰å…¶ä»–çº¿ç¨‹å‘æ¡ä»¶å˜é‡å‘å‡ºé€šçŸ¥ï¼Œ<strong>æˆ–è€…å‘ç”Ÿä¼ªå”¤é†’</strong>æ—¶ï¼Œçº¿ç¨‹ä¼šä» <code>wait</code> ä¸­è¿”å›ã€‚åœ¨è¿”å›ä¹‹å‰ï¼Œå®ƒä¼š<strong>é‡æ–°è·å–äº’æ–¥é”</strong>ã€‚</li>
<li>ç”±äºæˆ‘ä»¬ä½¿ç”¨ <code>while</code> å¾ªç¯ï¼Œçº¿ç¨‹ä¼šç«‹åˆ»å†æ¬¡æ£€æŸ¥ <code>queue.empty()</code>ã€‚<ul>
<li><strong>å¦‚æœæ˜¯çœŸé€šçŸ¥</strong>ï¼šå¦ä¸€ä¸ªçº¿ç¨‹å·²ç»å°†æ•°æ®æ”¾å…¥é˜Ÿåˆ—ï¼Œ<code>queue.empty()</code> ä¸º <code>false</code>ï¼Œå¾ªç¯ç»“æŸï¼Œçº¿ç¨‹å®‰å…¨åœ°å¤„ç†æ•°æ®ã€‚</li>
<li><strong>å¦‚æœæ˜¯ä¼ªå”¤é†’</strong>ï¼š<code>queue.empty()</code> ä»ç„¶ä¸º <code>true</code>ï¼Œå¾ªç¯ç»§ç»­ï¼Œçº¿ç¨‹å†æ¬¡è°ƒç”¨ <code>wait</code> è¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚</li>
</ul>
</li>
</ol>
<h3 id="C-çš„è¿›ä¸€æ­¥ç®€åŒ–ï¼šå¸¦è°“è¯çš„-wait"><a href="#C-çš„è¿›ä¸€æ­¥ç®€åŒ–ï¼šå¸¦è°“è¯çš„-wait" class="headerlink" title="C++ çš„è¿›ä¸€æ­¥ç®€åŒ–ï¼šå¸¦è°“è¯çš„ wait"></a>C++ çš„è¿›ä¸€æ­¥ç®€åŒ–ï¼šå¸¦è°“è¯çš„ <code>wait</code></h3><p>ä¸ºäº†ç®€åŒ–ä»£ç ï¼ŒC++ æ ‡å‡†åº“æä¾›äº†å¯ä»¥æ¥å—ä¸€ä¸ªâ€œè°“è¯â€ï¼ˆä¸€ä¸ªå¯è°ƒç”¨å¯¹è±¡ï¼Œè¿”å›å¸ƒå°”å€¼ï¼‰çš„ <code>wait</code> é‡è½½ç‰ˆæœ¬ã€‚è¿™ä¸ªç‰ˆæœ¬åœ¨å†…éƒ¨è‡ªåŠ¨ä¸ºæˆ‘ä»¬å®ç°äº† <code>while</code> å¾ªç¯ã€‚</p>
<p>ä¸Šé¢çš„æ­£ç¡®ç¤ºä¾‹å¯ä»¥ç®€å†™ä¸ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">std::unique_lock&lt;std::mutex&gt; lock(mutex);</span><br><span class="line">// wait çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ lockï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ª lambda å‡½æ•°ä½œä¸ºè°“è¯</span><br><span class="line">cond_var.wait(lock, []&#123; return !queue.empty(); &#125;);</span><br><span class="line">// å½“æ‰§è¡Œåˆ°è¿™é‡Œæ—¶ï¼Œé˜Ÿåˆ—ä¸€å®šéç©º</span><br><span class="line">auto item = queue.front();</span><br><span class="line">queue.pop();</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ª <code>wait(lock, predicate)</code> çš„å†…éƒ¨é€»è¾‘ç­‰ä»·äºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">while (!predicate()) &#123;</span><br><span class="line">    wait(lock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ol>
<li><strong>ä¼ªå”¤é†’æ˜¯ä»€ä¹ˆ</strong>ï¼šæ²¡æœ‰æ”¶åˆ°é€šçŸ¥å°±è‡ªè¡Œå”¤é†’çš„çº¿ç¨‹ã€‚</li>
<li><strong>ä¸ºä»€ä¹ˆå­˜åœ¨</strong>ï¼šå‡ºäºæ€§èƒ½å’Œå®ç°å¤æ‚åº¦çš„è€ƒè™‘ï¼Œæ ‡å‡†å…è®¸å…¶å‘ç”Ÿã€‚</li>
<li><strong>æ ¸å¿ƒå¯¹ç­–</strong>ï¼š<strong>æ°¸è¿œä½¿ç”¨ <code>while</code> å¾ªç¯</strong>æ¥æ£€æŸ¥æ¡ä»¶ï¼Œè€Œä¸æ˜¯ <code>if</code> è¯­å¥ã€‚</li>
<li><strong>æœ€ä½³å®è·µ</strong>ï¼šåœ¨ C++ ä¸­ï¼Œä¼˜å…ˆä½¿ç”¨ <code>condition_variable::wait</code> å¸¦è°“è¯çš„ç‰ˆæœ¬ï¼Œå®ƒæ›´ç®€æ´ã€æ›´å®‰å…¨ã€‚</li>
</ol>
<p>è®°ä½è¿™ä¸ªé»„é‡‘æ³•åˆ™ï¼š<strong>æ¡ä»¶å˜é‡çš„ç­‰å¾…å¿…é¡»åœ¨ä¸€ä¸ªå¾ªç¯ä¸­ã€‚</strong> è¿™æ˜¯ç¼–å†™æ­£ç¡®ã€å¥å£®çš„å¤šçº¿ç¨‹ä»£ç çš„åŸºçŸ³ä¹‹ä¸€</p>
<p>æ¥ä¸‹æ¥æ˜¯futureå’Œasync</p>
<p>std::future&lt;&gt;è¿™é‡Œçš„æ¨¡æ¿å‡½æ•°ç­¾åè¡¨ç¤ºå¼‚æ­¥è¿›è¡Œçš„ä»»åŠ¡çš„è¿”å›å€¼ç±»å‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">æ‰€ä»¥å…¶å®æˆ‘ä»¬å¯ä»¥ç”¨autoè‡ªåŠ¨æ¨å¯¼ï¼ˆå¤ªå¥½ç”¨äº†å®¶äººä»¬ï¼‰</span><br><span class="line">å¦‚æœasyncä½¿ç”¨é»˜è®¤çš„å‚æ•°ï¼Œå³åªä¼ å…¥ä¸€ä¸ªå‡½æ•°ï¼Œä¼šå‡ºç°ä¸‹é¢çš„æƒ…å†µ</span><br><span class="line">// é»˜è®¤ç­–ç•¥ï¼šå¯èƒ½æ˜¯ async | deferred</span><br><span class="line">auto future = std::async(heavy_computation);</span><br><span class="line"></span><br><span class="line">// è¿™å…è®¸å®ç°é€‰æ‹©ç­–ç•¥ï¼š</span><br><span class="line">// - å¯èƒ½ç«‹å³åœ¨æ–°çº¿ç¨‹æ‰§è¡Œ</span><br><span class="line">// - ä¹Ÿå¯èƒ½å»¶è¿Ÿåˆ°get()æ—¶æ‰§è¡Œ</span><br><span class="line">// å› æ­¤ä¸è¦ä¾èµ–é»˜è®¤ç­–ç•¥çš„ç‰¹å®šè¡Œä¸ºï¼</span><br><span class="line">å¦‚æœä½¿ç”¨std::lanuch::asyncï¼Œå°±ä¼šåœ¨å½“åœºåˆ›å»ºä¸€ä¸ªå¹¶è¡Œçº¿ç¨‹ï¼Œç„¶ååœ¨åå°æ‰§è¡Œå‡½æ•°</span><br><span class="line">å¦‚æœä½¿ç”¨std::lanuch::deferred,é‚£ä¹ˆä¸ä¼šåˆ›å»ºä¸€ä¸ªå¹¶è¡Œçº¿ç¨‹ï¼Œè€Œæ˜¯åœ¨åŸçº¿ç¨‹é˜»å¡æ‰§è¡Œï¼Œé€‚åˆå°ä»»åŠ¡</span><br></pre></td></tr></table></figure>

<p><code>std::future</code>ã€<code>std::shared_future</code> å’Œ <code>std::async</code> â€”â€”<br>æ˜¯ C++11 å¼•å…¥çš„<strong>å¼‚æ­¥ä»»åŠ¡ä¸ç»“æœé€šä¿¡æœºåˆ¶</strong>çš„æ ¸å¿ƒã€‚  </p>
<hr>
<h2 id="ğŸ§©-ä¸€ã€std-future-æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#ğŸ§©-ä¸€ã€std-future-æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="ğŸ§© ä¸€ã€std::future æ˜¯ä»€ä¹ˆï¼Ÿ"></a>ğŸ§© ä¸€ã€<code>std::future</code> æ˜¯ä»€ä¹ˆï¼Ÿ</h2><h3 id="ğŸŒ±-å®šä¹‰"><a href="#ğŸŒ±-å®šä¹‰" class="headerlink" title="ğŸŒ± å®šä¹‰"></a>ğŸŒ± å®šä¹‰</h3><p><code>std::future&lt;T&gt;</code> æ˜¯ä¸€ä¸ª<strong>æœªæ¥ç»“æœçš„å ä½ç¬¦</strong>ï¼Œ<br>ç”¨æ¥åœ¨<strong>å¼‚æ­¥ä»»åŠ¡å’Œä¸»çº¿ç¨‹ä¹‹é—´ä¼ é€’ç»“æœ</strong>ã€‚</p>
<blockquote>
<p>å¯ä»¥ç†è§£ä¸ºï¼šæˆ‘ç°åœ¨æ²¡æœ‰ç»“æœï¼Œä½†æˆ‘å°†æ¥èƒ½æ‹¿åˆ°ã€‚</p>
</blockquote>
<hr>
<h3 id="ğŸ§ -ä½¿ç”¨åœºæ™¯"><a href="#ğŸ§ -ä½¿ç”¨åœºæ™¯" class="headerlink" title="ğŸ§  ä½¿ç”¨åœºæ™¯"></a>ğŸ§  ä½¿ç”¨åœºæ™¯</h3><ul>
<li>åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­å¯åŠ¨ä»»åŠ¡ï¼›</li>
<li>è¿”å›ä¸€ä¸ª <code>future</code>ï¼›</li>
<li>ä¸»çº¿ç¨‹ç¨åé€šè¿‡ <code>future.get()</code> è·å–ä»»åŠ¡ç»“æœã€‚</li>
</ul>
<hr>
<h3 id="âœ…-åŸºæœ¬ç”¨æ³•ç¤ºä¾‹"><a href="#âœ…-åŸºæœ¬ç”¨æ³•ç¤ºä¾‹" class="headerlink" title="âœ… åŸºæœ¬ç”¨æ³•ç¤ºä¾‹"></a>âœ… åŸºæœ¬ç”¨æ³•ç¤ºä¾‹</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;future&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Computing...\n&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">42</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::future&lt;<span class="type">int</span>&gt; fut = std::<span class="built_in">async</span>(std::launch::async, compute);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯ä»¥åšå…¶ä»–äº‹...</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Main thread working...\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> result = fut.<span class="built_in">get</span>(); <span class="comment">// é˜»å¡ç­‰å¾…ç»“æœ</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Result: &quot;</span> &lt;&lt; result &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>è§£é‡Šï¼š</strong></p>
<ul>
<li><code>std::async</code> å¯åŠ¨äº†ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡ï¼ˆå¯èƒ½æ˜¯æ–°çº¿ç¨‹ï¼‰ï¼›</li>
<li>è¿”å›ä¸€ä¸ª <code>std::future&lt;int&gt;</code>ï¼›</li>
<li>è°ƒç”¨ <code>fut.get()</code> ä¼šé˜»å¡ï¼Œç›´åˆ° <code>compute()</code> æ‰§è¡Œå®Œæ¯•ï¼›</li>
<li><code>get()</code> åªèƒ½è°ƒç”¨ä¸€æ¬¡ï¼</li>
</ul>
<hr>
<h3 id="âš ï¸-æ³¨æ„äº‹é¡¹"><a href="#âš ï¸-æ³¨æ„äº‹é¡¹" class="headerlink" title="âš ï¸ æ³¨æ„äº‹é¡¹"></a>âš ï¸ æ³¨æ„äº‹é¡¹</h3><ul>
<li><code>future.get()</code> è°ƒç”¨ä¸€æ¬¡åï¼Œç»“æœè¢«<strong>å–èµ°</strong>ï¼Œä¸èƒ½å†ç”¨ï¼›</li>
<li>å¦‚æœä¸è°ƒç”¨ <code>get()</code> å°±é”€æ¯äº† futureï¼Œç¨‹åºåœ¨æŸäº›å®ç°ä¸‹å¯èƒ½é˜»å¡ï¼ˆç­‰å¾…ä»»åŠ¡å®Œæˆï¼‰ã€‚</li>
</ul>
<hr>
<h2 id="ğŸŒ¿-äºŒã€std-shared-future-â€”â€”-å¯å…±äº«çš„-future"><a href="#ğŸŒ¿-äºŒã€std-shared-future-â€”â€”-å¯å…±äº«çš„-future" class="headerlink" title="ğŸŒ¿ äºŒã€std::shared_future â€”â€” å¯å…±äº«çš„ future"></a>ğŸŒ¿ äºŒã€<code>std::shared_future</code> â€”â€” å¯å…±äº«çš„ future</h2><p><code>std::future</code> çš„ç»“æœåªèƒ½å–ä¸€æ¬¡ï¼Œè¿™åœ¨æŸäº›æƒ…å†µä¸‹ä¸æ–¹ä¾¿ã€‚<br>ä¾‹å¦‚å¤šä¸ªçº¿ç¨‹éƒ½æƒ³è¯»å–åŒä¸€ä¸ªå¼‚æ­¥ç»“æœã€‚</p>
<p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒC++11 æä¾›äº† <code>std::shared_future</code>ã€‚</p>
<hr>
<h3 id="âœ…-åŸºæœ¬ç”¨æ³•"><a href="#âœ…-åŸºæœ¬ç”¨æ³•" class="headerlink" title="âœ… åŸºæœ¬ç”¨æ³•"></a>âœ… åŸºæœ¬ç”¨æ³•</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;future&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Computing...\n&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">42</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::future&lt;<span class="type">int</span>&gt; fut = std::<span class="built_in">async</span>(std::launch::async, compute);</span><br><span class="line">    std::shared_future&lt;<span class="type">int</span>&gt; sfut = fut.<span class="built_in">share</span>(); <span class="comment">// å…±äº« future</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> worker = [sfut]() &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Result = &quot;</span> &lt;&lt; sfut.<span class="built_in">get</span>() &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function">std::thread <span class="title">t1</span><span class="params">(worker)</span></span>;</span><br><span class="line">    <span class="function">std::thread <span class="title">t2</span><span class="params">(worker)</span></span>;</span><br><span class="line"></span><br><span class="line">    t<span class="number">1.</span><span class="built_in">join</span>();</span><br><span class="line">    t<span class="number">2.</span><span class="built_in">join</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>è§£é‡Šï¼š</strong></p>
<ul>
<li><code>std::future&lt;int&gt;::share()</code> â†’ è½¬æ¢ä¸º <code>std::shared_future&lt;int&gt;</code>ï¼›</li>
<li>å¤šä¸ªçº¿ç¨‹éƒ½å¯ä»¥è°ƒç”¨ <code>sfut.get()</code>ï¼›</li>
<li><code>shared_future</code> å†…éƒ¨æœ‰å¼•ç”¨è®¡æ•°ï¼›</li>
<li>ç»“æœç¼“å­˜ä¸‹æ¥ï¼Œ<strong>ä¸ä¼šè¢«â€œå–èµ°â€</strong>ã€‚</li>
</ul>
<hr>
<h3 id="âš™ï¸-åŒºåˆ«æ€»ç»“"><a href="#âš™ï¸-åŒºåˆ«æ€»ç»“" class="headerlink" title="âš™ï¸ åŒºåˆ«æ€»ç»“"></a>âš™ï¸ åŒºåˆ«æ€»ç»“</h3><table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th><code>std::future</code></th>
<th><code>std::shared_future</code></th>
</tr>
</thead>
<tbody><tr>
<td>è·å–ç»“æœæ–¹å¼</td>
<td><code>get()</code> ä¸€æ¬¡æ€§å–èµ°</td>
<td><code>get()</code> å¯å¤šæ¬¡è¯»å–</td>
</tr>
<tr>
<td>æ‹·è´</td>
<td>ä¸å¯æ‹·è´</td>
<td>å¯æ‹·è´ï¼ˆå¼•ç”¨è®¡æ•°ï¼‰</td>
</tr>
<tr>
<td>çº¿ç¨‹å®‰å…¨</td>
<td>åªèƒ½å•çº¿ç¨‹å–ç»“æœ</td>
<td>å¤šçº¿ç¨‹å¯åŒæ—¶å–ç»“æœ</td>
</tr>
<tr>
<td>å…¸å‹ç”¨é€”</td>
<td>å•æ¶ˆè´¹è€…</td>
<td>å¤šæ¶ˆè´¹è€…ï¼ˆå¹¿æ’­ç»“æœï¼‰</td>
</tr>
</tbody></table>
<hr>
<h2 id="ğŸš€-ä¸‰ã€std-async-â€”â€”-å¼‚æ­¥ä»»åŠ¡å¯åŠ¨å™¨"><a href="#ğŸš€-ä¸‰ã€std-async-â€”â€”-å¼‚æ­¥ä»»åŠ¡å¯åŠ¨å™¨" class="headerlink" title="ğŸš€ ä¸‰ã€std::async â€”â€” å¼‚æ­¥ä»»åŠ¡å¯åŠ¨å™¨"></a>ğŸš€ ä¸‰ã€<code>std::async</code> â€”â€” å¼‚æ­¥ä»»åŠ¡å¯åŠ¨å™¨</h2><p><code>std::async</code> æ˜¯æœ€å¸¸ç”¨çš„å¼‚æ­¥æ‰§è¡Œå‡½æ•°ã€‚<br>å®ƒè¿”å›ä¸€ä¸ª <code>std::future&lt;T&gt;</code>ï¼Œä»£è¡¨ä»»åŠ¡çš„æœ€ç»ˆç»“æœã€‚</p>
<hr>
<h3 id="âœ…-åŸºæœ¬è¯­æ³•"><a href="#âœ…-åŸºæœ¬è¯­æ³•" class="headerlink" title="âœ… åŸºæœ¬è¯­æ³•"></a>âœ… åŸºæœ¬è¯­æ³•</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">std::future&lt;T&gt; <span class="title">std::async</span><span class="params">(std::launch policy, Callable&amp;&amp; f, Args&amp;&amp;... args)</span></span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>f</code>ï¼šè¦æ‰§è¡Œçš„å‡½æ•°ï¼›</li>
<li><code>args...</code>ï¼šä¼ é€’ç»™å‡½æ•°çš„å‚æ•°ï¼›</li>
<li><code>policy</code>ï¼šæ‰§è¡Œç­–ç•¥ã€‚</li>
</ul>
<hr>
<h3 id="ğŸ”§-å¯åŠ¨ç­–ç•¥ï¼ˆpolicyï¼‰"><a href="#ğŸ”§-å¯åŠ¨ç­–ç•¥ï¼ˆpolicyï¼‰" class="headerlink" title="ğŸ”§ å¯åŠ¨ç­–ç•¥ï¼ˆpolicyï¼‰"></a>ğŸ”§ å¯åŠ¨ç­–ç•¥ï¼ˆpolicyï¼‰</h3><table>
<thead>
<tr>
<th>ç­–ç•¥</th>
<th>å«ä¹‰</th>
</tr>
</thead>
<tbody><tr>
<td><code>std::launch::async</code></td>
<td>ç«‹å³å¯åŠ¨ä¸€ä¸ªæ–°çº¿ç¨‹æ‰§è¡Œä»»åŠ¡</td>
</tr>
<tr>
<td><code>std::launch::deferred</code></td>
<td>å»¶è¿Ÿæ‰§è¡Œï¼Œç›´åˆ°è°ƒç”¨ <code>.get()</code> æˆ– <code>.wait()</code> æ—¶æ‰æ‰§è¡Œ</td>
</tr>
<tr>
<td>&#96;std::launch::async</td>
<td>std::launch::deferred&#96;</td>
</tr>
</tbody></table>
<hr>
<h3 id="ğŸŒŠ-ç¤ºä¾‹-1ï¼šç»“åˆ-shared-future"><a href="#ğŸŒŠ-ç¤ºä¾‹-1ï¼šç»“åˆ-shared-future" class="headerlink" title="ğŸŒŠ ç¤ºä¾‹ 1ï¼šç»“åˆ shared_future"></a>ğŸŒŠ ç¤ºä¾‹ 1ï¼šç»“åˆ <code>shared_future</code></h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">std::shared_future&lt;<span class="type">int</span>&gt; sfut = std::<span class="built_in">async</span>(std::launch::async, add, <span class="number">10</span>, <span class="number">20</span>).<span class="built_in">share</span>();</span><br><span class="line"></span><br><span class="line"><span class="function">std::thread <span class="title">t1</span><span class="params">([sfut]() &#123; std::cout &lt;&lt; <span class="string">&quot;T1: &quot;</span> &lt;&lt; sfut.get() &lt;&lt; <span class="string">&quot;\n&quot;</span>; &#125;)</span></span>;</span><br><span class="line"><span class="function">std::thread <span class="title">t2</span><span class="params">([sfut]() &#123; std::cout &lt;&lt; <span class="string">&quot;T2: &quot;</span> &lt;&lt; sfut.get() &lt;&lt; <span class="string">&quot;\n&quot;</span>; &#125;)</span></span>;</span><br><span class="line"></span><br><span class="line">t<span class="number">1.</span><span class="built_in">join</span>();</span><br><span class="line">t<span class="number">2.</span><span class="built_in">join</span>();</span><br></pre></td></tr></table></figure>

<p>å¤šä¸ªçº¿ç¨‹éƒ½å¯ä»¥å®‰å…¨åœ°è·å–ç»“æœã€‚</p>
<hr>
<h2 id="ğŸ§ -å››ã€å…¶å®ƒå®ç”¨æ“ä½œ"><a href="#ğŸ§ -å››ã€å…¶å®ƒå®ç”¨æ“ä½œ" class="headerlink" title="ğŸ§  å››ã€å…¶å®ƒå®ç”¨æ“ä½œ"></a>ğŸ§  å››ã€å…¶å®ƒå®ç”¨æ“ä½œ</h2><h3 id="future-wait"><a href="#future-wait" class="headerlink" title="future.wait()"></a><code>future.wait()</code></h3><p>åªç­‰å¾…ç»“æœå¯ç”¨ï¼Œä¸å–ç»“æœã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fut.<span class="built_in">wait</span>();</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;Task done\n&quot;</span>;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="âš ï¸-äº”ã€å¸¸è§å‘ç‚¹"><a href="#âš ï¸-äº”ã€å¸¸è§å‘ç‚¹" class="headerlink" title="âš ï¸ äº”ã€å¸¸è§å‘ç‚¹"></a>âš ï¸ äº”ã€å¸¸è§å‘ç‚¹</h2><ol>
<li><p><strong><code>future.get()</code> åªèƒ½è°ƒç”¨ä¸€æ¬¡</strong></p>
<ul>
<li>è°ƒç”¨åç»“æœè¢«â€œå–èµ°â€ï¼Œfuture å¤±æ•ˆï¼›</li>
<li>å¦‚æœå¤šçº¿ç¨‹éƒ½éœ€è¦ç»“æœï¼Œè¯·ä½¿ç”¨ <code>shared_future</code>ã€‚</li>
</ul>
</li>
<li><p><strong><code>async</code> é»˜è®¤ç­–ç•¥å¯èƒ½ä¸ä¸€å®šå¼€çº¿ç¨‹</strong></p>
<ul>
<li>å¦‚æœæ²¡æœ‰æ˜ç¡®æŒ‡å®š <code>std::launch::async</code>ï¼Œå¯èƒ½ä¼šå»¶è¿Ÿæ‰§è¡Œï¼›</li>
<li>è¦å¼ºåˆ¶å¼€çº¿ç¨‹ï¼Œè¯·æŒ‡å®šç­–ç•¥ã€‚</li>
</ul>
</li>
<li><p><strong>å¼‚å¸¸ä¼šè‡ªåŠ¨ä¼ æ’­</strong></p>
<ul>
<li>å¦‚æœå¼‚æ­¥ä»»åŠ¡æŠ›å‡ºå¼‚å¸¸ï¼Œè°ƒç”¨ <code>.get()</code> æ—¶ä¼šé‡æ–°æŠ›å‡ºï¼›</li>
<li>è¦åœ¨ <code>.get()</code> å¤–å±‚æ•è·ã€‚</li>
</ul>
</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> fut = std::<span class="built_in">async</span>([]() &#123; <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;Error&quot;</span>); &#125;);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    fut.<span class="built_in">get</span>();</span><br><span class="line">&#125; <span class="built_in">catch</span> (<span class="type">const</span> std::exception&amp; e) &#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Caught: &quot;</span> &lt;&lt; e.<span class="built_in">what</span>() &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="ğŸ§­-å…­ã€æ€»ç»“å¯¹æ¯”è¡¨"><a href="#ğŸ§­-å…­ã€æ€»ç»“å¯¹æ¯”è¡¨" class="headerlink" title="ğŸ§­ å…­ã€æ€»ç»“å¯¹æ¯”è¡¨"></a>ğŸ§­ å…­ã€æ€»ç»“å¯¹æ¯”è¡¨</h2><table>
<thead>
<tr>
<th>åç§°</th>
<th>åŠŸèƒ½</th>
<th>å¯å…±äº«</th>
<th>å¤šçº¿ç¨‹å®‰å…¨</th>
<th>å¸¸ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody><tr>
<td><code>std::future&lt;T&gt;</code></td>
<td>å¼‚æ­¥ç»“æœå ä½ç¬¦</td>
<td>âŒ</td>
<td>âŒï¼ˆå•çº¿ç¨‹å–ç»“æœï¼‰</td>
<td>å•ä¸€æ¶ˆè´¹è€…å¼‚æ­¥ä»»åŠ¡</td>
</tr>
<tr>
<td><code>std::shared_future&lt;T&gt;</code></td>
<td>å¯å…±äº«ç»“æœ</td>
<td>âœ…</td>
<td>âœ…</td>
<td>å¤šçº¿ç¨‹å…±äº«ç»“æœ</td>
</tr>
<tr>
<td><code>std::async()</code></td>
<td>å¯åŠ¨å¼‚æ­¥ä»»åŠ¡å¹¶è¿”å› <code>future</code></td>
<td>-</td>
<td>-</td>
<td>å¿«é€Ÿå¼‚æ­¥æ‰§è¡Œä»»åŠ¡</td>
</tr>
</tbody></table>
<hr>
<p>âœ… <strong>ä¸€å¥è¯è®°å¿†ï¼š</strong></p>
<blockquote>
<p><code>std::async</code> å¯åŠ¨å¼‚æ­¥ä»»åŠ¡ï¼Œ<br><code>std::future</code> ç­‰å¾…å¹¶å–ä¸€æ¬¡ç»“æœï¼Œ<br><code>std::shared_future</code> å¯ä»¥è®©å¤šä¸ªçº¿ç¨‹å…±äº«è¿™ä¸ªç»“æœã€‚</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;type_traits&gt;</span><br><span class="line">#include &lt;utility&gt;</span><br><span class="line"></span><br><span class="line">// C++17 é£æ ¼çš„æ”¹è¿› submit</span><br><span class="line">template&lt;typename F, typename... Args&gt;</span><br><span class="line">auto submit(F&amp;&amp; f, Args&amp;&amp;... args)</span><br><span class="line">&#123;</span><br><span class="line">    using return_type = std::invoke_result_t&lt;std::decay_t&lt;F&gt;, std::decay_t&lt;Args&gt;...&gt;;</span><br><span class="line"></span><br><span class="line">    // ç”¨ shared_ptr ç®¡ç† packaged_task çš„åŸå› å¦‚ä¸Š</span><br><span class="line">    auto task = std::make_shared&lt;std::packaged_task&lt;return_type()&gt;&gt;(</span><br><span class="line">        // lambda æŠŠ f å’Œ args å…¨éƒ¨ move è¿›æ¥ï¼Œé¿å… bind çš„æ‹·è´é—®é¢˜</span><br><span class="line">        [func = std::forward&lt;F&gt;(f), ... captured = std::forward&lt;Args&gt;(args)]() mutable -&gt; return_type &#123;</span><br><span class="line">            return std::invoke(func, std::move(captured)...);</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    std::future&lt;return_type&gt; fut = task-&gt;get_future();</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        std::lock_guard&lt;std::mutex&gt; lock(queueMutex);</span><br><span class="line">        tasks.emplace([task]()&#123; (*task)(); &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    condition.notify_one();</span><br><span class="line">    return fut;</span><br><span class="line">&#125;</span><br><span class="line">ä¸€ä¸ªå¼‚æ­¥çš„çº¿ç¨‹æ± ä¾‹å­</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;iostream&gt;</span><br><span class="line"></span><br><span class="line">int work(int x) &#123;</span><br><span class="line">    std::this_thread::sleep_for(std::chrono::seconds(1));</span><br><span class="line">    return x * 2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line">    ThreadPool pool(4);</span><br><span class="line"></span><br><span class="line">    std::future&lt;int&gt; fut = pool.submit(work, 10);</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; &quot;Main thread working...\n&quot;;</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; &quot;Result = &quot; &lt;&lt; fut.get() &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line">ä½¿ç”¨å®ä¾‹</span><br></pre></td></tr></table></figure>

<p>åœ¨è¿™é‡Œæˆ‘ä»¬è®¤è¯†äº†invoke,functionï¼Œpackaged_taskè¿™ä¸‰ä¸ªç›¸ä¼¼ä½†å®Œå…¨ä¸åŒçš„ä¸œè¥¿</p>
<h2 id="ä¸‰è€…çš„å…³ç³»å’ŒåŒºåˆ«"><a href="#ä¸‰è€…çš„å…³ç³»å’ŒåŒºåˆ«" class="headerlink" title="ä¸‰è€…çš„å…³ç³»å’ŒåŒºåˆ«"></a>ä¸‰è€…çš„å…³ç³»å’ŒåŒºåˆ«</h2><h3 id="å±‚æ¬¡å…³ç³»"><a href="#å±‚æ¬¡å…³ç³»" class="headerlink" title="å±‚æ¬¡å…³ç³»"></a>å±‚æ¬¡å…³ç³»</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">std::invoke (è°ƒç”¨å·¥å…·)</span><br><span class="line">    â†“</span><br><span class="line">std::function (åŒæ­¥åŒ…è£…å™¨)  </span><br><span class="line">    â†“</span><br><span class="line">std::packaged_task (å¼‚æ­¥åŒ…è£…å™¨ + future)</span><br></pre></td></tr></table></figure>

<h3 id="è¯¦ç»†å¯¹æ¯”"><a href="#è¯¦ç»†å¯¹æ¯”" class="headerlink" title="è¯¦ç»†å¯¹æ¯”"></a>è¯¦ç»†å¯¹æ¯”</h3><table>
<thead>
<tr>
<th align="left">ç‰¹æ€§</th>
<th align="left"><code>std::function</code></th>
<th align="left"><code>std::packaged_task</code></th>
<th align="left"><code>std::invoke</code></th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>ç”¨é€”</strong></td>
<td align="left">é€šç”¨å‡½æ•°åŒ…è£…</td>
<td align="left">å¼‚æ­¥ä»»åŠ¡åŒ…è£…</td>
<td align="left">ç»Ÿä¸€è°ƒç”¨æœºåˆ¶</td>
</tr>
<tr>
<td align="left"><strong>å­˜å‚¨</strong></td>
<td align="left">âœ… å¯ä»¥å­˜å‚¨å¯è°ƒç”¨å¯¹è±¡</td>
<td align="left">âœ… å¯ä»¥å­˜å‚¨å¯è°ƒç”¨å¯¹è±¡</td>
<td align="left">âŒ åªæ˜¯è°ƒç”¨å·¥å…·</td>
</tr>
<tr>
<td align="left"><strong>å¼‚æ­¥</strong></td>
<td align="left">âŒ åŒæ­¥è°ƒç”¨</td>
<td align="left">âœ… æ”¯æŒå¼‚æ­¥æ‰§è¡Œ</td>
<td align="left">âŒ åŒæ­¥è°ƒç”¨</td>
</tr>
<tr>
<td align="left"><strong>Future</strong></td>
<td align="left">âŒ æ— futureæ”¯æŒ</td>
<td align="left">âœ… å…³è”futureè·å–ç»“æœ</td>
<td align="left">âŒ æ— futureæ”¯æŒ</td>
</tr>
<tr>
<td align="left"><strong>æˆå‘˜å‡½æ•°</strong></td>
<td align="left">âŒ ä¸èƒ½ç›´æ¥åŒ…è£…</td>
<td align="left">âŒ ä¸èƒ½ç›´æ¥åŒ…è£…</td>
<td align="left">âœ… æ”¯æŒæˆå‘˜å‡½æ•°</td>
</tr>
<tr>
<td align="left"><strong>å¼€é”€</strong></td>
<td align="left">ä¸­ç­‰</td>
<td align="left">è¾ƒå¤§</td>
<td align="left">é›¶è¿è¡Œæ—¶å¼€é”€</td>
</tr>
</tbody></table>
<p>invokeçš„æœ¬è´¨æ˜¯å°†å‡½æ•°æŒ‡é’ˆï¼Œæˆå‘˜å‡½æ•°ç­‰ç‰¹æ®Šç±»å‹çš„å‡½æ•°è°ƒç”¨ç»Ÿä¸€ï¼Œæä¾›ä¸€ä¸ªç»Ÿä¸€çš„è°ƒç”¨æ–¹æ³•ï¼Œä½†æ˜¯æ˜¯ä¸€æ¬¡æ€§çš„ï¼ˆå¯ä»¥åœ¨ç¼–è¯‘æœŸå»æ¨æ–­è°ƒç”¨å‡½æ•°çš„è¿”å›å€¼ç±»å‹ï¼Œinvoke_result_tï¼Œå°±æ˜¯ä¸Šé¢çº¿ç¨‹æ± åšçš„)</p>
<p>è€Œfunctionæ˜¯ä¸€ç§å¯ä»¥å¤šæ¬¡è°ƒç”¨çš„invokeï¼Œæ‰€ä»¥è¦èµ·ä¸€ä¸ªåå­—</p>
<p>packaged_taskå°±æ˜¯æ”¯æŒå¼‚æ­¥è¿”å›å€¼çš„functionã€‚</p>
<p>packaged_taskçš„å†…éƒ¨æœ¬è´¨æ˜¯ä¸€ä¸ªpromise</p>
<h2 id="std-promiseï¼šä½ æ‰‹åŠ¨æä¾›ç»“æœ"><a href="#std-promiseï¼šä½ æ‰‹åŠ¨æä¾›ç»“æœ" class="headerlink" title="std::promiseï¼šä½ æ‰‹åŠ¨æä¾›ç»“æœ"></a>std::promiseï¼šä½ æ‰‹åŠ¨æä¾›ç»“æœ</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;future&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::promise&lt;<span class="type">int</span>&gt; prom;          <span class="comment">// åˆ›å»º promise</span></span><br><span class="line">    std::future&lt;<span class="type">int</span>&gt; fut = prom.<span class="built_in">get_future</span>();  <span class="comment">// è·å–å…³è”çš„ future</span></span><br><span class="line"></span><br><span class="line">    <span class="function">std::thread <span class="title">t</span><span class="params">([&amp;prom]() &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">        std::this_thread::sleep_for(std::chrono::seconds(<span class="number">1</span>));</span></span></span><br><span class="line"><span class="params"><span class="function">        prom.set_value(<span class="number">42</span>);          <span class="comment">// æ‰‹åŠ¨è®¾ç½®ç»“æœ</span></span></span></span><br><span class="line"><span class="params"><span class="function">    &#125;)</span></span>;</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; fut.<span class="built_in">get</span>() &lt;&lt; std::endl; <span class="comment">// é˜»å¡ç­‰å¾…ç»“æœ</span></span><br><span class="line">    t.<span class="built_in">join</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ğŸ”¹ç‰¹ç‚¹ï¼š</p>
<ul>
<li><code>promise</code> ä¸æ‰§è¡Œä»»ä½•å‡½æ•°ï¼›</li>
<li>ä½ å¿…é¡»åœ¨æŸä¸ªåœ°æ–¹**æ‰‹åŠ¨è°ƒç”¨ <code>set_value()</code>**ï¼›</li>
<li>é€‚åˆ<strong>çº¿ç¨‹ä¹‹é—´ä¼ é€’ç»“æœæˆ–ä¿¡å·</strong>ã€‚</li>
</ul>
<hr>
<h2 id="std-packaged-taskï¼šä»»åŠ¡è‡ªåŠ¨äº§ç”Ÿç»“æœ"><a href="#std-packaged-taskï¼šä»»åŠ¡è‡ªåŠ¨äº§ç”Ÿç»“æœ" class="headerlink" title="std::packaged_taskï¼šä»»åŠ¡è‡ªåŠ¨äº§ç”Ÿç»“æœ"></a><code>std::packaged_task</code>ï¼šä»»åŠ¡è‡ªåŠ¨äº§ç”Ÿç»“æœ</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;future&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">add</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> </span>&#123; <span class="keyword">return</span> a + b; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">std::packaged_task&lt;<span class="title">int</span><span class="params">(<span class="type">int</span>,<span class="type">int</span>)</span>&gt; <span class="title">task</span><span class="params">(add)</span></span>; <span class="comment">// æ‰“åŒ…å‡½æ•°</span></span><br><span class="line">    std::future&lt;<span class="type">int</span>&gt; fut = task.<span class="built_in">get_future</span>();</span><br><span class="line"></span><br><span class="line">    <span class="function">std::thread <span class="title">t</span><span class="params">(std::move(task), <span class="number">2</span>, <span class="number">3</span>)</span></span>; <span class="comment">// ä»»åŠ¡æ‰§è¡Œè‡ªåŠ¨å¡«å……ç»“æœ</span></span><br><span class="line">    std::cout &lt;&lt; fut.<span class="built_in">get</span>() &lt;&lt; std::endl;  <span class="comment">// è¾“å‡º 5</span></span><br><span class="line">    t.<span class="built_in">join</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ˜¾ç„¶promiseæ›´çµæ´»ï¼Œä½†packaged_taskæ›´æ–¹ä¾¿ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">template&lt;class F&gt;</span><br><span class="line">class packaged_task &#123;</span><br><span class="line">    std::promise&lt;return_type&gt; promise_; // å†…éƒ¨çš„ promise</span><br><span class="line">    F func_;</span><br><span class="line"></span><br><span class="line">public:</span><br><span class="line">    void operator()() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            promise_.set_value(func_()); // è‡ªåŠ¨è°ƒç”¨å¹¶è®¾ç½®ç»“æœ</span><br><span class="line">        &#125; catch (...) &#123;</span><br><span class="line">            promise_.set_exception(std::current_exception());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    std::future&lt;return_type&gt; get_future() &#123;</span><br><span class="line">        return promise_.get_future();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">ä¼ªä»£ç </span><br></pre></td></tr></table></figure>

<p>å¯¹äºpackaged_taskï¼š</p>
<ul>
<li>æ„é€ æ—¶ âŒ æ²¡æ‰§è¡Œ</li>
<li>get_future() âŒ æ²¡æ‰§è¡Œ</li>
<li>è°ƒç”¨ task() âœ… å¼€å§‹æ‰§è¡Œ</li>
<li>get() åªæ˜¯ç­‰å¾…ç»“æœå·²ç»å­˜åœ¨</li>
</ul>
<p>è¿™é‡Œæˆ‘ä»¬å¼•å…¥ä¸€ç‚¹çº¿ç¨‹æ± çš„åŸç†ï¼Œä¼—æ‰€å‘¨çŸ¥ï¼Œçº¿ç¨‹æ± éœ€è¦ä¸€ä¸ªä¸œè¥¿ï¼šç±»å‹æ“¦é™¤ï¼Œå³å°†æ— è®ºä»€ä¹ˆå‚æ•°ï¼Œä»€ä¹ˆè¿”å›å€¼çš„å‡½æ•°ï¼Œéƒ½ç”¨ç»Ÿä¸€çš„åŒ…è£…å’Œç»Ÿä¸€çš„è°ƒç”¨ã€‚</p>
<p>å¯¹äºæ— è¿”å›å€¼ï¼Œæœ‰å‚æ•°çš„å‡½æ•°ï¼Œæˆ‘ä»¬æœ€å…ˆè§åˆ°çš„å¾€å¾€æ˜¯bind(å‡½æ•°åï¼Œï¼ˆç±»çš„å®ä¾‹ï¼‰ï¼Œå‚æ•°1ï¼Œå‚æ•°2ï¼ŒArgsâ€¦)ï¼Œå¦‚æœå‚æ•°æš‚æ—¶ä¸å¯ç”¨ï¼Œå°±ç”¨å ä½ç¬¦ã€‚è¿™æ ·ï¼Œå‡½æ•°è¢«åŒ…è£…æˆä¸ºäº†function&lt;void()&gt;,æ— å‡½æ•°ç­¾åã€‚</p>
<p>å½“ç„¶ï¼Œlambdaè¿™ä¸ªè¯­æ³•ç³–ä¹Ÿå¯ä»¥åšåˆ°ï¼Œå…¶å€¼æ•è·å¯ä»¥ä»£æ›¿å‡½æ•°å‚æ•°</p>
<hr>
<h2 id="ğŸ§©-é—®é¢˜-1ï¼š"><a href="#ğŸ§©-é—®é¢˜-1ï¼š" class="headerlink" title="ğŸ§© é—®é¢˜ 1ï¼š"></a>ğŸ§© é—®é¢˜ 1ï¼š</h2><blockquote>
<p>â€œæ­£å¸¸æƒ…å†µä¸‹ packaged_task çš„å‡½æ•°ç­¾åéœ€è¦å‚æ•°ï¼Ÿ<br>ä½†æ˜¯ç”¨ lambda å»åˆå§‹åŒ–ï¼Œæ•è·å¯ä»¥ä»£æ›¿å‡½æ•°ç­¾åå‚æ•°ï¼Œæ˜¯è¿™ä¸ªæ„æ€å—ï¼Ÿâ€</p>
</blockquote>
<p>âœ… æ­£ç¡®</p>
<hr>
<h3 id="ğŸ§ -1ï¸âƒ£-std-packaged-task-çš„ç­¾å"><a href="#ğŸ§ -1ï¸âƒ£-std-packaged-task-çš„ç­¾å" class="headerlink" title="ğŸ§  1ï¸âƒ£ std::packaged_task çš„ç­¾å"></a>ğŸ§  1ï¸âƒ£ <code>std::packaged_task</code> çš„ç­¾å</h3><p><code>std::packaged_task&lt;R(Args...)&gt;</code> çš„æ¨¡æ¿å‚æ•° <code>Args...</code> å°±æ˜¯å®ƒè¦â€œæ¥å—çš„å‚æ•°åˆ—è¡¨â€ã€‚</p>
<p>ä¾‹å­ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">std::packaged_task&lt;<span class="title">int</span><span class="params">(<span class="type">int</span>,<span class="type">int</span>)</span>&gt; <span class="title">task</span><span class="params">([](<span class="type">int</span> a, <span class="type">int</span> b)&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">return</span> a + b;</span></span></span><br><span class="line"><span class="params"><span class="function">&#125;)</span></span>;</span><br><span class="line"><span class="built_in">task</span>(<span class="number">2</span>,<span class="number">3</span>);  <span class="comment">// ä¼ å‚æ•°æ‰§è¡Œ</span></span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œï¼š</p>
<ul>
<li><code>task</code> çš„ç±»å‹æ˜¯ <code>std::packaged_task&lt;int(int,int)&gt;</code></li>
<li>å®ƒçš„ <code>operator()(2,3)</code> ä¼šæŠŠå‚æ•°ä¼ é€’ç»™ lambdaã€‚</li>
</ul>
<hr>
<h3 id="ğŸ§©-2ï¸âƒ£-ä¸ºä»€ä¹ˆåœ¨ä½ çš„ä»£ç ä¸­å†™æˆäº†-std-packaged-task"><a href="#ğŸ§©-2ï¸âƒ£-ä¸ºä»€ä¹ˆåœ¨ä½ çš„ä»£ç ä¸­å†™æˆäº†-std-packaged-task" class="headerlink" title="ğŸ§© 2ï¸âƒ£ ä¸ºä»€ä¹ˆåœ¨ä½ çš„ä»£ç ä¸­å†™æˆäº† std::packaged_task&lt;return_type()&gt;"></a>ğŸ§© 2ï¸âƒ£ ä¸ºä»€ä¹ˆåœ¨ä½ çš„ä»£ç ä¸­å†™æˆäº† <code>std::packaged_task&lt;return_type()&gt;</code></h3><p>ä½ çš„ä»£ç é‡Œå†™çš„æ˜¯ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">std::packaged_task&lt;<span class="title">return_type</span><span class="params">()</span>&gt; <span class="title">task</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    [func = ..., ...captured = ...]() <span class="keyword">mutable</span> -&gt; return_type &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">return</span> std::invoke(func, std::move(captured)...);</span></span></span><br><span class="line"><span class="params"><span class="function">    &#125;</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>ğŸ‘‰ ä¹Ÿå°±æ˜¯è¯´ï¼š</p>
<ul>
<li><code>packaged_task</code> çš„ç­¾åæ˜¯ <strong>æ— å‚</strong> çš„ï¼›</li>
<li>ä½†æ˜¯è¿™ä¸ª lambda å†…éƒ¨<strong>æ•è·</strong>äº† <code>f</code> å’Œæ‰€æœ‰çš„ <code>args...</code>ï¼›</li>
<li>å½“è°ƒç”¨ <code>(*task)()</code> æ—¶ï¼Œè¿™ä¸ª lambda å†…éƒ¨æ‰§è¡Œï¼š<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">std::<span class="built_in">invoke</span>(func, std::<span class="built_in">move</span>(captured)...);</span><br></pre></td></tr></table></figure>
â€”â€” å®é™…ä¸Šå·²ç»ä½¿ç”¨äº†åŸæœ¬çš„ <code>args...</code>ã€‚</li>
</ul>
<hr>
<h3 id="âœ…-ç»“è®ºï¼š"><a href="#âœ…-ç»“è®ºï¼š" class="headerlink" title="âœ… ç»“è®ºï¼š"></a>âœ… ç»“è®ºï¼š</h3><blockquote>
<p>æ•è·ç¡®å®â€œæ›¿ä»£â€äº†å‡½æ•°ç­¾åçš„å‚æ•°ã€‚<br>å› ä¸ºå‚æ•°å€¼åœ¨åˆ›å»ºä»»åŠ¡æ—¶å°±è¢«æ‹·è´ï¼ˆæˆ–ç§»åŠ¨ï¼‰è¿›äº† lambda çš„é—­åŒ…ä½“ã€‚</p>
</blockquote>
<p>æ‰€ä»¥ï¼š</p>
<ul>
<li>å‡½æ•°ç­¾åå¯ä»¥æ˜¯ <code>()</code>ï¼Œå› ä¸ºè°ƒç”¨æ—¶ä¸å†éœ€è¦é¢å¤–çš„å‚æ•°ï¼›</li>
<li>æ‰€æœ‰å‚æ•°éƒ½åœ¨åˆ›å»ºæ—¶ç»‘å®šï¼ˆç±»ä¼¼äº <code>std::bind</code> çš„æ•ˆæœï¼Œä½†æ•ˆç‡æ›´é«˜ï¼‰ã€‚</li>
</ul>
<p>ğŸ“¦ <strong>æ€»ç»“ä¸€å¥è¯</strong>ï¼š</p>
<blockquote>
<p>åœ¨è¿™ä¸ªå†™æ³•é‡Œï¼Œ<code>lambda æ•è·</code> ç›¸å½“äºâ€œæå‰ç»‘å®šå‚æ•°â€ï¼Œ<br>å› æ­¤ <code>packaged_task</code> çš„ç­¾åå¯ä»¥æ˜¯ <code>()</code>ã€‚</p>
</blockquote>
<hr>
<h2 id="ğŸ§©-é—®é¢˜-2ï¼š"><a href="#ğŸ§©-é—®é¢˜-2ï¼š" class="headerlink" title="ğŸ§© é—®é¢˜ 2ï¼š"></a>ğŸ§© é—®é¢˜ 2ï¼š</h2><blockquote>
<p><code>[task]()&#123; (*task)(); &#125;</code> åœ¨æŒ‰å€¼æ•è·çš„æ—¶å€™æ‹·è´äº† shared_ptrï¼Œé‚£ä»–æ˜¯è¢«å†æ¬¡åŒ…è£…æˆäº† functionï¼Ÿ</p>
</blockquote>
<p>å®Œå…¨æ­£ç¡® âœ…âœ…âœ…<br>è¿™ä¸ªè¿‡ç¨‹å…¶å®å°±æ˜¯â€œç”¨ä¸€ä¸ªå° lambda åŒ…æˆ <code>std::function&lt;void()&gt;</code>â€ã€‚</p>
<hr>
<h3 id="ğŸ§ -1ï¸âƒ£-æ•è·è¡Œä¸º"><a href="#ğŸ§ -1ï¸âƒ£-æ•è·è¡Œä¸º" class="headerlink" title="ğŸ§  1ï¸âƒ£ æ•è·è¡Œä¸º"></a>ğŸ§  1ï¸âƒ£ æ•è·è¡Œä¸º</h3><p><code>[task]</code> æ˜¯ <strong>æŒ‰å€¼æ•è·</strong>ï¼Œ<br>è€Œ <code>task</code> æ˜¯ä¸€ä¸ª <code>std::shared_ptr&lt;std::packaged_task&lt;return_type()&gt;&gt;</code>ã€‚</p>
<p>æŒ‰å€¼æ•è· shared_ptrï¼Œä¼šå‘ç”Ÿï¼š</p>
<blockquote>
<p>æ‹·è´ shared_ptrï¼ˆå¼•ç”¨è®¡æ•° +1ï¼‰</p>
</blockquote>
<p>å› æ­¤ï¼š</p>
<ul>
<li>è¿™ä¸ª lambda å†…éƒ¨æœ‰è‡ªå·±çš„ shared_ptr å‰¯æœ¬ï¼›</li>
<li>å³ä½¿å¤–å±‚çš„ <code>task</code> ç¦»å¼€ä½œç”¨åŸŸé”€æ¯ï¼Œé˜Ÿåˆ—é‡Œçš„ lambda ä»ç„¶æŒæœ‰ä¸€ä»½ shared_ptr å¼•ç”¨ï¼Œä¿è¯å¯¹è±¡ä»ç„¶å­˜åœ¨ã€‚</li>
</ul>
<hr>
<h3 id="ğŸ§±-2ï¸âƒ£-lambda-è¢«å­˜è¿›-std-function"><a href="#ğŸ§±-2ï¸âƒ£-lambda-è¢«å­˜è¿›-std-function" class="headerlink" title="ğŸ§± 2ï¸âƒ£ lambda è¢«å­˜è¿› std::function&lt;void()&gt;"></a>ğŸ§± 2ï¸âƒ£ lambda è¢«å­˜è¿› <code>std::function&lt;void()&gt;</code></h3><p><code>tasks.emplace([task]()&#123; (*task)(); &#125;);</code></p>
<p>è¿™é‡Œå‡è®¾ <code>tasks</code> æ˜¯ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">std::queue&lt;std::function&lt;<span class="type">void</span>()&gt;&gt; tasks;</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆï¼š</p>
<ul>
<li><code>[task]()&#123; (*task)(); &#125;</code> æ˜¯ä¸€ä¸ªæ— å‚ã€æ— è¿”å›å€¼çš„ lambdaï¼›</li>
<li>å®ƒå¯ä»¥éšå¼è½¬æ¢æˆ <code>std::function&lt;void()&gt;</code>ï¼›</li>
<li>é˜Ÿåˆ—é‡Œå­˜æ”¾çš„æ˜¯ <code>std::function&lt;void()&gt;</code> ç±»å‹ï¼›</li>
<li>æ‰€ä»¥<strong>è¿™ä¸ª lambda è¢«å¤åˆ¶ä¸€ä»½å­˜å…¥ <code>std::function</code></strong> å¯¹è±¡ä¸­ã€‚</li>
</ul>
<hr>
<h3 id="âš™ï¸-3ï¸âƒ£-è°ƒç”¨é“¾"><a href="#âš™ï¸-3ï¸âƒ£-è°ƒç”¨é“¾" class="headerlink" title="âš™ï¸ 3ï¸âƒ£ è°ƒç”¨é“¾"></a>âš™ï¸ 3ï¸âƒ£ è°ƒç”¨é“¾</h3><p>å½“ worker çº¿ç¨‹æ‰§è¡Œä»»åŠ¡æ—¶ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">std::function&lt;<span class="type">void</span>()&gt; job = std::<span class="built_in">move</span>(tasks.<span class="built_in">front</span>());</span><br><span class="line"><span class="built_in">job</span>();  <span class="comment">// æ‰§è¡Œ</span></span><br></pre></td></tr></table></figure>

<p>å‘ç”Ÿçš„è°ƒç”¨é“¾ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">job()                     --&gt; è°ƒç”¨ std::function&lt;void()&gt;::operator()</span><br><span class="line">  â†“</span><br><span class="line">lambda()                  --&gt; è°ƒç”¨ [task]()&#123; (*task)(); &#125;</span><br><span class="line">  â†“</span><br><span class="line">(*task)()                 --&gt; è°ƒç”¨ packaged_task çš„ operator()</span><br><span class="line">  â†“</span><br><span class="line">æ‰§è¡Œæ•è·çš„ lambda         --&gt; æ‰§è¡ŒåŸå§‹ f(args...)</span><br><span class="line">  â†“</span><br><span class="line">packaged_task è®¾ç½®ç»“æœåˆ° future</span><br></pre></td></tr></table></figure>

<p>ğŸ¯ ä¸€æ•´æ¡è°ƒç”¨é“¾ä¸²èµ·æ¥ï¼Œæœªæ¥ç»“æœæœ€ç»ˆå‡ºç°åœ¨ <code>future.get()</code>ã€‚</p>
<hr>
<h2 id="ğŸ§ -å°ç»“ï¼šä¸¤æ®µçš„å…³ç³»å›¾"><a href="#ğŸ§ -å°ç»“ï¼šä¸¤æ®µçš„å…³ç³»å›¾" class="headerlink" title="ğŸ§  å°ç»“ï¼šä¸¤æ®µçš„å…³ç³»å›¾"></a>ğŸ§  å°ç»“ï¼šä¸¤æ®µçš„å…³ç³»å›¾</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">submit(f, args...)</span><br><span class="line"></span><br><span class="line">  åˆ›å»º lambda1: [func, captured...]() -&gt; return_type &#123; return invoke(func, args...); &#125;</span><br><span class="line">       â†“</span><br><span class="line">  ç”¨ lambda1 åˆå§‹åŒ– packaged_task&lt;return_type()&gt;ï¼ˆæ— å‚ï¼Œå› ä¸ºå‚æ•°éƒ½æ•è·äº†ï¼‰</span><br><span class="line">       â†“</span><br><span class="line">  å¾—åˆ° shared_ptr&lt;packaged_task&lt;return_type()&gt;&gt;</span><br><span class="line">       â†“</span><br><span class="line">  åˆ›å»º lambda2: [task]()&#123; (*task)(); &#125;  â† æ•è· shared_ptrï¼ˆå¼•ç”¨è®¡æ•° +1ï¼‰</span><br><span class="line">       â†“</span><br><span class="line">  lambda2 è½¬æˆ std::function&lt;void()&gt; æ”¾å…¥ä»»åŠ¡é˜Ÿåˆ—</span><br><span class="line">       â†“</span><br><span class="line">  worker æ‰§è¡Œ job() â†’ è°ƒç”¨ (*task)() â†’ è°ƒç”¨ lambda1 â†’ æ‰§è¡Œ func(args...)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="âœ…-ä¸€å¥è¯æ€»ç»“"><a href="#âœ…-ä¸€å¥è¯æ€»ç»“" class="headerlink" title="âœ… ä¸€å¥è¯æ€»ç»“"></a>âœ… ä¸€å¥è¯æ€»ç»“</h2><table>
<thead>
<tr>
<th>æ¦‚å¿µ</th>
<th>å«ä¹‰</th>
</tr>
</thead>
<tbody><tr>
<td><code>packaged_task&lt;return_type()&gt;</code></td>
<td>æ— å‚æ•°ä»»åŠ¡ï¼Œä½†å†…éƒ¨ lambda æ•è·äº†æ‰€æœ‰å®å‚ï¼ˆæå‰ç»‘å®šï¼‰</td>
</tr>
<tr>
<td><code>lambda</code> æ•è·</td>
<td>æ›¿ä»£äº†å‡½æ•°ç­¾åå‚æ•°ï¼ŒæŠŠå‚æ•°â€œè®°ä½â€åœ¨é—­åŒ…é‡Œ</td>
</tr>
<tr>
<td><code>[task]()&#123; (*task)(); &#125;</code></td>
<td>ç”¨ shared_ptr æ‹·è´æŒæœ‰ä»»åŠ¡å¯¹è±¡ï¼Œä¿è¯ç”Ÿå‘½å‘¨æœŸ</td>
</tr>
<tr>
<td>å­˜å…¥é˜Ÿåˆ—</td>
<td>lambda è¢«å†åŒ…è£…æˆ <code>std::function&lt;void()&gt;</code>ï¼Œæ–¹ä¾¿ç»Ÿä¸€è°ƒåº¦</td>
</tr>
</tbody></table>
<p>è€Œå¯¹äºæœ‰è¿”å›å€¼ï¼Œæœ‰å‚æ•°çš„å‡½æ•°ï¼Œbindå’Œlambdaä¹‹å¤–ï¼Œæˆ‘ä»¬å°±è¦å†ç”¨packaged_taskå»åŒ…è£…ï¼Œæå‰å¾—åˆ°future(ç›¸å½“äºè¿”å›å€¼)ï¼Œè¿™æ ·ï¼Œæˆ‘ä»¬å°±å°†æœ‰è¿”å›å€¼æœ‰å‚æ•°çš„å‡½æ•°ï¼Œç±»å‹æŠ¹é™¤æˆä¸ºäº†function&lt;void()&gt;è¿™ä¸ªæ— å‚æ— è¿”å›å€¼çš„åŒ…è£…å™¨ï¼ˆå®é™…æ˜¯è½¬ç§»äº†å‚æ•°å’Œè¿”å›å€¼ï¼‰</p>
<p>åŒæ—¶è¿™é‡Œç”¨shared_ptræ‰§è¡Œå¼‚æ­¥ä»»åŠ¡çš„æ“ä½œï¼Œä»¥åŠç”¨lambdaæ‹·è´ï¼ˆå€¼æ•è·ï¼‰shared_pträ½¿å…¶å¼•ç”¨è®¡æ•°+1ï¼Œé˜²æ­¢æå‰é”€æ¯çš„ç­–ç•¥åœ¨åç¨‹åº“çš„fire-and-forgeté‡Œé¢ä¹Ÿæœ‰ä½“ç°ã€‚ï¼ˆæœ‰æ—¶é—´æŠŠåç¨‹åº“çš„ä¸œè¥¿ä¹Ÿå†™åœ¨åšå®¢ï¼‰</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="cmz">cmz</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://cmzcc.github.io/2025/11/08/%E3%80%8AC++-Concurrency-in-Action%E3%80%8B%E7%AC%AC%E5%9B%9B%E7%AB%A0/">https://cmzcc.github.io/2025/11/08/%E3%80%8AC++-Concurrency-in-Action%E3%80%8B%E7%AC%AC%E5%9B%9B%E7%AB%A0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/c/">c++</a><a class="post-meta__tags" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/">å¤šçº¿ç¨‹</a></div><div class="post-share"><div class="social-share" data-image="/img/text-cover3.jpg" data-sites="wechat,qq,weibo,qzone,facebook"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="prev-post pull-left" href="/2025/11/09/lambda%E5%86%8D%E6%8E%A2/" title="lambdaå†æ¢"><img class="cover" src="/img/text-cover2.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous</div><div class="prev_info">lambdaå†æ¢</div></div></a><a class="next-post pull-right" href="/2025/11/05/TSDB-TDengine/" title="TSDB-TDengine"><img class="cover" src="/img/text-cover3.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next</div><div class="next_info">TSDB-TDengine</div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a href="/2025/02/27/c++%E4%B8%AD%E7%9A%84%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%86%99%E6%97%B6%E5%A4%8D%E5%88%B6/" title="c++ä¸­çš„å¤šçº¿ç¨‹å†™æ—¶å¤åˆ¶"><img class="cover" src="/img/text-cover2.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-02-27</div><div class="title">c++ä¸­çš„å¤šçº¿ç¨‹å†™æ—¶å¤åˆ¶</div></div></a><a href="/2025/10/29/%E3%80%8AC++-Concurrency-in-Action%E3%80%8B%E7%AC%AC%E4%B8%89%E7%AB%A0/" title="ã€ŠC++ Concurrency in Actionã€‹ç¬¬ä¸‰ç« "><img class="cover" src="/img/text-cover3.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-10-29</div><div class="title">ã€ŠC++ Concurrency in Actionã€‹ç¬¬ä¸‰ç« </div></div></a><a href="/2025/10/29/%E3%80%8AC++-Concurrency-in-Action%E3%80%8B%E7%AC%AC%E4%BA%8C%E7%AB%A0/" title="ã€ŠC++ Concurrency in Actionã€‹ç¬¬äºŒç« "><img class="cover" src="/img/text-cover2.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-10-29</div><div class="title">ã€ŠC++ Concurrency in Actionã€‹ç¬¬äºŒç« </div></div></a><a href="/2025/01/12/Lambda%E8%A1%A8%E8%BE%BE%E5%BC%8F/" title="Lambdaè¡¨è¾¾å¼"><img class="cover" src="/img/text-cover1.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-01-12</div><div class="title">Lambdaè¡¨è¾¾å¼</div></div></a><a href="/2025/06/30/atomic/" title="atomic"><img class="cover" src="/img/text-cover2.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-06-30</div><div class="title">atomic</div></div></a><a href="/2025/01/27/bind%E5%92%8C%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0%E7%9A%84%E5%85%B3%E7%B3%BB/" title="bindå’Œå›è°ƒå‡½æ•°çš„å…³ç³»"><img class="cover" src="/img/text-cover2.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-01-27</div><div class="title">bindå’Œå›è°ƒå‡½æ•°çš„å…³ç³»</div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comments</span></div></div><div class="comment-wrap"><div><div id="waline-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info is-center"><div class="avatar-img"><img src="/img/personal-icon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">cmz</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">109</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">112</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">8</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/cmzcc"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/cmzcc" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:2721530241@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">åŠªåŠ›æˆä¸ºc++é«˜æ‰‹ingï¼Œä¸“ç²¾å¤šçº¿ç¨‹ç¼–ç¨‹å’Œæ€§èƒ½ä¼˜åŒ–æ–¹å‘ï¼Œå›½å†…ç§å‹Ÿé‡åŒ–å¼€å‘å®ä¹ ç”Ÿï¼ˆQD)ç‰›é©¬</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E5%87%BA%E7%8E%B0%E4%BC%AA%E5%94%A4%E9%86%92%EF%BC%9F"><span class="toc-number">1.</span> <span class="toc-text">ä¸ºä»€ä¹ˆä¼šå‡ºç°ä¼ªå”¤é†’ï¼Ÿ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%A6%E6%9D%A5%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">2.</span> <span class="toc-text">å¸¦æ¥çš„é—®é¢˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E9%81%BF%E5%85%8D%E4%BC%AA%E5%94%A4%E9%86%92%EF%BC%9F%E2%80%94%E2%80%94-%E6%AD%A3%E7%A1%AE%E7%9A%84%E4%BD%BF%E7%94%A8%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.</span> <span class="toc-text">å¦‚ä½•é¿å…ä¼ªå”¤é†’ï¼Ÿâ€”â€” æ­£ç¡®çš„ä½¿ç”¨æ¨¡å¼</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%94%99%E8%AF%AF%E7%A4%BA%E4%BE%8B%EF%BC%88%E4%BD%BF%E7%94%A8-if%EF%BC%8C%E6%98%93%E5%8F%97%E4%BC%AA%E5%94%A4%E9%86%92%E5%BD%B1%E5%93%8D%EF%BC%89"><span class="toc-number">3.1.</span> <span class="toc-text">é”™è¯¯ç¤ºä¾‹ï¼ˆä½¿ç”¨ ifï¼Œæ˜“å—ä¼ªå”¤é†’å½±å“ï¼‰</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A3%E7%A1%AE%E7%A4%BA%E4%BE%8B%EF%BC%88%E4%BD%BF%E7%94%A8-while%EF%BC%8C%E9%98%B2%E6%AD%A2%E4%BC%AA%E5%94%A4%E9%86%92%EF%BC%89"><span class="toc-number">3.2.</span> <span class="toc-text">æ­£ç¡®ç¤ºä¾‹ï¼ˆä½¿ç”¨ whileï¼Œé˜²æ­¢ä¼ªå”¤é†’ï¼‰</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#C-%E7%9A%84%E8%BF%9B%E4%B8%80%E6%AD%A5%E7%AE%80%E5%8C%96%EF%BC%9A%E5%B8%A6%E8%B0%93%E8%AF%8D%E7%9A%84-wait"><span class="toc-number">4.</span> <span class="toc-text">C++ çš„è¿›ä¸€æ­¥ç®€åŒ–ï¼šå¸¦è°“è¯çš„ wait</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">5.</span> <span class="toc-text">æ€»ç»“</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%A7%A9-%E4%B8%80%E3%80%81std-future-%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number"></span> <span class="toc-text">ğŸ§© ä¸€ã€std::future æ˜¯ä»€ä¹ˆï¼Ÿ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%8C%B1-%E5%AE%9A%E4%B9%89"><span class="toc-number">1.</span> <span class="toc-text">ğŸŒ± å®šä¹‰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%A7%A0-%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">2.</span> <span class="toc-text">ğŸ§  ä½¿ç”¨åœºæ™¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%9C%85-%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95%E7%A4%BA%E4%BE%8B"><span class="toc-number">3.</span> <span class="toc-text">âœ… åŸºæœ¬ç”¨æ³•ç¤ºä¾‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%9A%A0%EF%B8%8F-%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-number">4.</span> <span class="toc-text">âš ï¸ æ³¨æ„äº‹é¡¹</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%8C%BF-%E4%BA%8C%E3%80%81std-shared-future-%E2%80%94%E2%80%94-%E5%8F%AF%E5%85%B1%E4%BA%AB%E7%9A%84-future"><span class="toc-number"></span> <span class="toc-text">ğŸŒ¿ äºŒã€std::shared_future â€”â€” å¯å…±äº«çš„ future</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%9C%85-%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95"><span class="toc-number">1.</span> <span class="toc-text">âœ… åŸºæœ¬ç”¨æ³•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%9A%99%EF%B8%8F-%E5%8C%BA%E5%88%AB%E6%80%BB%E7%BB%93"><span class="toc-number">2.</span> <span class="toc-text">âš™ï¸ åŒºåˆ«æ€»ç»“</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%9A%80-%E4%B8%89%E3%80%81std-async-%E2%80%94%E2%80%94-%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1%E5%90%AF%E5%8A%A8%E5%99%A8"><span class="toc-number"></span> <span class="toc-text">ğŸš€ ä¸‰ã€std::async â€”â€” å¼‚æ­¥ä»»åŠ¡å¯åŠ¨å™¨</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%9C%85-%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95"><span class="toc-number">1.</span> <span class="toc-text">âœ… åŸºæœ¬è¯­æ³•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%94%A7-%E5%90%AF%E5%8A%A8%E7%AD%96%E7%95%A5%EF%BC%88policy%EF%BC%89"><span class="toc-number">2.</span> <span class="toc-text">ğŸ”§ å¯åŠ¨ç­–ç•¥ï¼ˆpolicyï¼‰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%8C%8A-%E7%A4%BA%E4%BE%8B-1%EF%BC%9A%E7%BB%93%E5%90%88-shared-future"><span class="toc-number">3.</span> <span class="toc-text">ğŸŒŠ ç¤ºä¾‹ 1ï¼šç»“åˆ shared_future</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%A7%A0-%E5%9B%9B%E3%80%81%E5%85%B6%E5%AE%83%E5%AE%9E%E7%94%A8%E6%93%8D%E4%BD%9C"><span class="toc-number"></span> <span class="toc-text">ğŸ§  å››ã€å…¶å®ƒå®ç”¨æ“ä½œ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#future-wait"><span class="toc-number">1.</span> <span class="toc-text">future.wait()</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%9A%A0%EF%B8%8F-%E4%BA%94%E3%80%81%E5%B8%B8%E8%A7%81%E5%9D%91%E7%82%B9"><span class="toc-number"></span> <span class="toc-text">âš ï¸ äº”ã€å¸¸è§å‘ç‚¹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%A7%AD-%E5%85%AD%E3%80%81%E6%80%BB%E7%BB%93%E5%AF%B9%E6%AF%94%E8%A1%A8"><span class="toc-number"></span> <span class="toc-text">ğŸ§­ å…­ã€æ€»ç»“å¯¹æ¯”è¡¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E8%80%85%E7%9A%84%E5%85%B3%E7%B3%BB%E5%92%8C%E5%8C%BA%E5%88%AB"><span class="toc-number"></span> <span class="toc-text">ä¸‰è€…çš„å…³ç³»å’ŒåŒºåˆ«</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B1%82%E6%AC%A1%E5%85%B3%E7%B3%BB"><span class="toc-number">1.</span> <span class="toc-text">å±‚æ¬¡å…³ç³»</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%A6%E7%BB%86%E5%AF%B9%E6%AF%94"><span class="toc-number">2.</span> <span class="toc-text">è¯¦ç»†å¯¹æ¯”</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#std-promise%EF%BC%9A%E4%BD%A0%E6%89%8B%E5%8A%A8%E6%8F%90%E4%BE%9B%E7%BB%93%E6%9E%9C"><span class="toc-number"></span> <span class="toc-text">std::promiseï¼šä½ æ‰‹åŠ¨æä¾›ç»“æœ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#std-packaged-task%EF%BC%9A%E4%BB%BB%E5%8A%A1%E8%87%AA%E5%8A%A8%E4%BA%A7%E7%94%9F%E7%BB%93%E6%9E%9C"><span class="toc-number"></span> <span class="toc-text">std::packaged_taskï¼šä»»åŠ¡è‡ªåŠ¨äº§ç”Ÿç»“æœ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%A7%A9-%E9%97%AE%E9%A2%98-1%EF%BC%9A"><span class="toc-number"></span> <span class="toc-text">ğŸ§© é—®é¢˜ 1ï¼š</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%A7%A0-1%EF%B8%8F%E2%83%A3-std-packaged-task-%E7%9A%84%E7%AD%BE%E5%90%8D"><span class="toc-number">1.</span> <span class="toc-text">ğŸ§  1ï¸âƒ£ std::packaged_task çš„ç­¾å</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%A7%A9-2%EF%B8%8F%E2%83%A3-%E4%B8%BA%E4%BB%80%E4%B9%88%E5%9C%A8%E4%BD%A0%E7%9A%84%E4%BB%A3%E7%A0%81%E4%B8%AD%E5%86%99%E6%88%90%E4%BA%86-std-packaged-task"><span class="toc-number">2.</span> <span class="toc-text">ğŸ§© 2ï¸âƒ£ ä¸ºä»€ä¹ˆåœ¨ä½ çš„ä»£ç ä¸­å†™æˆäº† std::packaged_task&lt;return_type()&gt;</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%9C%85-%E7%BB%93%E8%AE%BA%EF%BC%9A"><span class="toc-number">3.</span> <span class="toc-text">âœ… ç»“è®ºï¼š</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%A7%A9-%E9%97%AE%E9%A2%98-2%EF%BC%9A"><span class="toc-number"></span> <span class="toc-text">ğŸ§© é—®é¢˜ 2ï¼š</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%A7%A0-1%EF%B8%8F%E2%83%A3-%E6%8D%95%E8%8E%B7%E8%A1%8C%E4%B8%BA"><span class="toc-number">1.</span> <span class="toc-text">ğŸ§  1ï¸âƒ£ æ•è·è¡Œä¸º</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%A7%B1-2%EF%B8%8F%E2%83%A3-lambda-%E8%A2%AB%E5%AD%98%E8%BF%9B-std-function"><span class="toc-number">2.</span> <span class="toc-text">ğŸ§± 2ï¸âƒ£ lambda è¢«å­˜è¿› std::function&lt;void()&gt;</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%9A%99%EF%B8%8F-3%EF%B8%8F%E2%83%A3-%E8%B0%83%E7%94%A8%E9%93%BE"><span class="toc-number">3.</span> <span class="toc-text">âš™ï¸ 3ï¸âƒ£ è°ƒç”¨é“¾</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%A7%A0-%E5%B0%8F%E7%BB%93%EF%BC%9A%E4%B8%A4%E6%AE%B5%E7%9A%84%E5%85%B3%E7%B3%BB%E5%9B%BE"><span class="toc-number"></span> <span class="toc-text">ğŸ§  å°ç»“ï¼šä¸¤æ®µçš„å…³ç³»å›¾</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%9C%85-%E4%B8%80%E5%8F%A5%E8%AF%9D%E6%80%BB%E7%BB%93"><span class="toc-number"></span> <span class="toc-text">âœ… ä¸€å¥è¯æ€»ç»“</span></a></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/11/09/lambda%E5%86%8D%E6%8E%A2/" title="lambdaå†æ¢"><img src="/img/text-cover2.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="lambdaå†æ¢"/></a><div class="content"><a class="title" href="/2025/11/09/lambda%E5%86%8D%E6%8E%A2/" title="lambdaå†æ¢">lambdaå†æ¢</a><time datetime="2025-11-09T03:43:06.000Z" title="Created 2025-11-09 11:43:06">2025-11-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/11/08/%E3%80%8AC++-Concurrency-in-Action%E3%80%8B%E7%AC%AC%E5%9B%9B%E7%AB%A0/" title="ã€ŠC++-Concurrency-in-Actionã€‹ç¬¬å››ç« "><img src="/img/text-cover3.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ã€ŠC++-Concurrency-in-Actionã€‹ç¬¬å››ç« "/></a><div class="content"><a class="title" href="/2025/11/08/%E3%80%8AC++-Concurrency-in-Action%E3%80%8B%E7%AC%AC%E5%9B%9B%E7%AB%A0/" title="ã€ŠC++-Concurrency-in-Actionã€‹ç¬¬å››ç« ">ã€ŠC++-Concurrency-in-Actionã€‹ç¬¬å››ç« </a><time datetime="2025-11-08T14:04:05.000Z" title="Created 2025-11-08 22:04:05">2025-11-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/11/05/TSDB-TDengine/" title="TSDB-TDengine"><img src="/img/text-cover3.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="TSDB-TDengine"/></a><div class="content"><a class="title" href="/2025/11/05/TSDB-TDengine/" title="TSDB-TDengine">TSDB-TDengine</a><time datetime="2025-11-05T08:39:16.000Z" title="Created 2025-11-05 16:39:16">2025-11-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/10/29/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%B8%AD%E7%9A%84%E6%84%8F%E5%A4%96%E5%8F%91%E7%8E%B0/" title="çº¿ç¨‹æ± ä¸­çš„æ„å¤–å‘ç°"><img src="/img/text-cover1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="çº¿ç¨‹æ± ä¸­çš„æ„å¤–å‘ç°"/></a><div class="content"><a class="title" href="/2025/10/29/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%B8%AD%E7%9A%84%E6%84%8F%E5%A4%96%E5%8F%91%E7%8E%B0/" title="çº¿ç¨‹æ± ä¸­çš„æ„å¤–å‘ç°">çº¿ç¨‹æ± ä¸­çš„æ„å¤–å‘ç°</a><time datetime="2025-10-29T13:28:03.000Z" title="Created 2025-10-29 21:28:03">2025-10-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/10/29/%E3%80%8AC++-Concurrency-in-Action%E3%80%8B%E7%AC%AC%E4%B8%89%E7%AB%A0/" title="ã€ŠC++ Concurrency in Actionã€‹ç¬¬ä¸‰ç« "><img src="/img/text-cover3.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ã€ŠC++ Concurrency in Actionã€‹ç¬¬ä¸‰ç« "/></a><div class="content"><a class="title" href="/2025/10/29/%E3%80%8AC++-Concurrency-in-Action%E3%80%8B%E7%AC%AC%E4%B8%89%E7%AB%A0/" title="ã€ŠC++ Concurrency in Actionã€‹ç¬¬ä¸‰ç« ">ã€ŠC++ Concurrency in Actionã€‹ç¬¬ä¸‰ç« </a><time datetime="2025-10-29T13:27:33.000Z" title="Created 2025-10-29 21:27:33">2025-10-29</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/img/foot.jpg);"><div id="footer-wrap"><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://cmzcc.github.io/">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="Scroll to Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>(() => {
  let initFn = window.walineFn || null

  const initWaline = (Fn) => {
    const waline = Fn(Object.assign({
      el: '#waline-wrap',
      serverURL: 'https://cc-blog-blond.vercel.app/',
      pageview: false,
      dark: 'html[data-theme="dark"]',
      path: window.location.pathname,
      comment: false,
    }, null))

    const destroyWaline = () => {
      waline.destroy()
    }

    btf.addGlobalFn('pjaxSendOnce', destroyWaline, 'destroyWaline')
  }

  const loadWaline = () => {
    if (initFn) initWaline(initFn)
    else {
      btf.getCSS('https://cdn.jsdelivr.net/npm/@waline/client/dist/waline.min.css')
        .then(() => import('https://cdn.jsdelivr.net/npm/@waline/client/dist/waline.min.js'))
        .then(({ init }) => {
          initFn = init || Waline.init
          initWaline(initFn)
          window.walineFn = initFn
        })
    }
  }

  if ('Waline' === 'Waline' || !false) {
    if (false) btf.loadComment(document.getElementById('waline-wrap'),loadWaline)
    else setTimeout(loadWaline, 0)
  } else {
    window.loadOtherComment = loadWaline
  }
})()</script></div><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="false"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>